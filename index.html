<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonymous Board</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #fff;
            min-height: 100vh;
        }
        
        /* Splash Screen */
        #splash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeOut 3s forwards;
            animation-delay: 3s;
        }

        #splash img {
            width: 300px;
            height: auto;
            animation: glitch 0.3s infinite;
        }

        #splash h1 {
            margin-top: 30px;
            font-size: 2.5em;
            letter-spacing: 5px;
            animation: flicker 1.5s infinite;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }

        @keyframes glitch {
            0%, 100% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
        }

        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        #root {
            opacity: 0;
            animation: fadeIn 1s forwards;
            animation-delay: 6s;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
        }
        
        .btn {
            background: #222;
            color: #fff;
            border: 1px solid #444;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            font-family: 'Courier New', monospace;
        }
        
        .btn:hover {
            background: #333;
            border-color: #666;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #000;
            border-color: #333;
        }
        
        .btn-danger {
            background: #400;
            border-color: #600;
        }
        
        .btn-danger:hover {
            background: #600;
            border-color: #800;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #333;
            border-radius: 4px;
            font-size: 1rem;
            margin-top: 8px;
            font-family: 'Courier New', monospace;
            background: #000;
            color: #fff;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #555;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .header {
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .header h1 {
            text-align: center;
            font-size: 2em;
            letter-spacing: 3px;
            margin-bottom: 5px;
            text-shadow: 0 0 10px #fff;
        }
        
        .header p {
            text-align: center;
            color: #888;
            font-size: 0.9em;
            margin-bottom: 15px;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .header-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        
        @media (max-width: 600px) {
            .header-buttons {
                grid-template-columns: 1fr;
            }
        }
        
        .post {
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .post:hover {
            border-color: #555;
            box-shadow: 0 0 10px rgba(255,255,255,0.1);
        }
        
        .post-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #fff;
        }
        
        .post-meta {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .post-content {
            color: #aaa;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .comment {
            background: #0a0a0a;
            border-left: 2px solid #333;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-content {
            background: #111;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 24px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content h2 {
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        
        .info-box {
            background: #001a33;
            border-left: 4px solid #0066cc;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .warning-box {
            background: #2a1a00;
            border-left: 4px solid #ff8800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .revealed-tag {
            display: inline-block;
            background: #600;
            color: #f88;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-left: 10px;
        }
        
        .known-identity {
            background: #004400;
            color: #8f8;
            padding: 8px 16px;
            border-radius: 4px;
            margin: 10px 5px 10px 0;
            display: inline-block;
        }
        
        .login-container {
            max-width: 500px;
            margin: 100px auto;
            padding: 20px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .login-header h1 {
            font-size: 2em;
            letter-spacing: 3px;
            margin-bottom: 10px;
        }
        
        .login-card {
            background: #111;
            border: 2px solid #333;
            padding: 30px;
            border-radius: 8px;
        }
        
        .login-card h2 {
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        
        .login-card label {
            display: block;
            color: #888;
            margin: 15px 0 5px;
        }
        
        label {
            display: block;
            color: #888;
            margin: 15px 0 5px;
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div id="splash">
        <img src="/mnt/user-data/uploads/1770935396330_image.png" alt="Anonymous">
        <h1>WE ARE ANONYMOUS</h1>
    </div>
    
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyAwW-4r34LivVZAB3Z4PtB_5BFeLFfS1s",
            authDomain: "ikmyeonggay.firebaseapp.com",
            databaseURL: "https://ikmyeonggay-default-rtdb.firebaseio.com",
            projectId: "ikmyeonggay",
            storageBucket: "ikmyeonggay.firebasestorage.app",
            messagingSenderId: "761175876587",
            appId: "1:761175876587:web:48b062812fc20d75b36fae",
            measurementId: "G-HDJB6TCZ2C"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Firebase ì—°ê²° ìƒíƒœ í™•ì¸
        db.ref('.info/connected').on('value', (snap) => {
            if (snap.val() === true) {
                console.log('âœ… Firebase ì—°ê²°ë¨');
            } else {
                console.log('âŒ Firebase ì—°ê²° ì•ˆ ë¨');
            }
        });

        // 8ëª…ì˜ ê³„ì •
        const ACCOUNTS = {
            'user1': { name: 'ê°•ì‹ ìš°', password: btoa('Anon!2024#Kang') },
            'user2': { name: 'ê¹€ëŒ€ì›…', password: btoa('Shad0w@Kim!24') },
            'user3': { name: 'ê¹€ë¯¼ê¸°', password: btoa('Dark#Mind2024!') },
            'user4': { name: 'ê¹€ë¯¼í˜¸', password: btoa('Gh0st$Minho@') },
            'user5': { name: 'ì†¡ë¯¼ìˆ˜', password: btoa('Echo!Song#2024') },
            'user6': { name: 'ì†ì„ì›…', password: btoa('Cipher@Son!24') },
            'user7': { name: 'ê¹€ëª…ì§„', password: btoa('Wraith#Kim2024') },
            'user8': { name: 'ê¹€ì¶©ì—°', password: btoa('Admin!@Ghost24') }
        };

        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [users, setUsers] = useState({});
            const [posts, setPosts] = useState([]);
            const [showWriteModal, setShowWriteModal] = useState(false);
            const [showPostModal, setShowPostModal] = useState(false);
            const [showGuessModal, setShowGuessModal] = useState(false);
            const [showNicknameModal, setShowNicknameModal] = useState(false);
            const [selectedPost, setSelectedPost] = useState(null);
            const [todayGuess, setTodayGuess] = useState(null);

            // ë¡œê·¸ì¸ ì²´í¬
            useEffect(() => {
                const userId = localStorage.getItem('userId');
                if (userId && ACCOUNTS[userId]) {
                    setCurrentUser({ userId, ...ACCOUNTS[userId] });
                    loadUserData(userId);
                }
            }, []);

            // ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ
            const loadUserData = (userId) => {
                db.ref('users').on('value', snap => {
                    const data = snap.val() || {};
                    setUsers(data);
                });

                // ì˜¤ëŠ˜ì˜ ì§€ëª© í™•ì¸
                const today = new Date().toISOString().split('T')[0];
                db.ref(`guesses/${today}/${userId}`).once('value', snap => {
                    setTodayGuess(snap.val());
                });
            };

            // ê²Œì‹œê¸€ ë¡œë“œ
            useEffect(() => {
                db.ref('posts').on('value', snap => {
                    const data = snap.val();
                    if (data) {
                        const arr = Object.keys(data).map(k => ({
                            id: k,
                            ...data[k]
                        })).sort((a, b) => b.timestamp - a.timestamp);
                        setPosts(arr);
                    } else {
                        setPosts([]);
                    }
                });
            }, []);

            // ë‹‰ë„¤ì„ ë¯¸ì„¤ì • ì‹œ ìë™ ëª¨ë‹¬
            useEffect(() => {
                if (currentUser && users[currentUser.userId]) {
                    if (!users[currentUser.userId].nickname) {
                        setShowNicknameModal(true);
                    }
                }
            }, [currentUser, users]);

            // ë¡œê·¸ì¸
            const login = (userId, password) => {
                if (!ACCOUNTS[userId]) {
                    alert('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê³„ì •ì…ë‹ˆë‹¤!');
                    return;
                }
                if (ACCOUNTS[userId].password !== btoa(password)) {
                    alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤!');
                    return;
                }

                localStorage.setItem('userId', userId);
                setCurrentUser({ userId, ...ACCOUNTS[userId] });
                loadUserData(userId);

                // ì‚¬ìš©ì ì´ˆê¸°í™” (ì—†ìœ¼ë©´ ìƒì„±)
                db.ref(`users/${userId}`).once('value').then(snap => {
                    if (!snap.val()) {
                        console.log('ìƒˆ ì‚¬ìš©ì ìƒì„±:', userId);
                        return db.ref(`users/${userId}`).set({
                            name: ACCOUNTS[userId].name,
                            nickname: '',
                            nicknameChangedAt: 0,
                            revealedTo: [],
                            isPubliclyRevealed: false
                        }).then(() => {
                            setShowNicknameModal(true);
                        });
                    } else {
                        console.log('ê¸°ì¡´ ì‚¬ìš©ì ë¡œë“œ:', userId);
                        if (!snap.val().nickname || snap.val().nickname === '') {
                            setShowNicknameModal(true);
                        }
                    }
                }).catch(error => {
                    console.error('ì‚¬ìš©ì ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    alert('Firebase ì—°ê²° ì‹¤íŒ¨!\n\n' + error.message + '\n\nFirebase ê·œì¹™ì„ í™•ì¸í•´ì£¼ì„¸ìš”!');
                });
            };

            // ë¡œê·¸ì•„ì›ƒ
            const logout = () => {
                localStorage.removeItem('userId');
                setCurrentUser(null);
            };

            // ë‹‰ë„¤ì„ ë³€ê²½ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
            const canChangeNickname = () => {
                if (!currentUser || !users[currentUser.userId]) return false;
                const lastChanged = users[currentUser.userId].nicknameChangedAt || 0;
                const now = Date.now();
                const koreaTime = new Date(now + (9 * 60 * 60 * 1000));
                const todayMidnight = new Date(koreaTime.getFullYear(), koreaTime.getMonth(), koreaTime.getDate()).getTime() - (9 * 60 * 60 * 1000);
                return lastChanged < todayMidnight;
            };

            // ë‹‰ë„¤ì„ ë³€ê²½
            const changeNickname = (newNickname) => {
                if (!newNickname.trim()) {
                    alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”!');
                    return;
                }
                db.ref(`users/${currentUser.userId}`).update({
                    nickname: newNickname.trim(),
                    nicknameChangedAt: Date.now()
                });
                setShowNicknameModal(false);
                alert('ë‹‰ë„¤ì„ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
            };

            // ì§€ëª©í•˜ê¸°
            const makeGuess = (targetUserId) => {
                if (targetUserId === currentUser.userId) {
                    alert('ìê¸° ìì‹ ì€ ì§€ëª©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                    return;
                }

                const today = new Date().toISOString().split('T')[0];
                const targetName = ACCOUNTS[targetUserId].name;
                const selectedUser = document.getElementById('guessSelect').value;

                if (!selectedUser) {
                    alert('ì¶”ì¸¡í•  ì‚¬ëŒì„ ì„ íƒí•˜ì„¸ìš”!');
                    return;
                }

                const correct = selectedUser === targetUserId;

                // ì§€ëª© ê¸°ë¡
                db.ref(`guesses/${today}/${currentUser.userId}`).set({
                    targetId: targetUserId,
                    guessedId: selectedUser,
                    correct: correct,
                    timestamp: Date.now()
                });

                if (correct) {
                    // ë§ì¶¤: íƒ€ê²Ÿì˜ ì •ì²´ë¥¼ ë‚˜ì—ê²Œë§Œ ê³µê°œ
                    db.ref(`users/${targetUserId}/revealedTo`).once('value', snap => {
                        const revealedTo = snap.val() || [];
                        if (!revealedTo.includes(currentUser.userId)) {
                            revealedTo.push(currentUser.userId);
                            db.ref(`users/${targetUserId}/revealedTo`).set(revealedTo);
                        }
                    });
                    alert(`ì •ë‹µì…ë‹ˆë‹¤! ${ACCOUNTS[targetUserId].name}ë‹˜ì˜ ì •ì²´ë¥¼ ì•Œê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                } else {
                    // í‹€ë¦¼: ë‚´ ì •ì²´ë¥¼ ì „ì²´ ê³µê°œ
                    db.ref(`users/${currentUser.userId}`).update({
                        isPubliclyRevealed: true
                    });
                    alert('í‹€ë ¸ìŠµë‹ˆë‹¤! ë‹¹ì‹ ì˜ ì •ì²´ê°€ ëª¨ë‘ì—ê²Œ ê³µê°œë©ë‹ˆë‹¤!');
                }

                setTodayGuess({ targetId: targetUserId, guessedId: selectedUser, correct });
                setShowGuessModal(false);
            };

            // ê²Œì‹œê¸€ ì‘ì„±
            const writePost = (title, content) => {
                if (!title.trim() || !content.trim()) {
                    alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”!');
                    return;
                }

                const currentNickname = users[currentUser.userId]?.nickname || '';
                if (!currentNickname) {
                    alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”!');
                    setShowWriteModal(false);
                    setShowNicknameModal(true);
                    return;
                }

                const postId = Date.now().toString();

                db.ref(`posts/${postId}`).set({
                    authorId: currentUser.userId,
                    nickname: currentNickname,
                    title: title.trim(),
                    content: content.trim(),
                    timestamp: Date.now()
                }).then(() => {
                    setShowWriteModal(false);
                    alert('ê²Œì‹œê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }).catch((error) => {
                    alert('ê²Œì‹œê¸€ ì‘ì„± ì‹¤íŒ¨: ' + error.message);
                });
            };

            // ëŒ“ê¸€ ì‘ì„±
            const writeComment = (postId, content) => {
                if (!content.trim()) {
                    alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”!');
                    return;
                }

                const currentNickname = users[currentUser.userId]?.nickname || '';
                if (!currentNickname) {
                    alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”!');
                    setShowPostModal(false);
                    setShowNicknameModal(true);
                    return;
                }

                const commentId = Date.now().toString();

                db.ref(`posts/${postId}/comments/${commentId}`).set({
                    authorId: currentUser.userId,
                    nickname: currentNickname,
                    content: content.trim(),
                    timestamp: Date.now()
                }).then(() => {
                    console.log('ëŒ“ê¸€ ì‘ì„± ì„±ê³µ!');
                }).catch((error) => {
                    alert('ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨: ' + error.message);
                });
            };

            // ì´ˆê¸°í™” (ê¹€ì¶©ì—°ë§Œ)
            const resetAllData = () => {
                if (currentUser.userId !== 'user8') {
                    alert('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤!');
                    return;
                }
                if (!confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                if (!confirm('ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) return;
                
                db.ref('posts').remove();
                db.ref('users').remove();
                db.ref('guesses').remove();
                alert('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                logout();
            };

            // ë‚´ê°€ ì•Œê³  ìˆëŠ” ì •ì²´ë“¤
            const getKnownIdentities = () => {
                if (!currentUser) return [];
                const known = [];
                Object.keys(users).forEach(uid => {
                    const user = users[uid];
                    if (user.isPubliclyRevealed) {
                        known.push({ userId: uid, name: ACCOUNTS[uid].name, type: 'public' });
                    } else if (user.revealedTo && user.revealedTo.includes(currentUser.userId)) {
                        known.push({ userId: uid, name: ACCOUNTS[uid].name, type: 'private' });
                    }
                });
                return known;
            };

            if (!currentUser) {
                return <LoginScreen onLogin={login} />;
            }

            const myNickname = users[currentUser.userId]?.nickname || '';
            const knownIdentities = getKnownIdentities();

            return (
                <div className="container">
                    <div className="header">
                        <h1>ANONYMOUS BOARD</h1>
                        <p>We do not forgive. We do not forget. Expect us.</p>
                        <div className="header-top">
                            <span style={{color: users[currentUser.userId]?.isPubliclyRevealed ? '#f88' : '#8f8'}}>
                                {users[currentUser.userId]?.isPubliclyRevealed 
                                    ? `âš  ë‹¹ì‹ ì˜ ì •ì²´ëŠ” ê³µê°œë˜ì—ˆìŠµë‹ˆë‹¤ (ì‹¤ëª…: ${currentUser.name})`
                                    : `âœ“ ë‹¹ì‹ ì˜ ì •ì²´ëŠ” ì•ˆì „í•©ë‹ˆë‹¤ (ì‹¤ëª…: ${currentUser.name})`
                                }
                            </span>
                        </div>
                        <div className="header-buttons">
                            <button className="btn" onClick={() => setShowNicknameModal(true)}>
                                ë‹‰ë„¤ì„ ë³€ê²½
                            </button>
                            <button 
                                className="btn" 
                                onClick={() => setShowGuessModal(true)}
                                disabled={todayGuess !== null}
                            >
                                {todayGuess ? 'ì§€ëª©ì™„ë£Œ' : 'ì§€ëª©í•˜ê¸°'}
                            </button>
                            <button className="btn btn-secondary" onClick={logout}>
                                ë¡œê·¸ì•„ì›ƒ
                            </button>
                        </div>
                        {currentUser.userId === 'user8' && (
                            <button 
                                className="btn btn-danger" 
                                onClick={resetAllData}
                                style={{marginTop: '10px'}}
                            >
                                ğŸ—‘ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™” (ê´€ë¦¬ì ì „ìš©)
                            </button>
                        )}
                    </div>

                    {knownIdentities.length > 0 && (
                        <div className="card">
                            <h3 style={{marginBottom: '15px'}}>ğŸ” ë‚´ê°€ ì•Œê³  ìˆëŠ” ì •ì²´ë“¤</h3>
                            {knownIdentities.map(k => (
                                <span key={k.userId} className="known-identity">
                                    {users[k.userId]?.nickname || '???'} = {k.name}
                                    {k.type === 'public' && ' (ì „ì²´ê³µê°œ)'}
                                </span>
                            ))}
                        </div>
                    )}

                    <button className="btn" onClick={() => setShowWriteModal(true)}>
                        ìƒˆ ê¸€ ì‘ì„±
                    </button>

                    <div>
                        {posts.map(post => {
                            const author = users[post.authorId];
                            const isRevealed = author?.isPubliclyRevealed || 
                                             (author?.revealedTo && author.revealedTo.includes(currentUser.userId));
                            const displayName = isRevealed 
                                ? `${post.nickname} (${ACCOUNTS[post.authorId]?.name})`
                                : post.nickname;

                            return (
                                <div 
                                    key={post.id} 
                                    className="post"
                                    onClick={() => {
                                        setSelectedPost(post);
                                        setShowPostModal(true);
                                    }}
                                >
                                    <div className="post-title">{post.title}</div>
                                    <div className="post-meta">
                                        ì‘ì„±ì: {displayName}
                                        {isRevealed && <span className="revealed-tag">ì •ì²´ê³µê°œ</span>}
                                        {' â€¢ '}
                                        {new Date(post.timestamp).toLocaleString('ko-KR')}
                                    </div>
                                    <div className="post-content">
                                        {post.content.length > 100 
                                            ? post.content.substring(0, 100) + '...'
                                            : post.content
                                        }
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {showWriteModal && (
                        <WriteModal 
                            onClose={() => setShowWriteModal(false)}
                            onSubmit={writePost}
                        />
                    )}

                    {showPostModal && selectedPost && (
                        <PostModal 
                            post={selectedPost}
                            users={users}
                            currentUser={currentUser}
                            ACCOUNTS={ACCOUNTS}
                            onClose={() => setShowPostModal(false)}
                            onComment={writeComment}
                        />
                    )}

                    {showGuessModal && (
                        <GuessModal 
                            users={users}
                            currentUser={currentUser}
                            ACCOUNTS={ACCOUNTS}
                            onClose={() => setShowGuessModal(false)}
                            onSubmit={makeGuess}
                        />
                    )}

                    {showNicknameModal && (
                        <NicknameModal 
                            currentNickname={myNickname}
                            canChange={canChangeNickname()}
                            onClose={() => myNickname ? setShowNicknameModal(false) : null}
                            onSubmit={changeNickname}
                        />
                    )}
                </div>
            );
        }

        function LoginScreen({ onLogin }) {
            const [userId, setUserId] = useState('');
            const [password, setPassword] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                onLogin(userId, password);
            };

            return (
                <div className="login-container">
                    <div className="login-header">
                        <h1>ANONYMOUS LOGIN</h1>
                    </div>
                    <div className="login-card">
                        <h2>ë¡œê·¸ì¸</h2>
                        <form onSubmit={handleSubmit}>
                            <label>ì•„ì´ë””</label>
                            <input 
                                type="text" 
                                value={userId}
                                onChange={(e) => setUserId(e.target.value)}
                                placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                            />
                            <label>ë¹„ë°€ë²ˆí˜¸</label>
                            <input 
                                type="password"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                            />
                            <button type="submit" className="btn" style={{marginTop: '15px'}}>
                                ë¡œê·¸ì¸
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        function WriteModal({ onClose, onSubmit }) {
            const [title, setTitle] = useState('');
            const [content, setContent] = useState('');

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>ìƒˆ ê¸€ ì‘ì„±</h2>
                        <label>ì œëª©</label>
                        <input 
                            type="text"
                            value={title}
                            onChange={(e) => setTitle(e.target.value)}
                            placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                        />
                        <label>ë‚´ìš©</label>
                        <textarea 
                            value={content}
                            onChange={(e) => setContent(e.target.value)}
                            placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"
                        />
                        <button 
                            className="btn" 
                            onClick={() => onSubmit(title, content)}
                            style={{marginTop: '15px'}}
                        >
                            ê²Œì‹œ
                        </button>
                        <button 
                            className="btn btn-secondary" 
                            onClick={onClose}
                        >
                            ì·¨ì†Œ
                        </button>
                    </div>
                </div>
            );
        }

        function PostModal({ post, users, currentUser, ACCOUNTS, onClose, onComment }) {
            const [commentContent, setCommentContent] = useState('');
            const comments = post.comments ? Object.values(post.comments).sort((a, b) => a.timestamp - b.timestamp) : [];

            const author = users[post.authorId];
            const isRevealed = author?.isPubliclyRevealed || 
                             (author?.revealedTo && author.revealedTo.includes(currentUser.userId));
            const displayName = isRevealed 
                ? `${post.nickname} (${ACCOUNTS[post.authorId]?.name})`
                : post.nickname;

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>{post.title}</h2>
                        <div className="post-meta" style={{marginBottom: '15px'}}>
                            ì‘ì„±ì: {displayName}
                            {isRevealed && <span className="revealed-tag">ì •ì²´ê³µê°œ</span>}
                            <br />
                            {new Date(post.timestamp).toLocaleString('ko-KR')}
                        </div>
                        <div className="post-content" style={{marginBottom: '20px'}}>
                            {post.content}
                        </div>

                        <h3 style={{marginTop: '20px', marginBottom: '10px'}}>
                            ëŒ“ê¸€ {comments.length}ê°œ
                        </h3>
                        {comments.map(comment => {
                            const cAuthor = users[comment.authorId];
                            const cIsRevealed = cAuthor?.isPubliclyRevealed || 
                                              (cAuthor?.revealedTo && cAuthor.revealedTo.includes(currentUser.userId));
                            const cDisplayName = cIsRevealed 
                                ? `${comment.nickname} (${ACCOUNTS[comment.authorId]?.name})`
                                : comment.nickname;

                            return (
                                <div key={comment.timestamp} className="comment">
                                    <div style={{fontSize: '0.9rem', color: '#666', marginBottom: '5px'}}>
                                        {cDisplayName}
                                        {cIsRevealed && <span className="revealed-tag">ì •ì²´ê³µê°œ</span>}
                                        {' â€¢ '}
                                        {new Date(comment.timestamp).toLocaleString('ko-KR')}
                                    </div>
                                    <div style={{color: '#aaa'}}>{comment.content}</div>
                                </div>
                            );
                        })}

                        <textarea 
                            value={commentContent}
                            onChange={(e) => setCommentContent(e.target.value)}
                            placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"
                            style={{marginTop: '15px'}}
                        />
                        <button 
                            className="btn" 
                            onClick={() => {
                                onComment(post.id, commentContent);
                                setCommentContent('');
                            }}
                            style={{marginTop: '10px'}}
                        >
                            ëŒ“ê¸€ ì‘ì„±
                        </button>
                        <button 
                            className="btn btn-secondary" 
                            onClick={onClose}
                        >
                            ë‹«ê¸°
                        </button>
                    </div>
                </div>
            );
        }

        function GuessModal({ users, currentUser, ACCOUNTS, onClose, onSubmit }) {
            const [targetUser, setTargetUser] = useState('');

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>ëˆ„êµ°ê°€ì˜ ì •ì²´ë¥¼ ì§€ëª©í•˜ê¸° ğŸ¯</h2>
                        
                        <div className="warning-box">
                            <h4>âš  ì£¼ì˜!</h4>
                            <ul style={{listStyle: 'none', padding: 0}}>
                                <li>â€¢ í•˜ë£¨ì— í•œ ë²ˆë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤</li>
                                <li>â€¢ ìƒëŒ€ë°©ì˜ ì •ì²´ë¥¼ ì•Œê²Œ ë©ë‹ˆë‹¤</li>
                                <li>â€¢ í‹€ë¦¬ë©´: ë‹¹ì‹ ì˜ ì •ì²´ê°€ ëª¨ë‘ì—ê²Œ ê³µê°œë©ë‹ˆë‹¤!</li>
                            </ul>
                        </div>

                        <label>ì§€ëª©í•  ì‚¬ëŒì˜ ë‹‰ë„¤ì„</label>
                        <select value={targetUser} onChange={(e) => setTargetUser(e.target.value)}>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            {Object.keys(users).filter(uid => uid !== currentUser.userId && users[uid].nickname).map(uid => (
                                <option key={uid} value={uid}>
                                    {users[uid].nickname}
                                </option>
                            ))}
                        </select>

                        <label>ì´ ì‚¬ëŒì˜ ì‹¤ì œ ì •ì²´ëŠ”?</label>
                        <select id="guessSelect">
                            <option value="">ì¶”ì¸¡í•˜ì„¸ìš”</option>
                            {Object.keys(ACCOUNTS).map(uid => (
                                <option key={uid} value={uid}>
                                    {ACCOUNTS[uid].name}
                                </option>
                            ))}
                        </select>

                        <button 
                            className="btn btn-danger" 
                            onClick={() => targetUser && onSubmit(targetUser)}
                            style={{marginTop: '15px'}}
                        >
                            ì§€ëª©í•˜ê¸°
                        </button>
                        <button 
                            className="btn btn-secondary" 
                            onClick={onClose}
                        >
                            ì·¨ì†Œ
                        </button>
                    </div>
                </div>
            );
        }

        function NicknameModal({ currentNickname, canChange, onClose, onSubmit }) {
            const [nickname, setNickname] = useState(currentNickname || '');

            return (
                <div className="modal" onClick={currentNickname ? onClose : null}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>ë‹‰ë„¤ì„ {currentNickname ? 'ë³€ê²½' : 'ì„¤ì •'}</h2>
                        
                        {!canChange && currentNickname && (
                            <div className="warning-box">
                                âš  ë‹‰ë„¤ì„ì€ í•˜ë£¨ì— í•œ ë²ˆë§Œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
                            </div>
                        )}

                        <label>ë‹‰ë„¤ì„</label>
                        <input 
                            type="text"
                            value={nickname}
                            onChange={(e) => setNickname(e.target.value)}
                            placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”"
                            disabled={!canChange && currentNickname}
                        />

                        <button 
                            className="btn" 
                            onClick={() => onSubmit(nickname)}
                            disabled={!canChange && currentNickname}
                            style={{marginTop: '15px'}}
                        >
                            {currentNickname ? 'ë³€ê²½' : 'ì„¤ì •'}
                        </button>
                        {currentNickname && (
                            <button 
                                className="btn btn-secondary" 
                                onClick={onClose}
                            >
                                ì·¨ì†Œ
                            </button>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
