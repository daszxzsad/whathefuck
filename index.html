<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonymous Board</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #fff;
            color: #000;
            min-height: 100vh;
        }
        
        /* Splash Screen */
        #splash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeOut 1s forwards;
            animation-delay: 1s;
        }

        #splash img {
            width: 300px;
            height: auto;
            animation: glitch 0.3s infinite;
        }

        #splash h1 {
            margin-top: 30px;
            font-size: 2.5em;
            letter-spacing: 5px;
            animation: flicker 1.5s infinite;
            color: #fff;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }

        @keyframes glitch {
            0%, 100% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
        }

        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        #root {
            opacity: 0;
            animation: fadeIn 1s forwards;
            animation-delay: 2s;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
        }
        
        .btn {
            background: #333;
            color: #fff;
            border: 1px solid #000;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            font-family: 'Courier New', monospace;
        }
        
        .btn:hover {
            background: #555;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #999;
            border-color: #777;
        }
        
        .btn-danger {
            background: #c00;
            border-color: #900;
        }
        
        .btn-danger:hover {
            background: #e00;
        }
        
        .btn-special {
            background: linear-gradient(135deg, #DAA520 0%, #FFD700 100%);
            color: #000;
            border-color: #B8860B;
            font-weight: bold;
        }
        
        .btn-special:hover {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
            margin-top: 8px;
            font-family: 'Courier New', monospace;
            background: #fff;
            color: #000;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #888;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .header {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .header h1 {
            text-align: center;
            font-size: 2em;
            letter-spacing: 3px;
            margin-bottom: 5px;
        }
        
        .header p {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .header-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .timer-container {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .timer-box {
            background: #fff;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        @media (max-width: 600px) {
            .header-buttons {
                grid-template-columns: 1fr;
            }
            
            .timer-container {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        
        .post {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .post:hover {
            border-color: #999;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .post-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #000;
        }
        
        .post-meta {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .post-content {
            color: #333;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .comment {
            background: #f0f0f0;
            border-left: 2px solid #999;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-content {
            background: #fff;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 24px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content h2 {
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .revealed-tag {
            display: inline-block;
            background: #f88;
            color: #fff;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-left: 10px;
        }
        
        .known-identity {
            background: #4caf50;
            color: #fff;
            padding: 8px 16px;
            border-radius: 4px;
            margin: 10px 5px 10px 0;
            display: inline-block;
        }
        
        .login-container {
            max-width: 500px;
            margin: 100px auto;
            padding: 20px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .login-header h1 {
            font-size: 2em;
            letter-spacing: 3px;
            margin-bottom: 10px;
        }
        
        .login-card {
            background: #f5f5f5;
            border: 2px solid #333;
            padding: 30px;
            border-radius: 8px;
        }
        
        .login-card h2 {
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        
        .login-card label {
            display: block;
            color: #666;
            margin: 15px 0 5px;
        }
        
        label {
            display: block;
            color: #666;
            margin: 15px 0 5px;
        }
        
        .nickname-history {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        
        .horus-eye {
            display: inline-block;
            margin-left: 5px;
            color: #DAA520;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div id="splash">
        <img src="/mnt/user-data/uploads/1770935396330_image.png" alt="Anonymous">
        <h1>WE ARE ANONYMOUS</h1>
    </div>
    
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Firebase ÏÑ§Ï†ï
        const firebaseConfig = {
            apiKey: "AIzaSyAwW-4r34LivVZAB3Z4PtB_5BFeLFfS1s",
            authDomain: "ikmyeonggay.firebaseapp.com",
            databaseURL: "https://ikmyeonggay-default-rtdb.firebaseio.com",
            projectId: "ikmyeonggay",
            storageBucket: "ikmyeonggay.firebasestorage.app",
            messagingSenderId: "761175876587",
            appId: "1:761175876587:web:48b062812fc20d75b36fae",
            measurementId: "G-HDJB6TCZ2C"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 8Î™ÖÏùò Í≥ÑÏ†ï
        const ACCOUNTS = {
            'user1': { name: 'Í∞ïÏã†Ïö∞', password: btoa('Anon!2024#Kang') },
            'user2': { name: 'ÍπÄÎåÄÏõÖ', password: btoa('Shad0w@Kim!24') },
            'user3': { name: 'ÍπÄÎØºÍ∏∞', password: btoa('Dark#Mind2024!') },
            'user4': { name: 'ÍπÄÎØºÌò∏', password: btoa('Gh0st$Minho@') },
            'user5': { name: 'ÏÜ°ÎØºÏàò', password: btoa('Echo!Song#2024') },
            'user6': { name: 'ÏÜêÏùÑÏõÖ', password: btoa('Cipher@Son!24') },
            'user7': { name: 'ÍπÄÎ™ÖÏßÑ', password: btoa('Wraith#Kim2024') },
            'user8': { name: 'ÍπÄÏ∂©Ïó∞', password: btoa('Admin!@Ghost24') }
        };

        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [users, setUsers] = useState({});
            const [posts, setPosts] = useState([]);
            const [showWriteModal, setShowWriteModal] = useState(false);
            const [showPostModal, setShowPostModal] = useState(false);
            const [showGuessModal, setShowGuessModal] = useState(false);
            const [showNicknameModal, setShowNicknameModal] = useState(false);
            const [showPasswordModal, setShowPasswordModal] = useState(false);
            const [showHorusModal, setShowHorusModal] = useState(false);
            const [selectedPost, setSelectedPost] = useState(null);
            const [todayGuess, setTodayGuess] = useState(null);
            const [currentTime, setCurrentTime] = useState(Date.now());

            // 1Ï¥àÎßàÎã§ ÌòÑÏû¨ ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
            useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentTime(Date.now());
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            // Î°úÍ∑∏Ïù∏ Ï≤¥ÌÅ¨
            useEffect(() => {
                const userId = localStorage.getItem('userId');
                if (userId && ACCOUNTS[userId]) {
                    setCurrentUser({ userId, ...ACCOUNTS[userId] });
                    loadUserData(userId);
                }
            }, []);

            // ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            const loadUserData = (userId) => {
                db.ref('users').on('value', snap => {
                    const data = snap.val() || {};
                    setUsers(data);
                    
                    if (data[userId]) {
                        // 2ÏãúÍ∞ÑÎßàÎã§ ÏßÄÎ™©Í∂å ÏûêÎèô ÏßÄÍ∏â (Ï§ëÎ≥µ Î∞©ÏßÄ)
                        const lastTicketTime = data[userId].lastGuessTicketTime || 0;
                        const now = Date.now();
                        const twoHours = 2 * 60 * 60 * 1000;
                        
                        // ÎßàÏßÄÎßâ ÏßÄÍ∏â ÏãúÍ∞ÑÏúºÎ°úÎ∂ÄÌÑ∞ Ï†ïÌôïÌûà 2ÏãúÍ∞Ñ Ïù¥ÏÉÅ Í≤ΩÍ≥ºÌïú Í≤ΩÏö∞ÏóêÎßå
                        if (now - lastTicketTime >= twoHours) {
                            const currentTickets = data[userId].guessTickets || 0;
                            db.ref(`users/${userId}`).update({
                                guessTickets: currentTickets + 1,
                                lastGuessTicketTime: now
                            });
                        }
                        
                        // 2ÏãúÍ∞Ñ Ï£ºÍ∏∞ Ï†ïÏ≤¥ Ï¥àÍ∏∞Ìôî Ï≤¥ÌÅ¨
                        const lastIdentityReset = data[userId].lastIdentityReset || 0;
                        const koreaTime = new Date(now + (9 * 60 * 60 * 1000));
                        const currentHour = koreaTime.getUTCHours();
                        const currentTwoHourSlot = Math.floor(currentHour / 2);
                        const slotStartTime = new Date(koreaTime.getUTCFullYear(), koreaTime.getUTCMonth(), koreaTime.getUTCDate(), currentTwoHourSlot * 2, 0, 0).getTime() - (9 * 60 * 60 * 1000);
                        
                        if (lastIdentityReset < slotStartTime) {
                            db.ref(`users/${userId}`).update({
                                lastIdentityReset: now,
                                alreadyGuessedCorrect: []
                            });
                            
                            Object.keys(data).forEach(uid => {
                                if (data[uid].revealedTo && data[uid].revealedTo.includes(userId)) {
                                    const newRevealedTo = data[uid].revealedTo.filter(id => id !== userId);
                                    db.ref(`users/${uid}/revealedTo`).set(newRevealedTo);
                                }
                            });
                        }
                    }
                });

                setTodayGuess(null);
            };

            // Í≤åÏãúÍ∏Ä Î°úÎìú
            useEffect(() => {
                db.ref('posts').on('value', snap => {
                    const data = snap.val();
                    if (data) {
                        const arr = Object.keys(data).map(k => ({
                            id: k,
                            ...data[k]
                        })).sort((a, b) => b.timestamp - a.timestamp);
                        setPosts(arr);
                    } else {
                        setPosts([]);
                    }
                });
            }, []);

            // ÎãâÎÑ§ÏûÑ ÎØ∏ÏÑ§Ï†ï Ïãú ÏûêÎèô Î™®Îã¨
            useEffect(() => {
                if (currentUser && users[currentUser.userId]) {
                    if (!users[currentUser.userId].nickname) {
                        setShowNicknameModal(true);
                    }
                }
            }, [currentUser, users]);

            // Î°úÍ∑∏Ïù∏
            const login = (userId, password) => {
                if (!ACCOUNTS[userId]) {
                    alert('Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî Í≥ÑÏ†ïÏûÖÎãàÎã§!');
                    return;
                }
                
                db.ref(`users/${userId}/password`).once('value').then(snap => {
                    const savedPassword = snap.val() || ACCOUNTS[userId].password;
                    
                    if (savedPassword !== btoa(password)) {
                        alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ†∏ÏäµÎãàÎã§!');
                        return;
                    }

                    localStorage.setItem('userId', userId);
                    setCurrentUser({ userId, ...ACCOUNTS[userId] });
                    loadUserData(userId);

                    db.ref(`users/${userId}`).once('value').then(snap => {
                        if (!snap.val()) {
                            return db.ref(`users/${userId}`).set({
                                name: ACCOUNTS[userId].name,
                                nickname: '',
                                nicknameChangedAt: 0,
                                nicknameChangeTickets: 0,
                                guessTickets: 1,
                                lastGuessTicketTime: Date.now(),
                                lastIdentityReset: Date.now(),
                                alreadyGuessedCorrect: [],
                                consecutiveCorrect: 0,
                                horusEyes: 0,
                                nicknameHistory: [],
                                revealedTo: [],
                                isPubliclyRevealed: false,
                                password: ACCOUNTS[userId].password
                            }).then(() => {
                                setShowNicknameModal(true);
                            });
                        } else {
                            // Í∏∞Ï°¥ ÏÇ¨Ïö©Ïûê - ÌïÑÎìú Ï∂îÍ∞Ä
                            const updates = {};
                            if (snap.val().nicknameChangeTickets === undefined) updates.nicknameChangeTickets = 0;
                            if (snap.val().guessTickets === undefined) updates.guessTickets = 1;
                            if (snap.val().lastGuessTicketTime === undefined) updates.lastGuessTicketTime = Date.now();
                            if (snap.val().lastIdentityReset === undefined) updates.lastIdentityReset = Date.now();
                            if (snap.val().alreadyGuessedCorrect === undefined) updates.alreadyGuessedCorrect = [];
                            if (snap.val().consecutiveCorrect === undefined) updates.consecutiveCorrect = 0;
                            if (snap.val().horusEyes === undefined) updates.horusEyes = 0;
                            if (snap.val().nicknameHistory === undefined) updates.nicknameHistory = [];
                            
                            if (Object.keys(updates).length > 0) {
                                db.ref(`users/${userId}`).update(updates);
                            }
                            
                            if (!snap.val().nickname || snap.val().nickname === '') {
                                setShowNicknameModal(true);
                            }
                        }
                    });
                });
            };

            // Î°úÍ∑∏ÏïÑÏõÉ
            const logout = () => {
                localStorage.removeItem('userId');
                setCurrentUser(null);
            };

            // ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω Í∞ÄÎä• Ïó¨Î∂Ä
            const canChangeNickname = () => {
                if (!currentUser || !users[currentUser.userId]) return false;
                
                const tickets = users[currentUser.userId].nicknameChangeTickets || 0;
                if (tickets > 0) return true;
                
                const lastChanged = users[currentUser.userId].nicknameChangedAt || 0;
                const now = Date.now();
                const twoHours = 2 * 60 * 60 * 1000;
                return now - lastChanged >= twoHours;
            };

            // ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω
            const changeNickname = (newNickname) => {
                if (!newNickname.trim()) {
                    alert('ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî!');
                    return;
                }
                
                // ÎãâÎÑ§ÏûÑ Ï§ëÎ≥µ Ï≤¥ÌÅ¨
                const isDuplicate = Object.keys(users).some(uid => 
                    uid !== currentUser.userId && 
                    users[uid].nickname === newNickname.trim()
                );
                
                if (isDuplicate) {
                    alert('Ïù¥ÎØ∏ ÏÇ¨Ïö© Ï§ëÏù∏ ÎãâÎÑ§ÏûÑÏûÖÎãàÎã§!');
                    return;
                }
                
                const tickets = users[currentUser.userId].nicknameChangeTickets || 0;
                const oldNickname = users[currentUser.userId].nickname || '';
                const wasGuessed = users[currentUser.userId].revealedTo && 
                                   users[currentUser.userId].revealedTo.length > 0;
                
                // ÎãâÎÑ§ÏûÑ ÌûàÏä§ÌÜ†Î¶¨ ÏóÖÎç∞Ïù¥Ìä∏
                const nicknameHistory = users[currentUser.userId].nicknameHistory || [];
                if (oldNickname) {
                    nicknameHistory.push({
                        nickname: oldNickname,
                        changedAt: Date.now(),
                        wasGuessed: wasGuessed
                    });
                }
                
                const updates = {
                    nickname: newNickname.trim(),
                    nicknameChangedAt: Date.now(),
                    nicknameHistory: nicknameHistory,
                    revealedTo: [],
                    isPubliclyRevealed: false,
                    alreadyGuessedCorrect: []
                };
                
                if (tickets > 0) {
                    updates.nicknameChangeTickets = tickets - 1;
                }
                
                db.ref(`users/${currentUser.userId}`).update(updates);
                
                // Îã§Î•∏ ÏÇ¨Ïö©ÏûêÎì§Ïùò alreadyGuessedCorrectÏóêÏÑú Ï†úÍ±∞
                Object.keys(users).forEach(uid => {
                    if (uid !== currentUser.userId && users[uid].alreadyGuessedCorrect) {
                        const alreadyGuessed = users[uid].alreadyGuessedCorrect;
                        if (alreadyGuessed.includes(currentUser.userId)) {
                            const newList = alreadyGuessed.filter(id => id !== currentUser.userId);
                            db.ref(`users/${uid}/alreadyGuessedCorrect`).set(newList);
                        }
                    }
                });
                
                setShowNicknameModal(false);
                
                if (tickets > 0) {
                    alert(`ÎãâÎÑ§ÏûÑÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§! (Î≥ÄÍ≤ΩÍ∂å ${tickets - 1}Í∞ú ÎÇ®Ïùå)\nÏ†ïÏ≤¥Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏñ¥ Îã§Ïãú ÏùµÎ™Ö ÏÉÅÌÉúÍ∞Ä ÎêòÏóàÏäµÎãàÎã§!`);
                } else {
                    alert('ÎãâÎÑ§ÏûÑÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§!\nÏ†ïÏ≤¥Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏñ¥ Îã§Ïãú ÏùµÎ™Ö ÏÉÅÌÉúÍ∞Ä ÎêòÏóàÏäµÎãàÎã§!');
                }
            };

            // ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω
            const changePassword = (currentPassword, newPassword, confirmPassword) => {
                db.ref(`users/${currentUser.userId}/password`).once('value').then(snap => {
                    const savedPassword = snap.val() || ACCOUNTS[currentUser.userId].password;
                    
                    if (btoa(currentPassword) !== savedPassword) {
                        alert('ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§!');
                        return;
                    }
                    
                    if (!newPassword || newPassword.length < 8) {
                        alert('ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 8Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§!');
                        return;
                    }
                    
                    if (newPassword !== confirmPassword) {
                        alert('ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§!');
                        return;
                    }
                    
                    db.ref(`users/${currentUser.userId}`).update({
                        password: btoa(newPassword)
                    }).then(() => {
                        setShowPasswordModal(false);
                        alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§!');
                    });
                });
            };

            // ÏßÄÎ™©ÌïòÍ∏∞
            const makeGuess = (targetUserId) => {
                if (targetUserId === currentUser.userId) {
                    alert('ÏûêÍ∏∞ ÏûêÏã†ÏùÄ ÏßÄÎ™©Ìï† Ïàò ÏóÜÏäµÎãàÎã§!');
                    return;
                }

                const guessTickets = users[currentUser.userId].guessTickets || 0;
                if (guessTickets <= 0) {
                    alert('ÏßÄÎ™©Í∂åÏù¥ ÏóÜÏäµÎãàÎã§!');
                    return;
                }

                const selectedUser = document.getElementById('guessSelect').value;

                if (!selectedUser) {
                    alert('Ï∂îÏ∏°Ìï† ÏÇ¨ÎûåÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!');
                    return;
                }

                const correct = selectedUser === targetUserId;

                if (correct) {
                    const consecutiveCorrect = (users[currentUser.userId].consecutiveCorrect || 0) + 1;
                    
                    db.ref(`users/${targetUserId}/revealedTo`).once('value', snap => {
                        const revealedTo = snap.val() || [];
                        if (!revealedTo.includes(currentUser.userId)) {
                            revealedTo.push(currentUser.userId);
                            db.ref(`users/${targetUserId}/revealedTo`).set(revealedTo);
                        }
                    });
                    
                    db.ref(`users/${currentUser.userId}/alreadyGuessedCorrect`).once('value', snap => {
                        const alreadyGuessed = snap.val() || [];
                        if (!alreadyGuessed.includes(targetUserId)) {
                            alreadyGuessed.push(targetUserId);
                            db.ref(`users/${currentUser.userId}/alreadyGuessedCorrect`).set(alreadyGuessed);
                        }
                    });
                    
                    const currentTickets = users[currentUser.userId].nicknameChangeTickets || 0;
                    const updates = {
                        nicknameChangeTickets: currentTickets + 2,
                        consecutiveCorrect: consecutiveCorrect
                    };
                    
                    // 7Ïó∞ÏÜç Ï†ïÎãµ Ïãú Ìò∏Î£®Ïä§Ïùò Îàà ÌöçÎìù
                    if (consecutiveCorrect === 7) {
                        const horusEyes = users[currentUser.userId].horusEyes || 0;
                        updates.horusEyes = horusEyes + 1;
                        updates.consecutiveCorrect = 0;
                        db.ref(`users/${currentUser.userId}`).update(updates);
                        alert(`Ï†ïÎãµÏûÖÎãàÎã§! ${ACCOUNTS[targetUserId].name}ÎãòÏùò Ï†ïÏ≤¥Î•º ÏïåÍ≤å ÎêòÏóàÏäµÎãàÎã§!\nÎãâÎÑ§ÏûÑ Î≥ÄÍ≤ΩÍ∂å 2Ïû•ÏùÑ ÌöçÎìùÌñàÏäµÎãàÎã§!\nüîÆ 7Ïó∞ÏÜç Ï†ïÎãµ! Ìò∏Î£®Ïä§Ïùò ÎààÏùÑ ÌöçÎìùÌñàÏäµÎãàÎã§!`);
                    } else {
                        db.ref(`users/${currentUser.userId}`).update(updates);
                        alert(`Ï†ïÎãµÏûÖÎãàÎã§! ${ACCOUNTS[targetUserId].name}ÎãòÏùò Ï†ïÏ≤¥Î•º ÏïåÍ≤å ÎêòÏóàÏäµÎãàÎã§!\nÎãâÎÑ§ÏûÑ Î≥ÄÍ≤ΩÍ∂å 2Ïû•ÏùÑ ÌöçÎìùÌñàÏäµÎãàÎã§!\nÏßÄÎ™©Í∂åÏùÄ ÏÜåÎ™®ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.\nÏó∞ÏÜç Ï†ïÎãµ: ${consecutiveCorrect}/7`);
                    }
                } else {
                    db.ref(`users/${currentUser.userId}`).update({
                        isPubliclyRevealed: true,
                        guessTickets: guessTickets - 1,
                        consecutiveCorrect: 0
                    });
                    alert(`ÌãÄÎ†∏ÏäµÎãàÎã§! ÎãπÏã†Ïùò Ï†ïÏ≤¥Í∞Ä Î™®ÎëêÏóêÍ≤å Í≥µÍ∞úÎê©ÎãàÎã§!\nÏßÄÎ™©Í∂å 1Í∞úÍ∞Ä ÏÜåÎ™®ÎêòÏóàÏäµÎãàÎã§.\nÏó∞ÏÜç Ï†ïÎãµÏù¥ Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.`);
                }

                setShowGuessModal(false);
            };

            // Ìò∏Î£®Ïä§Ïùò ÎààÏúºÎ°ú ÎãâÎÑ§ÏûÑ ÌûàÏä§ÌÜ†Î¶¨ Î≥¥Í∏∞
            const useHorusEye = (targetUserId) => {
                const horusEyes = users[currentUser.userId].horusEyes || 0;
                if (horusEyes <= 0) {
                    alert('Ìò∏Î£®Ïä§Ïùò ÎààÏù¥ ÏóÜÏäµÎãàÎã§!');
                    return;
                }
                
                const targetUser = users[targetUserId];
                const nicknameHistory = targetUser.nicknameHistory || [];
                
                // Ìò∏Î£®Ïä§Ïùò Îàà ÏÇ¨Ïö©
                db.ref(`users/${currentUser.userId}/horusEyes`).set(horusEyes - 1);
                
                const unguessedNicknames = nicknameHistory.filter(h => !h.wasGuessed);
                
                let message = `üîÆ Ìò∏Î£®Ïä§Ïùò Îàà ÏÇ¨Ïö© (ÎÇ®ÏùÄ Í∞úÏàò: ${horusEyes - 1}Í∞ú)\n\n`;
                message += `${targetUser.nickname}ÎãòÏùò ÎãâÎÑ§ÏûÑ ÌûàÏä§ÌÜ†Î¶¨:\n\n`;
                
                if (unguessedNicknames.length > 0) {
                    message += '=== ÏßÄÎ™©ÎãπÌïòÏßÄ ÏïäÏùÄ ÎãâÎÑ§ÏûÑ ===\n';
                    unguessedNicknames.forEach((h, i) => {
                        message += `${i + 1}. ${h.nickname} (${new Date(h.changedAt).toLocaleString('ko-KR')})\n`;
                    });
                }
                
                const guessedNicknames = nicknameHistory.filter(h => h.wasGuessed);
                if (guessedNicknames.length > 0) {
                    message += '\n=== ÏßÄÎ™©ÎãπÌïú ÎãâÎÑ§ÏûÑ ===\n';
                    guessedNicknames.forEach((h, i) => {
                        message += `${i + 1}. ${h.nickname} (${new Date(h.changedAt).toLocaleString('ko-KR')})\n`;
                    });
                }
                
                if (nicknameHistory.length === 0) {
                    message += 'ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.';
                }
                
                alert(message);
                setShowHorusModal(false);
            };

            // ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤ΩÍ∂åÏúºÎ°ú Ìò∏Î£®Ïä§Ïùò Îàà Íµ¨Îß§
            const buyHorusEye = () => {
                const tickets = users[currentUser.userId].nicknameChangeTickets || 0;
                if (tickets < 30) {
                    alert(`ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤ΩÍ∂åÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§! (Î≥¥Ïú†: ${tickets}Í∞ú, ÌïÑÏöî: 30Í∞ú)`);
                    return;
                }
                
                if (!confirm('ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤ΩÍ∂å 30Í∞úÎ°ú Ìò∏Î£®Ïä§Ïùò Îàà 1Í∞úÎ•º Íµ¨Îß§ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                    return;
                }
                
                const horusEyes = users[currentUser.userId].horusEyes || 0;
                db.ref(`users/${currentUser.userId}`).update({
                    nicknameChangeTickets: tickets - 30,
                    horusEyes: horusEyes + 1
                });
                
                alert('üîÆ Ìò∏Î£®Ïä§Ïùò ÎààÏùÑ Íµ¨Îß§ÌñàÏäµÎãàÎã§!');
            };

            // Í≤åÏãúÍ∏Ä ÏûëÏÑ±
            const writePost = (title, content) => {
                if (!title.trim() || !content.trim()) {
                    alert('Ï†úÎ™©Í≥º ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî!');
                    return;
                }

                const currentNickname = users[currentUser.userId]?.nickname || '';
                if (!currentNickname) {
                    alert('ÎãâÎÑ§ÏûÑÏùÑ Î®ºÏ†Ä ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî!');
                    setShowWriteModal(false);
                    setShowNicknameModal(true);
                    return;
                }

                const postId = Date.now().toString();

                db.ref(`posts/${postId}`).set({
                    authorId: currentUser.userId,
                    nickname: currentNickname,
                    title: title.trim(),
                    content: content.trim(),
                    timestamp: Date.now()
                }).then(() => {
                    setShowWriteModal(false);
                    alert('Í≤åÏãúÍ∏ÄÏù¥ ÏûëÏÑ±ÎêòÏóàÏäµÎãàÎã§!');
                });
            };

            // ÎåìÍ∏Ä ÏûëÏÑ±
            const writeComment = (postId, content) => {
                if (!content.trim()) {
                    alert('ÎåìÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî!');
                    return;
                }

                const currentNickname = users[currentUser.userId]?.nickname || '';
                if (!currentNickname) {
                    alert('ÎãâÎÑ§ÏûÑÏùÑ Î®ºÏ†Ä ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî!');
                    setShowPostModal(false);
                    setShowNicknameModal(true);
                    return;
                }

                const commentId = Date.now().toString();

                db.ref(`posts/${postId}/comments/${commentId}`).set({
                    authorId: currentUser.userId,
                    nickname: currentNickname,
                    content: content.trim(),
                    timestamp: Date.now()
                });
            };

            // Ï¥àÍ∏∞Ìôî (Í¥ÄÎ¶¨ÏûêÎßå)
            const resetAllData = () => {
                if (currentUser.userId !== 'user8') {
                    alert('Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§!');
                    return;
                }
                if (!confirm('Ï†ïÎßêÎ°ú Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
                if (!confirm('Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§!')) return;
                
                db.ref('posts').remove();
                db.ref('users').remove();
                alert('Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.');
                logout();
            };

            // ÎÇ¥Í∞Ä ÏïåÍ≥† ÏûàÎäî Ï†ïÏ≤¥Îì§
            const getKnownIdentities = () => {
                if (!currentUser) return [];
                const known = [];
                Object.keys(users).forEach(uid => {
                    const user = users[uid];
                    if (user.isPubliclyRevealed) {
                        known.push({ userId: uid, name: ACCOUNTS[uid].name, type: 'public' });
                    } else if (user.revealedTo && user.revealedTo.includes(currentUser.userId)) {
                        known.push({ userId: uid, name: ACCOUNTS[uid].name, type: 'private' });
                    }
                });
                return known;
            };

            // ÌÉÄÏù¥Î®∏ Ìï®ÏàòÎì§
            const formatTimeRemaining = (milliseconds) => {
                if (milliseconds <= 0) return 'Í∞±Ïã† Í∞ÄÎä•';
                
                const totalSeconds = Math.floor(milliseconds / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            };

            const formatActualTime = (timestamp) => {
                const date = new Date(timestamp);
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${hours}:${minutes}`;
            };

            const getNicknameChangeTimer = () => {
                if (!currentUser || !users[currentUser.userId]) return 'Í≥ÑÏÇ∞Ï§ë...';
                const tickets = users[currentUser.userId].nicknameChangeTickets || 0;
                if (tickets > 0) return 'Î≥ÄÍ≤ΩÍ∂å Î≥¥Ïú†';
                
                const lastChanged = users[currentUser.userId].nicknameChangedAt || 0;
                const twoHours = 2 * 60 * 60 * 1000;
                const nextChangeTime = lastChanged + twoHours;
                const remaining = nextChangeTime - currentTime;
                
                if (remaining <= 0) return 'Í∞±Ïã† Í∞ÄÎä•';
                
                return `${formatActualTime(nextChangeTime)}Î∂ÄÌÑ∞`;
            };

            const getGuessTicketTimer = () => {
                if (!currentUser || !users[currentUser.userId]) return 'Í≥ÑÏÇ∞Ï§ë...';
                
                const lastTicketTime = users[currentUser.userId].lastGuessTicketTime || 0;
                const twoHours = 2 * 60 * 60 * 1000;
                const nextTicketTime = lastTicketTime + twoHours;
                const remaining = nextTicketTime - currentTime;
                
                if (remaining <= 0) return 'Í∞±Ïã† Í∞ÄÎä•';
                
                return `${formatActualTime(nextTicketTime)}Î∂ÄÌÑ∞`;
            };

            const getIdentityResetTimer = () => {
                const now = currentTime;
                const koreaTime = new Date(now + (9 * 60 * 60 * 1000));
                const currentHour = koreaTime.getUTCHours();
                const nextSlotHour = (Math.floor(currentHour / 2) + 1) * 2;
                
                const nextReset = new Date(koreaTime.getUTCFullYear(), koreaTime.getUTCMonth(), koreaTime.getUTCDate(), nextSlotHour, 0, 0);
                const hours = nextReset.getUTCHours().toString().padStart(2, '0');
                const minutes = nextReset.getUTCMinutes().toString().padStart(2, '0');
                
                return `${hours}:${minutes}Î∂ÄÌÑ∞`;
            };

            if (!currentUser) {
                return <LoginScreen onLogin={login} />;
            }

            const myNickname = users[currentUser.userId]?.nickname || '';
            const knownIdentities = getKnownIdentities();
            const nicknameTickets = users[currentUser.userId]?.nicknameChangeTickets || 0;
            const guessTickets = users[currentUser.userId]?.guessTickets || 0;
            const horusEyes = users[currentUser.userId]?.horusEyes || 0;
            const consecutiveCorrect = users[currentUser.userId]?.consecutiveCorrect || 0;

            return (
                <div className="container">
                    <div className="header">
                        <h1>ANONYMOUS BOARD</h1>
                        <p>We do not forgive. We do not forget. Expect us.</p>
                        <div className="header-top">
                            <span style={{color: users[currentUser.userId]?.isPubliclyRevealed ? '#c00' : '#090'}}>
                                {users[currentUser.userId]?.isPubliclyRevealed 
                                    ? `‚ö† ÎãπÏã†Ïùò Ï†ïÏ≤¥Îäî Í≥µÍ∞úÎêòÏóàÏäµÎãàÎã§ (Ïã§Î™Ö: ${currentUser.name})`
                                    : `‚úì ÎãπÏã†Ïùò Ï†ïÏ≤¥Îäî ÏïàÏ†ÑÌï©ÎãàÎã§ (Ïã§Î™Ö: ${currentUser.name})`
                                }
                            </span>
                        </div>
                        <div className="timer-container">
                            <div className="timer-box">
                                <div style={{color: '#000', marginBottom: '5px', fontWeight: 'bold'}}>
                                    üé´ ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤ΩÍ∂å: {nicknameTickets}Í∞ú
                                </div>
                                <div style={{color: '#666', fontSize: '0.85em'}}>
                                    Îã§Ïùå Í∞±Ïã†: {getNicknameChangeTimer()}
                                </div>
                            </div>
                            <div className="timer-box">
                                <div style={{color: guessTickets > 0 ? '#000' : '#c00', marginBottom: '5px', fontWeight: 'bold'}}>
                                    üéØ ÏßÄÎ™©Í∂å: {guessTickets}Í∞ú
                                </div>
                                <div style={{color: '#666', fontSize: '0.85em'}}>
                                    Îã§Ïùå Í∞±Ïã†: {getGuessTicketTimer()}
                                </div>
                            </div>
                        </div>
                        <div style={{
                            background: '#f9f9f9',
                            border: '1px solid #ddd',
                            padding: '12px',
                            marginBottom: '15px',
                            borderRadius: '4px',
                            textAlign: 'center'
                        }}>
                            <div style={{color: '#000', marginBottom: '3px', fontWeight: 'bold'}}>
                                üîÆ Ìò∏Î£®Ïä§Ïùò Îàà: {horusEyes}Í∞ú | Ïó∞ÏÜç Ï†ïÎãµ: {consecutiveCorrect}/7
                            </div>
                            <div style={{color: '#666', fontSize: '0.85em'}}>
                                Ï†ïÏ≤¥ Ï¥àÍ∏∞Ìôî: {getIdentityResetTimer()}
                            </div>
                        </div>
                        <div className="header-buttons">
                            <button className="btn" onClick={() => setShowNicknameModal(true)}>
                                ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω
                            </button>
                            <button className="btn" onClick={() => setShowPasswordModal(true)}>
                                ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω
                            </button>
                            <button 
                                className="btn" 
                                onClick={() => setShowGuessModal(true)}
                                disabled={guessTickets <= 0}
                            >
                                {guessTickets > 0 ? 'ÏßÄÎ™©ÌïòÍ∏∞' : 'ÏßÄÎ™©Í∂å ÏóÜÏùå'}
                            </button>
                            <button className="btn btn-special" onClick={() => setShowHorusModal(true)}>
                                üîÆ Ìò∏Î£®Ïä§Ïùò Îàà
                            </button>
                        </div>
                        <button className="btn btn-secondary" onClick={logout} style={{marginTop: '10px'}}>
                            Î°úÍ∑∏ÏïÑÏõÉ
                        </button>
                        {currentUser.userId === 'user8' && (
                            <button 
                                className="btn btn-danger" 
                                onClick={resetAllData}
                                style={{marginTop: '10px'}}
                            >
                                üóë Î™®Îì† Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî (Í¥ÄÎ¶¨Ïûê Ï†ÑÏö©)
                            </button>
                        )}
                    </div>

                    {knownIdentities.length > 0 && (
                        <div className="card">
                            <h3 style={{marginBottom: '15px'}}>üîç ÎÇ¥Í∞Ä ÏïåÍ≥† ÏûàÎäî Ï†ïÏ≤¥Îì§</h3>
                            {knownIdentities.map(k => (
                                <span key={k.userId} className="known-identity">
                                    {users[k.userId]?.nickname || '???'} = {k.name}
                                    {k.type === 'public' && ' (Ï†ÑÏ≤¥Í≥µÍ∞ú)'}
                                </span>
                            ))}
                        </div>
                    )}

                    <button className="btn" onClick={() => setShowWriteModal(true)}>
                        ÏÉà Í∏Ä ÏûëÏÑ±
                    </button>

                    <div>
                        {posts.map(post => {
                            const author = users[post.authorId];
                            const isRevealed = author?.isPubliclyRevealed || 
                                             (author?.revealedTo && author.revealedTo.includes(currentUser.userId));
                            const displayName = isRevealed 
                                ? `${post.nickname} (${ACCOUNTS[post.authorId]?.name})`
                                : post.nickname;

                            const comments = post.comments ? Object.values(post.comments).sort((a, b) => a.timestamp - b.timestamp) : [];

                            return (
                                <div 
                                    key={post.id} 
                                    className="post"
                                    onClick={() => {
                                        setSelectedPost(post);
                                        setShowPostModal(true);
                                    }}
                                >
                                    <div className="post-title">{post.title}</div>
                                    <div className="post-meta">
                                        ÏûëÏÑ±Ïûê: {displayName}
                                        {isRevealed && <span className="revealed-tag">Ï†ïÏ≤¥Í≥µÍ∞ú</span>}
                                        {' ‚Ä¢ '}
                                        {new Date(post.timestamp).toLocaleString('ko-KR')}
                                    </div>
                                    <div className="post-content">
                                        {post.content.length > 100 
                                            ? post.content.substring(0, 100) + '...'
                                            : post.content
                                        }
                                    </div>
                                    {comments.length > 0 && (
                                        <div style={{
                                            marginTop: '15px',
                                            padding: '10px',
                                            background: '#f0f0f0',
                                            borderLeft: '2px solid #999',
                                            borderRadius: '4px'
                                        }}>
                                            <div style={{color: '#666', fontSize: '0.9rem', marginBottom: '8px'}}>
                                                üí¨ ÎåìÍ∏Ä {comments.length}Í∞ú
                                            </div>
                                            {comments.map(comment => {
                                                const cAuthor = users[comment.authorId];
                                                const cIsRevealed = cAuthor?.isPubliclyRevealed || 
                                                                  (cAuthor?.revealedTo && cAuthor.revealedTo.includes(currentUser.userId));
                                                const cDisplayName = cIsRevealed 
                                                    ? `${comment.nickname} (${ACCOUNTS[comment.authorId]?.name})`
                                                    : comment.nickname;

                                                return (
                                                    <div key={comment.timestamp} style={{
                                                        color: '#555',
                                                        fontSize: '0.85rem',
                                                        padding: '5px 0',
                                                        borderBottom: '1px solid #ddd'
                                                    }}>
                                                        <span style={{color: '#000', fontWeight: 'bold'}}>
                                                            {cDisplayName}:
                                                        </span> {comment.content.length > 50 ? comment.content.substring(0, 50) + '...' : comment.content}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>

                    {showWriteModal && (
                        <WriteModal 
                            onClose={() => setShowWriteModal(false)}
                            onSubmit={writePost}
                        />
                    )}

                    {showPostModal && selectedPost && (
                        <PostModal 
                            post={selectedPost}
                            users={users}
                            currentUser={currentUser}
                            ACCOUNTS={ACCOUNTS}
                            onClose={() => setShowPostModal(false)}
                            onComment={writeComment}
                        />
                    )}

                    {showGuessModal && (
                        <GuessModal 
                            users={users}
                            currentUser={currentUser}
                            ACCOUNTS={ACCOUNTS}
                            onClose={() => setShowGuessModal(false)}
                            onSubmit={makeGuess}
                        />
                    )}

                    {showNicknameModal && (
                        <NicknameModal 
                            currentNickname={myNickname}
                            canChange={canChangeNickname()}
                            tickets={nicknameTickets}
                            onClose={() => myNickname ? setShowNicknameModal(false) : null}
                            onSubmit={changeNickname}
                        />
                    )}

                    {showPasswordModal && (
                        <PasswordModal 
                            onClose={() => setShowPasswordModal(false)}
                            onSubmit={changePassword}
                        />
                    )}

                    {showHorusModal && (
                        <HorusModal
                            users={users}
                            currentUser={currentUser}
                            ACCOUNTS={ACCOUNTS}
                            horusEyes={horusEyes}
                            nicknameTickets={nicknameTickets}
                            onClose={() => setShowHorusModal(false)}
                            onUse={useHorusEye}
                            onBuy={buyHorusEye}
                        />
                    )}
                </div>
            );
        }

        function LoginScreen({ onLogin }) {
            const [userId, setUserId] = useState('');
            const [password, setPassword] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                onLogin(userId, password);
            };

            return (
                <div className="login-container">
                    <div className="login-header">
                        <h1>ANONYMOUS LOGIN</h1>
                    </div>
                    <div className="login-card">
                        <h2>Î°úÍ∑∏Ïù∏</h2>
                        <form onSubmit={handleSubmit}>
                            <label>ÏïÑÏù¥Îîî</label>
                            <input 
                                type="text" 
                                value={userId}
                                onChange={(e) => setUserId(e.target.value)}
                                placeholder="ÏïÑÏù¥ÎîîÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                            />
                            <label>ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                            <input 
                                type="password"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                            />
                            <button type="submit" className="btn" style={{marginTop: '15px'}}>
                                Î°úÍ∑∏Ïù∏
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        function WriteModal({ onClose, onSubmit }) {
            const [title, setTitle] = useState('');
            const [content, setContent] = useState('');

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>ÏÉà Í∏Ä ÏûëÏÑ±</h2>
                        <label>Ï†úÎ™©</label>
                        <input 
                            type="text"
                            value={title}
                            onChange={(e) => setTitle(e.target.value)}
                            placeholder="Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                        />
                        <label>ÎÇ¥Ïö©</label>
                        <textarea 
                            value={content}
                            onChange={(e) => setContent(e.target.value)}
                            placeholder="ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                        />
                        <button 
                            className="btn" 
                            onClick={() => onSubmit(title, content)}
                            style={{marginTop: '15px'}}
                        >
                            Í≤åÏãú
                        </button>
                        <button 
                            className="btn btn-secondary" 
                            onClick={onClose}
                        >
                            Ï∑®ÏÜå
                        </button>
                    </div>
                </div>
            );
        }

        function PostModal({ post, users, currentUser, ACCOUNTS, onClose, onComment }) {
            const [commentContent, setCommentContent] = useState('');
            const comments = post.comments ? Object.values(post.comments).sort((a, b) => a.timestamp - b.timestamp) : [];

            const author = users[post.authorId];
            const isRevealed = author?.isPubliclyRevealed || 
                             (author?.revealedTo && author.revealedTo.includes(currentUser.userId));
            const displayName = isRevealed 
                ? `${post.nickname} (${ACCOUNTS[post.authorId]?.name})`
                : post.nickname;

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>{post.title}</h2>
                        <div className="post-meta" style={{marginBottom: '15px'}}>
                            ÏûëÏÑ±Ïûê: {displayName}
                            {isRevealed && <span className="revealed-tag">Ï†ïÏ≤¥Í≥µÍ∞ú</span>}
                            <br />
                            {new Date(post.timestamp).toLocaleString('ko-KR')}
                        </div>
                        <div className="post-content" style={{marginBottom: '20px'}}>
                            {post.content}
                        </div>

                        <h3 style={{marginTop: '20px', marginBottom: '10px'}}>
                            ÎåìÍ∏Ä {comments.length}Í∞ú
                        </h3>
                        {comments.map(comment => {
                            const cAuthor = users[comment.authorId];
                            const cIsRevealed = cAuthor?.isPubliclyRevealed || 
                                              (cAuthor?.revealedTo && cAuthor.revealedTo.includes(currentUser.userId));
                            const cDisplayName = cIsRevealed 
                                ? `${comment.nickname} (${ACCOUNTS[comment.authorId]?.name})`
                                : comment.nickname;

                            return (
                                <div key={comment.timestamp} className="comment">
                                    <div style={{fontSize: '0.9rem', color: '#666', marginBottom: '5px'}}>
                                        {cDisplayName}
                                        {cIsRevealed && <span className="revealed-tag">Ï†ïÏ≤¥Í≥µÍ∞ú</span>}
                                        {' ‚Ä¢ '}
                                        {new Date(comment.timestamp).toLocaleString('ko-KR')}
                                    </div>
                                    <div style={{color: '#000'}}>{comment.content}</div>
                                </div>
                            );
                        })}

                        <textarea 
                            value={commentContent}
                            onChange={(e) => setCommentContent(e.target.value)}
                            placeholder="ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                            style={{marginTop: '15px'}}
                        />
                        <button 
                            className="btn" 
                            onClick={() => {
                                onComment(post.id, commentContent);
                                setCommentContent('');
                            }}
                            style={{marginTop: '10px'}}
                        >
                            ÎåìÍ∏Ä ÏûëÏÑ±
                        </button>
                        <button 
                            className="btn btn-secondary" 
                            onClick={onClose}
                        >
                            Îã´Í∏∞
                        </button>
                    </div>
                </div>
            );
        }

        function GuessModal({ users, currentUser, ACCOUNTS, onClose, onSubmit }) {
            const [targetUser, setTargetUser] = useState('');
            const guessTickets = users[currentUser.userId]?.guessTickets || 0;
            const alreadyGuessed = users[currentUser.userId]?.alreadyGuessedCorrect || [];

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>ÎàÑÍµ∞Í∞ÄÏùò Ï†ïÏ≤¥Î•º ÏßÄÎ™©ÌïòÍ∏∞ üéØ</h2>
                        
                        <div className="info-box">
                            üí° Î≥¥Ïú† ÏßÄÎ™©Í∂å: {guessTickets}Í∞ú<br/>
                            ‚Ä¢ ÏÑ±Í≥µ Ïãú: Ï†ïÏ≤¥ Í≥µÍ∞ú + ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤ΩÍ∂å 2Í∞ú + ÏßÄÎ™©Í∂å Ïú†ÏßÄ<br/>
                            ‚Ä¢ Ïã§Ìå® Ïãú: Î≥∏Ïù∏ Ï†ïÏ≤¥ Í≥µÍ∞ú + ÏßÄÎ™©Í∂å 1Í∞ú ÏÜåÎ™® + Ïó∞ÏÜçÏ†ïÎãµ Ï¥àÍ∏∞Ìôî
                        </div>
                        
                        <div className="warning-box">
                            <h4>‚ö† Ï£ºÏùòÏÇ¨Ìï≠</h4>
                            <ul style={{listStyle: 'none', padding: 0}}>
                                <li>‚Ä¢ ÏßÄÎ™©Í∂åÏùÄ 2ÏãúÍ∞ÑÎßàÎã§ 1Í∞úÏî© ÏûêÎèô ÏßÄÍ∏â</li>
                                <li>‚Ä¢ 7Ïó∞ÏÜç Ï†ïÎãµ Ïãú Ìò∏Î£®Ïä§Ïùò Îàà ÌöçÎìù</li>
                                <li>‚Ä¢ Ï†ïÏ≤¥ ÌÉÑÎ°úÎÇú ÏÇ¨ÎûåÏùÄ ÏßÄÎ™© Î∂àÍ∞Ä</li>
                                <li>‚Ä¢ Ïù¥ÎØ∏ ÎßûÏ∂ò ÏÇ¨ÎûåÏùÄ Ïû¨ÏßÄÎ™© Î∂àÍ∞Ä</li>
                            </ul>
                        </div>

                        <label>ÏßÄÎ™©Ìï† ÏÇ¨ÎûåÏùò ÎãâÎÑ§ÏûÑ</label>
                        <select value={targetUser} onChange={(e) => setTargetUser(e.target.value)}>
                            <option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                            {Object.keys(users)
                                .filter(uid => 
                                    uid !== currentUser.userId && 
                                    users[uid].nickname && 
                                    users[uid].nickname.trim() !== '' &&
                                    !users[uid].isPubliclyRevealed &&
                                    !alreadyGuessed.includes(uid)
                                )
                                .map(uid => (
                                    <option key={uid} value={uid}>
                                        {users[uid].nickname}
                                    </option>
                                ))
                            }
                        </select>

                        <label>Ïù¥ ÏÇ¨ÎûåÏùò Ïã§Ï†ú Ï†ïÏ≤¥Îäî?</label>
                        <select id="guessSelect">
                            <option value="">Ï∂îÏ∏°ÌïòÏÑ∏Ïöî</option>
                            {Object.keys(ACCOUNTS).map(uid => (
                                <option key={uid} value={uid}>
                                    {ACCOUNTS[uid].name}
                                </option>
                            ))}
                        </select>

                        <button 
                            className="btn btn-danger" 
                            onClick={() => targetUser && onSubmit(targetUser)}
                            style={{marginTop: '15px'}}
                        >
                            ÏßÄÎ™©ÌïòÍ∏∞
                        </button>
                        <button 
                            className="btn btn-secondary" 
                            onClick={onClose}
                        >
                            Ï∑®ÏÜå
                        </button>
                    </div>
                </div>
            );
        }

        function NicknameModal({ currentNickname, canChange, tickets, onClose, onSubmit }) {
            const [nickname, setNickname] = useState(currentNickname || '');

            return (
                <div className="modal" onClick={currentNickname ? onClose : null}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>ÎãâÎÑ§ÏûÑ {currentNickname ? 'Î≥ÄÍ≤Ω' : 'ÏÑ§Ï†ï'}</h2>
                        
                        {tickets > 0 && (
                            <div className="info-box">
                                üé´ Î≥¥Ïú†Ìïú Î≥ÄÍ≤ΩÍ∂å: {tickets}Í∞ú<br/>
                                ÏãúÍ∞Ñ Ï†úÌïú ÏóÜÏù¥ Ï¶âÏãú Î≥ÄÍ≤Ω Í∞ÄÎä•Ìï©ÎãàÎã§!
                            </div>
                        )}
                        
                        {!canChange && currentNickname && tickets === 0 && (
                            <div className="warning-box">
                                ‚ö† ÎãâÎÑ§ÏûÑÏùÄ 2ÏãúÍ∞ÑÎßàÎã§ Ìïú Î≤àÎßå Î≥ÄÍ≤ΩÌï† Ïàò ÏûàÏäµÎãàÎã§!
                            </div>
                        )}

                        <label>ÎãâÎÑ§ÏûÑ</label>
                        <input 
                            type="text"
                            value={nickname}
                            onChange={(e) => setNickname(e.target.value)}
                            placeholder="ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                            disabled={!canChange && currentNickname}
                        />

                        <button 
                            className="btn" 
                            onClick={() => onSubmit(nickname)}
                            disabled={!canChange && currentNickname}
                            style={{marginTop: '15px'}}
                        >
                            {currentNickname ? (tickets > 0 ? 'Î≥ÄÍ≤Ω (Î≥ÄÍ≤ΩÍ∂å ÏÇ¨Ïö©)' : 'Î≥ÄÍ≤Ω') : 'ÏÑ§Ï†ï'}
                        </button>
                        {currentNickname && (
                            <button 
                                className="btn btn-secondary" 
                                onClick={onClose}
                            >
                                Ï∑®ÏÜå
                            </button>
                        )}
                    </div>
                </div>
            );
        }

        function PasswordModal({ onClose, onSubmit }) {
            const [currentPassword, setCurrentPassword] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω</h2>
                        
                        <div className="info-box">
                            üí° ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 8Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.
                        </div>

                        <label>ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                        <input 
                            type="password"
                            value={currentPassword}
                            onChange={(e) => setCurrentPassword(e.target.value)}
                            placeholder="ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏"
                        />

                        <label>ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                        <input 
                            type="password"
                            value={newPassword}
                            onChange={(e) => setNewPassword(e.target.value)}
                            placeholder="ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ (8Ïûê Ïù¥ÏÉÅ)"
                        />

                        <label>ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏</label>
                        <input 
                            type="password"
                            value={confirmPassword}
                            onChange={(e) => setConfirmPassword(e.target.value)}
                            placeholder="ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏"
                        />

                        <button 
                            className="btn" 
                            onClick={() => onSubmit(currentPassword, newPassword, confirmPassword)}
                            style={{marginTop: '15px'}}
                        >
                            ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω
                        </button>
                        <button 
                            className="btn btn-secondary" 
                            onClick={onClose}
                        >
                            Ï∑®ÏÜå
                        </button>
                    </div>
                </div>
            );
        }

        function HorusModal({ users, currentUser, ACCOUNTS, horusEyes, nicknameTickets, onClose, onUse, onBuy }) {
            const [targetUser, setTargetUser] = useState('');

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>üîÆ Ìò∏Î£®Ïä§Ïùò Îàà</h2>
                        
                        <div className="info-box">
                            <strong>Î≥¥Ïú† Í∞úÏàò: {horusEyes}Í∞ú</strong><br/><br/>
                            Ìò∏Î£®Ïä§Ïùò ÎààÏúºÎ°ú Îã§Î•∏ ÏÇ¨ÎûåÏùò Î™®Îì† ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω Í∏∞Î°ùÏùÑ Î≥º Ïàò ÏûàÏäµÎãàÎã§.<br/>
                            Îã®, ÏßÄÎ™©ÎãπÌïòÏßÄ ÏïäÍ≥† Î≥ÄÍ≤ΩÌïú ÎãâÎÑ§ÏûÑÎßå ÌôïÏù∏ Í∞ÄÎä•Ìï©ÎãàÎã§.
                        </div>
                        
                        <div className="warning-box">
                            <h4>ÌöçÎìù Î∞©Î≤ï</h4>
                            <ul style={{listStyle: 'none', padding: 0}}>
                                <li>‚Ä¢ ÏßÄÎ™©ÏùÑ 7Ïó∞ÏÜçÏúºÎ°ú ÏÑ±Í≥µ</li>
                                <li>‚Ä¢ ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤ΩÍ∂å 30Í∞úÎ°ú Íµ¨Îß§</li>
                            </ul>
                        </div>

                        <button 
                            className="btn btn-special" 
                            onClick={onBuy}
                            style={{marginBottom: '15px'}}
                        >
                            Ìò∏Î£®Ïä§Ïùò Îàà Íµ¨Îß§ (Î≥ÄÍ≤ΩÍ∂å 30Í∞ú) - Î≥¥Ïú†: {nicknameTickets}Í∞ú
                        </button>

                        <label>ÎåÄÏÉÅ ÏÑ†ÌÉù</label>
                        <select value={targetUser} onChange={(e) => setTargetUser(e.target.value)}>
                            <option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                            {Object.keys(users)
                                .filter(uid => uid !== currentUser.userId && users[uid].nickname)
                                .map(uid => (
                                    <option key={uid} value={uid}>
                                        {users[uid].nickname}
                                    </option>
                                ))
                            }
                        </select>

                        <button 
                            className="btn btn-special" 
                            onClick={() => targetUser && onUse(targetUser)}
                            disabled={horusEyes <= 0 || !targetUser}
                            style={{marginTop: '15px'}}
                        >
                            ÏÇ¨Ïö©ÌïòÍ∏∞ (1Ìöå ÏÜåÎ™®)
                        </button>
                        <button 
                            className="btn btn-secondary" 
                            onClick={onClose}
                        >
                            Îã´Í∏∞
                        </button>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
