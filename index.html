<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonymous Board</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #fff;
            min-height: 100vh;
        }
        
        /* Splash Screen */
        #splash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeOut 1s forwards;
            animation-delay: 1s;
        }

        #splash img {
            width: 300px;
            height: auto;
            animation: glitch 0.3s infinite;
        }

        #splash h1 {
            margin-top: 30px;
            font-size: 2.5em;
            letter-spacing: 5px;
            animation: flicker 1.5s infinite;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }

        @keyframes glitch {
            0%, 100% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
        }

        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        #root {
            opacity: 0;
            animation: fadeIn 1s forwards;
            animation-delay: 2s;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
        }
        
        .btn {
            background: #222;
            color: #fff;
            border: 1px solid #444;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            font-family: 'Courier New', monospace;
        }
        
        .btn:hover {
            background: #333;
            border-color: #666;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #000;
            border-color: #333;
        }
        
        .btn-danger {
            background: #400;
            border-color: #600;
        }
        
        .btn-danger:hover {
            background: #600;
            border-color: #800;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #333;
            border-radius: 4px;
            font-size: 1rem;
            margin-top: 8px;
            font-family: 'Courier New', monospace;
            background: #000;
            color: #fff;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #555;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .header {
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .header h1 {
            text-align: center;
            font-size: 2em;
            letter-spacing: 3px;
            margin-bottom: 5px;
            text-shadow: 0 0 10px #fff;
        }
        
        .header p {
            text-align: center;
            color: #888;
            font-size: 0.9em;
            margin-bottom: 15px;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .header-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .timer-container {
            background: #0a0a0a;
            border: 1px solid #333;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .timer-box {
            background: #111;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #222;
        }
        
        @media (max-width: 600px) {
            .header-buttons {
                grid-template-columns: 1fr;
            }
            
            .timer-container {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        
        .post {
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .post:hover {
            border-color: #555;
            box-shadow: 0 0 10px rgba(255,255,255,0.1);
        }
        
        .post-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #fff;
        }
        
        .post-meta {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .post-content {
            color: #aaa;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .comment {
            background: #0a0a0a;
            border-left: 2px solid #333;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-content {
            background: #111;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 24px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content h2 {
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        
        .info-box {
            background: #001a33;
            border-left: 4px solid #0066cc;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .warning-box {
            background: #2a1a00;
            border-left: 4px solid #ff8800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .revealed-tag {
            display: inline-block;
            background: #600;
            color: #f88;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-left: 10px;
        }
        
        .known-identity {
            background: #004400;
            color: #8f8;
            padding: 8px 16px;
            border-radius: 4px;
            margin: 10px 5px 10px 0;
            display: inline-block;
        }
        
        .login-container {
            max-width: 500px;
            margin: 100px auto;
            padding: 20px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .login-header h1 {
            font-size: 2em;
            letter-spacing: 3px;
            margin-bottom: 10px;
        }
        
        .login-card {
            background: #111;
            border: 2px solid #333;
            padding: 30px;
            border-radius: 8px;
        }
        
        .login-card h2 {
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        
        .login-card label {
            display: block;
            color: #888;
            margin: 15px 0 5px;
        }
        
        label {
            display: block;
            color: #888;
            margin: 15px 0 5px;
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div id="splash">
        <img src="/mnt/user-data/uploads/1770935396330_image.png" alt="Anonymous">
        <h1>WE ARE ANONYMOUS</h1>
    </div>
    
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Firebase ÏÑ§Ï†ï
        const firebaseConfig = {
            apiKey: "AIzaSyAwW-4r34LivVZAB3Z4PtB_5BFeLFfS1s",
            authDomain: "ikmyeonggay.firebaseapp.com",
            databaseURL: "https://ikmyeonggay-default-rtdb.firebaseio.com",
            projectId: "ikmyeonggay",
            storageBucket: "ikmyeonggay.firebasestorage.app",
            messagingSenderId: "761175876587",
            appId: "1:761175876587:web:48b062812fc20d75b36fae",
            measurementId: "G-HDJB6TCZ2C"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Firebase Ïó∞Í≤∞ ÏÉÅÌÉú ÌôïÏù∏
        db.ref('.info/connected').on('value', (snap) => {
            if (snap.val() === true) {
                console.log('‚úÖ Firebase Ïó∞Í≤∞Îê®');
            } else {
                console.log('‚ùå Firebase Ïó∞Í≤∞ Ïïà Îê®');
            }
        });

        // 8Î™ÖÏùò Í≥ÑÏ†ï
        const ACCOUNTS = {
            'user1': { name: 'Í∞ïÏã†Ïö∞', password: btoa('Anon!2024#Kang') },
            'user2': { name: 'ÍπÄÎåÄÏõÖ', password: btoa('Shad0w@Kim!24') },
            'user3': { name: 'ÍπÄÎØºÍ∏∞', password: btoa('Dark#Mind2024!') },
            'user4': { name: 'ÍπÄÎØºÌò∏', password: btoa('Gh0st$Minho@') },
            'user5': { name: 'ÏÜ°ÎØºÏàò', password: btoa('Echo!Song#2024') },
            'user6': { name: 'ÏÜêÏùÑÏõÖ', password: btoa('Cipher@Son!24') },
            'user7': { name: 'ÍπÄÎ™ÖÏßÑ', password: btoa('Wraith#Kim2024') },
            'user8': { name: 'ÍπÄÏ∂©Ïó∞', password: btoa('Admin!@Ghost24') }
        };

        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [users, setUsers] = useState({});
            const [posts, setPosts] = useState([]);
            const [showWriteModal, setShowWriteModal] = useState(false);
            const [showPostModal, setShowPostModal] = useState(false);
            const [showGuessModal, setShowGuessModal] = useState(false);
            const [showNicknameModal, setShowNicknameModal] = useState(false);
            const [showPasswordModal, setShowPasswordModal] = useState(false);
            const [selectedPost, setSelectedPost] = useState(null);
            const [todayGuess, setTodayGuess] = useState(null);
            const [currentTime, setCurrentTime] = useState(Date.now());

            // 1Ï¥àÎßàÎã§ ÌòÑÏû¨ ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏ (ÌÉÄÏù¥Î®∏Ïö©)
            useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentTime(Date.now());
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            // Î°úÍ∑∏Ïù∏ Ï≤¥ÌÅ¨
            useEffect(() => {
                const userId = localStorage.getItem('userId');
                if (userId && ACCOUNTS[userId]) {
                    setCurrentUser({ userId, ...ACCOUNTS[userId] });
                    loadUserData(userId);
                }
            }, []);

            // ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            const loadUserData = (userId) => {
                db.ref('users').on('value', snap => {
                    const data = snap.val() || {};
                    setUsers(data);
                    
                    if (data[userId]) {
                        // 2ÏãúÍ∞ÑÎßàÎã§ ÏßÄÎ™©Í∂å ÏûêÎèô ÏßÄÍ∏â
                        const lastTicketTime = data[userId].lastGuessTicketTime || 0;
                        const now = Date.now();
                        const twoHours = 2 * 60 * 60 * 1000;
                        
                        if (now - lastTicketTime >= twoHours) {
                            const currentTickets = data[userId].guessTickets || 0;
                            db.ref(`users/${userId}`).update({
                                guessTickets: currentTickets + 1,
                                lastGuessTicketTime: now
                            });
                        }
                        
                        // 2ÏãúÍ∞Ñ Ï£ºÍ∏∞ Ï†ïÏ≤¥ Ï¥àÍ∏∞Ìôî Ï≤¥ÌÅ¨ (00:00, 02:00, 04:00, 06:00, 08:00, 10:00, 12:00, 14:00, 16:00, 18:00, 20:00, 22:00)
                        const lastIdentityReset = data[userId].lastIdentityReset || 0;
                        const koreaTime = new Date(now + (9 * 60 * 60 * 1000)); // ÌïúÍµ≠ ÏãúÍ∞Ñ
                        const currentHour = koreaTime.getUTCHours();
                        const currentTwoHourSlot = Math.floor(currentHour / 2); // 0~11 (00:00~02:00Îäî 0, 02:00~04:00Îäî 1...)
                        const slotStartTime = new Date(koreaTime.getUTCFullYear(), koreaTime.getUTCMonth(), koreaTime.getUTCDate(), currentTwoHourSlot * 2, 0, 0).getTime() - (9 * 60 * 60 * 1000);
                        
                        if (lastIdentityReset < slotStartTime) {
                            // Ï†ïÏ≤¥ Ï†ïÎ≥¥ Ï¥àÍ∏∞Ìôî (Î≥∏Ïù∏Ïù¥ ÏïåÍ≥† ÏûàÎäî Ï†ïÎ≥¥Îßå)
                            db.ref(`users/${userId}`).update({
                                lastIdentityReset: now,
                                alreadyGuessedCorrect: []  // ÎßûÏ∂ò ÏÇ¨Îûå Î™©Î°ù Ï¥àÍ∏∞Ìôî
                            });
                            
                            // Î™®Îì† ÏÇ¨Ïö©ÏûêÏùò revealedToÏóêÏÑú ÌòÑÏû¨ ÏÇ¨Ïö©Ïûê Ï†úÍ±∞
                            Object.keys(data).forEach(uid => {
                                if (data[uid].revealedTo && data[uid].revealedTo.includes(userId)) {
                                    const newRevealedTo = data[uid].revealedTo.filter(id => id !== userId);
                                    db.ref(`users/${uid}/revealedTo`).set(newRevealedTo);
                                }
                            });
                        }
                    }
                });

                // Ïò§ÎäòÏùò ÏßÄÎ™© ÌôïÏù∏ Ï†úÍ±∞ (Ïù¥Ï†ú ÏßÄÎ™©Í∂å ÏãúÏä§ÌÖú ÏÇ¨Ïö©)
                setTodayGuess(null);
            };

            // Í≤åÏãúÍ∏Ä Î°úÎìú
            useEffect(() => {
                db.ref('posts').on('value', snap => {
                    const data = snap.val();
                    if (data) {
                        const arr = Object.keys(data).map(k => ({
                            id: k,
                            ...data[k]
                        })).sort((a, b) => b.timestamp - a.timestamp);
                        setPosts(arr);
                    } else {
                        setPosts([]);
                    }
                });
            }, []);

            // ÎãâÎÑ§ÏûÑ ÎØ∏ÏÑ§Ï†ï Ïãú ÏûêÎèô Î™®Îã¨
            useEffect(() => {
                if (currentUser && users[currentUser.userId]) {
                    if (!users[currentUser.userId].nickname) {
                        setShowNicknameModal(true);
                    }
                }
            }, [currentUser, users]);

            // Î°úÍ∑∏Ïù∏
            const login = (userId, password) => {
                if (!ACCOUNTS[userId]) {
                    alert('Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî Í≥ÑÏ†ïÏûÖÎãàÎã§!');
                    return;
                }
                
                // FirebaseÏóêÏÑú ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏
                db.ref(`users/${userId}/password`).once('value').then(snap => {
                    const savedPassword = snap.val() || ACCOUNTS[userId].password;
                    
                    if (savedPassword !== btoa(password)) {
                        alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ†∏ÏäµÎãàÎã§!');
                        return;
                    }

                    localStorage.setItem('userId', userId);
                    setCurrentUser({ userId, ...ACCOUNTS[userId] });
                    loadUserData(userId);

                    // ÏÇ¨Ïö©Ïûê Ï¥àÍ∏∞Ìôî (ÏóÜÏúºÎ©¥ ÏÉùÏÑ±)
                    db.ref(`users/${userId}`).once('value').then(snap => {
                        if (!snap.val()) {
                            console.log('ÏÉà ÏÇ¨Ïö©Ïûê ÏÉùÏÑ±:', userId);
                            return db.ref(`users/${userId}`).set({
                                name: ACCOUNTS[userId].name,
                                nickname: '',
                                nicknameChangedAt: 0,
                                nicknameChangeTickets: 0,
                                guessTickets: 1,
                                lastGuessTicketTime: Date.now(),
                                lastIdentityReset: Date.now(),
                                alreadyGuessedCorrect: [],
                                revealedTo: [],
                                isPubliclyRevealed: false,
                                password: ACCOUNTS[userId].password
                            }).then(() => {
                                setShowNicknameModal(true);
                            });
                        } else {
                            console.log('Í∏∞Ï°¥ ÏÇ¨Ïö©Ïûê Î°úÎìú:', userId);
                            // Í∏∞Ï°¥ ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÌïÑÎìúÍ∞Ä ÏóÜÏúºÎ©¥ Ï∂îÍ∞Ä
                            if (snap.val().nicknameChangeTickets === undefined) {
                                db.ref(`users/${userId}/nicknameChangeTickets`).set(0);
                            }
                            if (snap.val().guessTickets === undefined) {
                                db.ref(`users/${userId}/guessTickets`).set(1);
                            }
                            if (snap.val().lastGuessTicketTime === undefined) {
                                db.ref(`users/${userId}/lastGuessTicketTime`).set(Date.now());
                            }
                            if (snap.val().lastIdentityReset === undefined) {
                                db.ref(`users/${userId}/lastIdentityReset`).set(Date.now());
                            }
                            if (snap.val().alreadyGuessedCorrect === undefined) {
                                db.ref(`users/${userId}/alreadyGuessedCorrect`).set([]);
                            }
                            if (!snap.val().nickname || snap.val().nickname === '') {
                                setShowNicknameModal(true);
                            }
                        }
                    }).catch(error => {
                        console.error('ÏÇ¨Ïö©Ïûê Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
                        alert('Firebase Ïó∞Í≤∞ Ïã§Ìå®!\n\n' + error.message + '\n\nFirebase Í∑úÏπôÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî!');
                    });
                }).catch(error => {
                    console.error('Î°úÍ∑∏Ïù∏ Ïã§Ìå®:', error);
                    alert('Î°úÍ∑∏Ïù∏ Ïã§Ìå®: ' + error.message);
                });
            };

            // Î°úÍ∑∏ÏïÑÏõÉ
            const logout = () => {
                localStorage.removeItem('userId');
                setCurrentUser(null);
            };

            // ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω Í∞ÄÎä• Ïó¨Î∂Ä ÌôïÏù∏ (Ìã∞Ïºì ÏûàÏúºÎ©¥ Ìï≠ÏÉÅ Í∞ÄÎä•, ÏóÜÏúºÎ©¥ 2ÏãúÍ∞ÑÎßàÎã§)
            const canChangeNickname = () => {
                if (!currentUser || !users[currentUser.userId]) return false;
                
                // Ìã∞ÏºìÏù¥ ÏûàÏúºÎ©¥ Î¨¥Ï°∞Í±¥ Í∞ÄÎä•
                const tickets = users[currentUser.userId].nicknameChangeTickets || 0;
                if (tickets > 0) return true;
                
                // Ìã∞ÏºìÏù¥ ÏóÜÏúºÎ©¥ 2ÏãúÍ∞Ñ Ï†úÌïú
                const lastChanged = users[currentUser.userId].nicknameChangedAt || 0;
                const now = Date.now();
                const twoHours = 2 * 60 * 60 * 1000; // 2ÏãúÍ∞Ñ
                return now - lastChanged >= twoHours;
            };

            // ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω
            const changeNickname = (newNickname) => {
                if (!newNickname.trim()) {
                    alert('ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî!');
                    return;
                }
                
                const tickets = users[currentUser.userId].nicknameChangeTickets || 0;
                const updates = {
                    nickname: newNickname.trim(),
                    nicknameChangedAt: Date.now(),
                    revealedTo: [],  // Ï†ïÏ≤¥ Ï†ïÎ≥¥ Ï¥àÍ∏∞Ìôî
                    isPubliclyRevealed: false,  // Í≥µÍ∞ú ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
                    alreadyGuessedCorrect: []  // ÎßûÏ∂ò ÏÇ¨Îûå Î™©Î°ù Ï¥àÍ∏∞Ìôî
                };
                
                // Ìã∞ÏºìÏù¥ ÏûàÏúºÎ©¥ ÏÜåÎ™®
                if (tickets > 0) {
                    updates.nicknameChangeTickets = tickets - 1;
                }
                
                db.ref(`users/${currentUser.userId}`).update(updates);
                
                // Îã§Î•∏ Î™®Îì† ÏÇ¨Ïö©ÏûêÏùò alreadyGuessedCorrectÏóêÏÑú ÎÇ¥ userId Ï†úÍ±∞
                Object.keys(users).forEach(uid => {
                    if (uid !== currentUser.userId && users[uid].alreadyGuessedCorrect) {
                        const alreadyGuessed = users[uid].alreadyGuessedCorrect;
                        if (alreadyGuessed.includes(currentUser.userId)) {
                            const newList = alreadyGuessed.filter(id => id !== currentUser.userId);
                            db.ref(`users/${uid}/alreadyGuessedCorrect`).set(newList);
                        }
                    }
                });
                
                setShowNicknameModal(false);
                
                if (tickets > 0) {
                    alert(`ÎãâÎÑ§ÏûÑÏù¥ ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§! (Î≥ÄÍ≤ΩÍ∂å ${tickets - 1}Í∞ú ÎÇ®Ïùå)\nÏ†ïÏ≤¥Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏñ¥ Îã§Ïãú ÏùµÎ™Ö ÏÉÅÌÉúÍ∞Ä ÎêòÏóàÏäµÎãàÎã§!`);
                } else {
                    alert('ÎãâÎÑ§ÏûÑÏù¥ ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§!\nÏ†ïÏ≤¥Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏñ¥ Îã§Ïãú ÏùµÎ™Ö ÏÉÅÌÉúÍ∞Ä ÎêòÏóàÏäµÎãàÎã§!');
                }
            };

            // ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω
            const changePassword = (currentPassword, newPassword, confirmPassword) => {
                // ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏
                db.ref(`users/${currentUser.userId}/password`).once('value').then(snap => {
                    const savedPassword = snap.val() || ACCOUNTS[currentUser.userId].password;
                    
                    if (btoa(currentPassword) !== savedPassword) {
                        alert('ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§!');
                        return;
                    }
                    
                    if (!newPassword || newPassword.length < 8) {
                        alert('ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 8Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§!');
                        return;
                    }
                    
                    if (newPassword !== confirmPassword) {
                        alert('ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§!');
                        return;
                    }
                    
                    // ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω
                    db.ref(`users/${currentUser.userId}`).update({
                        password: btoa(newPassword)
                    }).then(() => {
                        setShowPasswordModal(false);
                        alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§!');
                    });
                });
            };

            // ÏßÄÎ™©ÌïòÍ∏∞
            const makeGuess = (targetUserId) => {
                if (targetUserId === currentUser.userId) {
                    alert('ÏûêÍ∏∞ ÏûêÏã†ÏùÄ ÏßÄÎ™©Ìï† Ïàò ÏóÜÏäµÎãàÎã§!');
                    return;
                }

                const guessTickets = users[currentUser.userId].guessTickets || 0;
                if (guessTickets <= 0) {
                    alert('ÏßÄÎ™©Í∂åÏù¥ ÏóÜÏäµÎãàÎã§! 2ÏãúÍ∞ÑÎßàÎã§ 1Í∞úÏî© ÏßÄÍ∏âÎê©ÎãàÎã§.');
                    return;
                }

                const selectedUser = document.getElementById('guessSelect').value;

                if (!selectedUser) {
                    alert('Ï∂îÏ∏°Ìï† ÏÇ¨ÎûåÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!');
                    return;
                }

                const correct = selectedUser === targetUserId;

                if (correct) {
                    // ÎßûÏ∂§: ÌÉÄÍ≤üÏùò Ï†ïÏ≤¥Î•º ÎÇòÏóêÍ≤åÎßå Í≥µÍ∞ú, ÏßÄÎ™©Í∂å Ïú†ÏßÄ
                    db.ref(`users/${targetUserId}/revealedTo`).once('value', snap => {
                        const revealedTo = snap.val() || [];
                        if (!revealedTo.includes(currentUser.userId)) {
                            revealedTo.push(currentUser.userId);
                            db.ref(`users/${targetUserId}/revealedTo`).set(revealedTo);
                        }
                    });
                    
                    // Ïù¥ÎØ∏ ÎßûÏ∂ò ÏÇ¨Îûå Î™©Î°ùÏóê Ï∂îÍ∞Ä
                    db.ref(`users/${currentUser.userId}/alreadyGuessedCorrect`).once('value', snap => {
                        const alreadyGuessed = snap.val() || [];
                        if (!alreadyGuessed.includes(targetUserId)) {
                            alreadyGuessed.push(targetUserId);
                            db.ref(`users/${currentUser.userId}/alreadyGuessedCorrect`).set(alreadyGuessed);
                        }
                    });
                    
                    // ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤ΩÍ∂å 2Ïû• Ï∂îÍ∞Ä
                    db.ref(`users/${currentUser.userId}/nicknameChangeTickets`).once('value', snap => {
                        const currentTickets = snap.val() || 0;
                        db.ref(`users/${currentUser.userId}/nicknameChangeTickets`).set(currentTickets + 2);
                    });
                    
                    alert(`Ï†ïÎãµÏûÖÎãàÎã§! ${ACCOUNTS[targetUserId].name}ÎãòÏùò Ï†ïÏ≤¥Î•º ÏïåÍ≤å ÎêòÏóàÏäµÎãàÎã§!\nÎãâÎÑ§ÏûÑ Î≥ÄÍ≤ΩÍ∂å 2Ïû•ÏùÑ ÌöçÎìùÌñàÏäµÎãàÎã§!\nÏßÄÎ™©Í∂åÏùÄ ÏÜåÎ™®ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.`);
                } else {
                    // ÌãÄÎ¶º: ÎÇ¥ Ï†ïÏ≤¥Î•º Ï†ÑÏ≤¥ Í≥µÍ∞ú, ÏßÄÎ™©Í∂å ÏÜåÎ™®
                    db.ref(`users/${currentUser.userId}`).update({
                        isPubliclyRevealed: true,
                        guessTickets: guessTickets - 1
                    });
                    alert(`ÌãÄÎ†∏ÏäµÎãàÎã§! ÎãπÏã†Ïùò Ï†ïÏ≤¥Í∞Ä Î™®ÎëêÏóêÍ≤å Í≥µÍ∞úÎê©ÎãàÎã§!\nÏßÄÎ™©Í∂å 1Í∞úÍ∞Ä ÏÜåÎ™®ÎêòÏóàÏäµÎãàÎã§. (ÎÇ®ÏùÄ ÏßÄÎ™©Í∂å: ${guessTickets - 1}Í∞ú)`);
                }

                setShowGuessModal(false);
            };

            // Í≤åÏãúÍ∏Ä ÏûëÏÑ±
            const writePost = (title, content) => {
                if (!title.trim() || !content.trim()) {
                    alert('Ï†úÎ™©Í≥º ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî!');
                    return;
                }

                const currentNickname = users[currentUser.userId]?.nickname || '';
                if (!currentNickname) {
                    alert('ÎãâÎÑ§ÏûÑÏùÑ Î®ºÏ†Ä ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî!');
                    setShowWriteModal(false);
                    setShowNicknameModal(true);
                    return;
                }

                const postId = Date.now().toString();

                db.ref(`posts/${postId}`).set({
                    authorId: currentUser.userId,
                    nickname: currentNickname,
                    title: title.trim(),
                    content: content.trim(),
                    timestamp: Date.now()
                }).then(() => {
                    setShowWriteModal(false);
                    alert('Í≤åÏãúÍ∏ÄÏù¥ ÏûëÏÑ±ÎêòÏóàÏäµÎãàÎã§!');
                }).catch((error) => {
                    alert('Í≤åÏãúÍ∏Ä ÏûëÏÑ± Ïã§Ìå®: ' + error.message);
                });
            };

            // ÎåìÍ∏Ä ÏûëÏÑ±
            const writeComment = (postId, content) => {
                if (!content.trim()) {
                    alert('ÎåìÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî!');
                    return;
                }

                const currentNickname = users[currentUser.userId]?.nickname || '';
                if (!currentNickname) {
                    alert('ÎãâÎÑ§ÏûÑÏùÑ Î®ºÏ†Ä ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî!');
                    setShowPostModal(false);
                    setShowNicknameModal(true);
                    return;
                }

                const commentId = Date.now().toString();

                db.ref(`posts/${postId}/comments/${commentId}`).set({
                    authorId: currentUser.userId,
                    nickname: currentNickname,
                    content: content.trim(),
                    timestamp: Date.now()
                }).then(() => {
                    console.log('ÎåìÍ∏Ä ÏûëÏÑ± ÏÑ±Í≥µ!');
                }).catch((error) => {
                    alert('ÎåìÍ∏Ä ÏûëÏÑ± Ïã§Ìå®: ' + error.message);
                });
            };

            // Ï¥àÍ∏∞Ìôî (ÍπÄÏ∂©Ïó∞Îßå)
            const resetAllData = () => {
                if (currentUser.userId !== 'user8') {
                    alert('Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§!');
                    return;
                }
                if (!confirm('Ï†ïÎßêÎ°ú Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
                if (!confirm('Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§!')) return;
                
                db.ref('posts').remove();
                db.ref('users').remove();
                db.ref('guesses').remove();
                alert('Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.');
                logout();
            };

            // ÎÇ¥Í∞Ä ÏïåÍ≥† ÏûàÎäî Ï†ïÏ≤¥Îì§
            const getKnownIdentities = () => {
                if (!currentUser) return [];
                const known = [];
                Object.keys(users).forEach(uid => {
                    const user = users[uid];
                    if (user.isPubliclyRevealed) {
                        known.push({ userId: uid, name: ACCOUNTS[uid].name, type: 'public' });
                    } else if (user.revealedTo && user.revealedTo.includes(currentUser.userId)) {
                        known.push({ userId: uid, name: ACCOUNTS[uid].name, type: 'private' });
                    }
                });
                return known;
            };

            // ÎÇ®ÏùÄ ÏãúÍ∞Ñ Ìè¨Îß∑ (Ïãú:Î∂Ñ:Ï¥à)
            const formatTimeRemaining = (milliseconds) => {
                if (milliseconds <= 0) return 'Í∞±Ïã† Í∞ÄÎä•';
                
                const totalSeconds = Math.floor(milliseconds / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            };

            // ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω ÌÉÄÏù¥Î®∏
            const getNicknameChangeTimer = () => {
                if (!currentUser || !users[currentUser.userId]) return 'Í≥ÑÏÇ∞Ï§ë...';
                const tickets = users[currentUser.userId].nicknameChangeTickets || 0;
                if (tickets > 0) return 'Î≥ÄÍ≤ΩÍ∂å Î≥¥Ïú†';
                
                const lastChanged = users[currentUser.userId].nicknameChangedAt || 0;
                const twoHours = 2 * 60 * 60 * 1000;
                const nextChangeTime = lastChanged + twoHours;
                const remaining = nextChangeTime - currentTime;
                
                return formatTimeRemaining(remaining);
            };

            // ÏßÄÎ™©Í∂å ÌÉÄÏù¥Î®∏
            const getGuessTicketTimer = () => {
                if (!currentUser || !users[currentUser.userId]) return 'Í≥ÑÏÇ∞Ï§ë...';
                
                const lastTicketTime = users[currentUser.userId].lastGuessTicketTime || 0;
                const twoHours = 2 * 60 * 60 * 1000;
                const nextTicketTime = lastTicketTime + twoHours;
                const remaining = nextTicketTime - currentTime;
                
                return formatTimeRemaining(remaining);
            };

            // Ï†ïÏ≤¥ Ï¥àÍ∏∞Ìôî ÌÉÄÏù¥Î®∏ (00:00, 02:00, 04:00, ...)
            const getIdentityResetTimer = () => {
                const now = currentTime;
                const koreaTime = new Date(now + (9 * 60 * 60 * 1000)); // ÌïúÍµ≠ ÏãúÍ∞Ñ
                const currentHour = koreaTime.getUTCHours();
                const currentMinute = koreaTime.getUTCMinutes();
                const currentSecond = koreaTime.getUTCSeconds();
                
                // Îã§Ïùå 2ÏãúÍ∞Ñ Ïä¨Î°Ø Í≥ÑÏÇ∞
                const nextSlotHour = Math.ceil((currentHour + 1) / 2) * 2;
                const hoursUntilNext = (nextSlotHour - currentHour - 1 + 24) % 24;
                const minutesUntilNext = 60 - currentMinute;
                const secondsUntilNext = 60 - currentSecond;
                
                const totalSeconds = hoursUntilNext * 3600 + minutesUntilNext * 60 + secondsUntilNext;
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            };

            if (!currentUser) {
                return <LoginScreen onLogin={login} />;
            }

            const myNickname = users[currentUser.userId]?.nickname || '';
            const knownIdentities = getKnownIdentities();
            const nicknameTickets = users[currentUser.userId]?.nicknameChangeTickets || 0;
            const guessTickets = users[currentUser.userId]?.guessTickets || 0;

            return (
                <div className="container">
                    <div className="header">
                        <h1>ANONYMOUS BOARD</h1>
                        <p>We do not forgive. We do not forget. Expect us.</p>
                        <div className="header-top">
                            <span style={{color: users[currentUser.userId]?.isPubliclyRevealed ? '#f88' : '#8f8'}}>
                                {users[currentUser.userId]?.isPubliclyRevealed 
                                    ? `‚ö† ÎãπÏã†Ïùò Ï†ïÏ≤¥Îäî Í≥µÍ∞úÎêòÏóàÏäµÎãàÎã§ (Ïã§Î™Ö: ${currentUser.name})`
                                    : `‚úì ÎãπÏã†Ïùò Ï†ïÏ≤¥Îäî ÏïàÏ†ÑÌï©ÎãàÎã§ (Ïã§Î™Ö: ${currentUser.name})`
                                }
                            </span>
                        </div>
                        <div className="timer-container">
                            <div className="timer-box">
                                <div style={{color: '#8f8', marginBottom: '5px', fontWeight: 'bold'}}>
                                    üé´ ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤ΩÍ∂å: {nicknameTickets}Í∞ú
                                </div>
                                <div style={{color: '#888', fontSize: '0.85em'}}>
                                    Îã§Ïùå Í∞±Ïã†: {getNicknameChangeTimer()}
                                </div>
                            </div>
                            <div className="timer-box">
                                <div style={{color: guessTickets > 0 ? '#8f8' : '#f88', marginBottom: '5px', fontWeight: 'bold'}}>
                                    üéØ ÏßÄÎ™©Í∂å: {guessTickets}Í∞ú
                                </div>
                                <div style={{color: '#888', fontSize: '0.85em'}}>
                                    Îã§Ïùå Í∞±Ïã†: {getGuessTicketTimer()}
                                </div>
                            </div>
                        </div>
                        <div style={{
                            background: '#0a0a0a',
                            border: '1px solid #333',
                            padding: '12px',
                            marginBottom: '15px',
                            borderRadius: '4px',
                            textAlign: 'center'
                        }}>
                            <div style={{color: '#8f8', marginBottom: '3px', fontWeight: 'bold'}}>
                                üîÑ Ï†ïÏ≤¥ Ï†ïÎ≥¥ Ï¥àÍ∏∞Ìôî
                            </div>
                            <div style={{color: '#888', fontSize: '0.85em'}}>
                                Îã§Ïùå Ï¥àÍ∏∞Ìôî: {getIdentityResetTimer()} (2ÏãúÍ∞ÑÎßàÎã§)
                            </div>
                        </div>
                        <div className="header-buttons">
                            <button className="btn" onClick={() => setShowNicknameModal(true)}>
                                ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω
                            </button>
                            <button className="btn" onClick={() => setShowPasswordModal(true)}>
                                ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω
                            </button>
                            <button 
                                className="btn" 
                                onClick={() => setShowGuessModal(true)}
                                disabled={guessTickets <= 0}
                            >
                                {guessTickets > 0 ? 'ÏßÄÎ™©ÌïòÍ∏∞' : 'ÏßÄÎ™©Í∂å ÏóÜÏùå'}
                            </button>
                            <button className="btn btn-secondary" onClick={logout}>
                                Î°úÍ∑∏ÏïÑÏõÉ
                            </button>
                        </div>
                        {currentUser.userId === 'user8' && (
                            <button 
                                className="btn btn-danger" 
                                onClick={resetAllData}
                                style={{marginTop: '10px'}}
                            >
                                üóë Î™®Îì† Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî (Í¥ÄÎ¶¨Ïûê Ï†ÑÏö©)
                            </button>
                        )}
                    </div>

                    {knownIdentities.length > 0 && (
                        <div className="card">
                            <h3 style={{marginBottom: '15px'}}>üîç ÎÇ¥Í∞Ä ÏïåÍ≥† ÏûàÎäî Ï†ïÏ≤¥Îì§</h3>
                            {knownIdentities.map(k => (
                                <span key={k.userId} className="known-identity">
                                    {users[k.userId]?.nickname || '???'} = {k.name}
                                    {k.type === 'public' && ' (Ï†ÑÏ≤¥Í≥µÍ∞ú)'}
                                </span>
                            ))}
                        </div>
                    )}

                    <button className="btn" onClick={() => setShowWriteModal(true)}>
                        ÏÉà Í∏Ä ÏûëÏÑ±
                    </button>

                    <div>
                        {posts.map(post => {
                            const author = users[post.authorId];
                            const isRevealed = author?.isPubliclyRevealed || 
                                             (author?.revealedTo && author.revealedTo.includes(currentUser.userId));
                            const displayName = isRevealed 
                                ? `${post.nickname} (${ACCOUNTS[post.authorId]?.name})`
                                : post.nickname;

                            const comments = post.comments ? Object.values(post.comments).sort((a, b) => a.timestamp - b.timestamp) : [];
                            const recentComments = comments.slice(-2); // ÏµúÍ∑º 2Í∞ú

                            return (
                                <div 
                                    key={post.id} 
                                    className="post"
                                    onClick={() => {
                                        setSelectedPost(post);
                                        setShowPostModal(true);
                                    }}
                                >
                                    <div className="post-title">{post.title}</div>
                                    <div className="post-meta">
                                        ÏûëÏÑ±Ïûê: {displayName}
                                        {isRevealed && <span className="revealed-tag">Ï†ïÏ≤¥Í≥µÍ∞ú</span>}
                                        {' ‚Ä¢ '}
                                        {new Date(post.timestamp).toLocaleString('ko-KR')}
                                    </div>
                                    <div className="post-content">
                                        {post.content.length > 100 
                                            ? post.content.substring(0, 100) + '...'
                                            : post.content
                                        }
                                    </div>
                                    {comments.length > 0 && (
                                        <div style={{
                                            marginTop: '15px',
                                            padding: '10px',
                                            background: '#0a0a0a',
                                            borderLeft: '2px solid #333',
                                            borderRadius: '4px'
                                        }}>
                                            <div style={{color: '#888', fontSize: '0.9rem', marginBottom: '8px'}}>
                                                üí¨ ÎåìÍ∏Ä {comments.length}Í∞ú
                                            </div>
                                            {recentComments.map(comment => {
                                                const cAuthor = users[comment.authorId];
                                                const cIsRevealed = cAuthor?.isPubliclyRevealed || 
                                                                  (cAuthor?.revealedTo && cAuthor.revealedTo.includes(currentUser.userId));
                                                const cDisplayName = cIsRevealed 
                                                    ? `${comment.nickname} (${ACCOUNTS[comment.authorId]?.name})`
                                                    : comment.nickname;

                                                return (
                                                    <div key={comment.timestamp} style={{
                                                        color: '#777',
                                                        fontSize: '0.85rem',
                                                        padding: '5px 0',
                                                        borderBottom: '1px solid #111'
                                                    }}>
                                                        <span style={{color: '#999', fontWeight: 'bold'}}>
                                                            {cDisplayName}:
                                                        </span> {comment.content.length > 50 ? comment.content.substring(0, 50) + '...' : comment.content}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>

                    {showWriteModal && (
                        <WriteModal 
                            onClose={() => setShowWriteModal(false)}
                            onSubmit={writePost}
                        />
                    )}

                    {showPostModal && selectedPost && (
                        <PostModal 
                            post={selectedPost}
                            users={users}
                            currentUser={currentUser}
                            ACCOUNTS={ACCOUNTS}
                            onClose={() => setShowPostModal(false)}
                            onComment={writeComment}
                        />
                    )}

                    {showGuessModal && (
                        <GuessModal 
                            users={users}
                            currentUser={currentUser}
                            ACCOUNTS={ACCOUNTS}
                            onClose={() => setShowGuessModal(false)}
                            onSubmit={makeGuess}
                        />
                    )}

                    {showNicknameModal && (
                        <NicknameModal 
                            currentNickname={myNickname}
                            canChange={canChangeNickname()}
                            tickets={nicknameTickets}
                            onClose={() => myNickname ? setShowNicknameModal(false) : null}
                            onSubmit={changeNickname}
                        />
                    )}

                    {showPasswordModal && (
                        <PasswordModal 
                            onClose={() => setShowPasswordModal(false)}
                            onSubmit={changePassword}
                        />
                    )}
                </div>
            );
        }

        function LoginScreen({ onLogin }) {
            const [userId, setUserId] = useState('');
            const [password, setPassword] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                onLogin(userId, password);
            };

            return (
                <div className="login-container">
                    <div className="login-header">
                        <h1>ANONYMOUS LOGIN</h1>
                    </div>
                    <div className="login-card">
                        <h2>Î°úÍ∑∏Ïù∏</h2>
                        <form onSubmit={handleSubmit}>
                            <label>ÏïÑÏù¥Îîî</label>
                            <input 
                                type="text" 
                                value={userId}
                                onChange={(e) => setUserId(e.target.value)}
                                placeholder="ÏïÑÏù¥ÎîîÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                            />
                            <label>ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                            <input 
                                type="password"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                            />
                            <button type="submit" className="btn" style={{marginTop: '15px'}}>
                                Î°úÍ∑∏Ïù∏
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        function WriteModal({ onClose, onSubmit }) {
            const [title, setTitle] = useState('');
            const [content, setContent] = useState('');

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>ÏÉà Í∏Ä ÏûëÏÑ±</h2>
                        <label>Ï†úÎ™©</label>
                        <input 
                            type="text"
                            value={title}
                            onChange={(e) => setTitle(e.target.value)}
                            placeholder="Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                        />
                        <label>ÎÇ¥Ïö©</label>
                        <textarea 
                            value={content}
                            onChange={(e) => setContent(e.target.value)}
                            placeholder="ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                        />
                        <button 
                            className="btn" 
                            onClick={() => onSubmit(title, content)}
                            style={{marginTop: '15px'}}
                        >
                            Í≤åÏãú
                        </button>
                        <button 
                            className="btn btn-secondary" 
                            onClick={onClose}
                        >
                            Ï∑®ÏÜå
                        </button>
                    </div>
                </div>
            );
        }

        function PostModal({ post, users, currentUser, ACCOUNTS, onClose, onComment }) {
            const [commentContent, setCommentContent] = useState('');
            const comments = post.comments ? Object.values(post.comments).sort((a, b) => a.timestamp - b.timestamp) : [];

            const author = users[post.authorId];
            const isRevealed = author?.isPubliclyRevealed || 
                             (author?.revealedTo && author.revealedTo.includes(currentUser.userId));
            const displayName = isRevealed 
                ? `${post.nickname} (${ACCOUNTS[post.authorId]?.name})`
                : post.nickname;

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>{post.title}</h2>
                        <div className="post-meta" style={{marginBottom: '15px'}}>
                            ÏûëÏÑ±Ïûê: {displayName}
                            {isRevealed && <span className="revealed-tag">Ï†ïÏ≤¥Í≥µÍ∞ú</span>}
                            <br />
                            {new Date(post.timestamp).toLocaleString('ko-KR')}
                        </div>
                        <div className="post-content" style={{marginBottom: '20px'}}>
                            {post.content}
                        </div>

                        <h3 style={{marginTop: '20px', marginBottom: '10px'}}>
                            ÎåìÍ∏Ä {comments.length}Í∞ú
                        </h3>
                        {comments.map(comment => {
                            const cAuthor = users[comment.authorId];
                            const cIsRevealed = cAuthor?.isPubliclyRevealed || 
                                              (cAuthor?.revealedTo && cAuthor.revealedTo.includes(currentUser.userId));
                            const cDisplayName = cIsRevealed 
                                ? `${comment.nickname} (${ACCOUNTS[comment.authorId]?.name})`
                                : comment.nickname;

                            return (
                                <div key={comment.timestamp} className="comment">
                                    <div style={{fontSize: '0.9rem', color: '#666', marginBottom: '5px'}}>
                                        {cDisplayName}
                                        {cIsRevealed && <span className="revealed-tag">Ï†ïÏ≤¥Í≥µÍ∞ú</span>}
                                        {' ‚Ä¢ '}
                                        {new Date(comment.timestamp).toLocaleString('ko-KR')}
                                    </div>
                                    <div style={{color: '#aaa'}}>{comment.content}</div>
                                </div>
                            );
                        })}

                        <textarea 
                            value={commentContent}
                            onChange={(e) => setCommentContent(e.target.value)}
                            placeholder="ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                            style={{marginTop: '15px'}}
                        />
                        <button 
                            className="btn" 
                            onClick={() => {
                                onComment(post.id, commentContent);
                                setCommentContent('');
                            }}
                            style={{marginTop: '10px'}}
                        >
                            ÎåìÍ∏Ä ÏûëÏÑ±
                        </button>
                        <button 
                            className="btn btn-secondary" 
                            onClick={onClose}
                        >
                            Îã´Í∏∞
                        </button>
                    </div>
                </div>
            );
        }

        function GuessModal({ users, currentUser, ACCOUNTS, onClose, onSubmit }) {
            const [targetUser, setTargetUser] = useState('');
            const guessTickets = users[currentUser.userId]?.guessTickets || 0;
            const alreadyGuessed = users[currentUser.userId]?.alreadyGuessedCorrect || [];

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>ÎàÑÍµ∞Í∞ÄÏùò Ï†ïÏ≤¥Î•º ÏßÄÎ™©ÌïòÍ∏∞ üéØ</h2>
                        
                        <div className="info-box">
                            üí° Î≥¥Ïú† ÏßÄÎ™©Í∂å: {guessTickets}Í∞ú<br/>
                            ‚Ä¢ ÏÑ±Í≥µ Ïãú: Ï†ïÏ≤¥ Í≥µÍ∞ú + ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤ΩÍ∂å 2Í∞ú + ÏßÄÎ™©Í∂å Ïú†ÏßÄ<br/>
                            ‚Ä¢ Ïã§Ìå® Ïãú: Î≥∏Ïù∏ Ï†ïÏ≤¥ Í≥µÍ∞ú + ÏßÄÎ™©Í∂å 1Í∞ú ÏÜåÎ™®
                        </div>
                        
                        <div className="warning-box">
                            <h4>‚ö† Ï£ºÏùò!</h4>
                            <ul style={{listStyle: 'none', padding: 0}}>
                                <li>‚Ä¢ ÏßÄÎ™©Í∂åÏùÄ 2ÏãúÍ∞ÑÎßàÎã§ 1Í∞úÏî© ÏûêÎèô ÏßÄÍ∏âÎê©ÎãàÎã§</li>
                                <li>‚Ä¢ ÏÑ±Í≥µÌïòÎ©¥ ÏßÄÎ™©Í∂åÏù¥ ÏÜåÎ™®ÎêòÏßÄ ÏïäÏäµÎãàÎã§</li>
                                <li>‚Ä¢ ÌãÄÎ¶¨Î©¥ ÎãπÏã†Ïùò Ï†ïÏ≤¥Í∞Ä Î™®ÎëêÏóêÍ≤å Í≥µÍ∞úÎê©ÎãàÎã§!</li>
                                <li>‚Ä¢ Ïù¥ÎØ∏ Ï†ïÏ≤¥Í∞Ä ÌÉÑÎ°úÎÇú ÏÇ¨ÎûåÏùÄ ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω Ï†ÑÍπåÏßÄ ÏßÄÎ™© Î∂àÍ∞Ä</li>
                                <li>‚Ä¢ Ïù¥ÎØ∏ ÎßûÏ∂ò ÏÇ¨ÎûåÏùÄ ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω Ï†ÑÍπåÏßÄ Ïû¨ÏßÄÎ™© Î∂àÍ∞Ä</li>
                                <li>‚Ä¢ 2ÏãúÍ∞ÑÎßàÎã§ ÎÇ¥Í∞Ä ÏïåÍ≥† ÏûàÎäî Ï†ïÏ≤¥ Ï†ïÎ≥¥Í∞Ä Ï¥àÍ∏∞ÌôîÎê©ÎãàÎã§</li>
                            </ul>
                        </div>

                        <label>ÏßÄÎ™©Ìï† ÏÇ¨ÎûåÏùò ÎãâÎÑ§ÏûÑ</label>
                        <select value={targetUser} onChange={(e) => setTargetUser(e.target.value)}>
                            <option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                            {Object.keys(users)
                                .filter(uid => 
                                    uid !== currentUser.userId && 
                                    users[uid].nickname && 
                                    users[uid].nickname.trim() !== '' &&
                                    !users[uid].isPubliclyRevealed &&  // Ï†ïÏ≤¥Í∞Ä ÌÉÑÎ°úÎÇú ÏÇ¨Îûå Ï†úÏô∏
                                    !alreadyGuessed.includes(uid)  // Ïù¥ÎØ∏ ÎßûÏ∂ò ÏÇ¨Îûå Ï†úÏô∏
                                )
                                .map(uid => (
                                    <option key={uid} value={uid}>
                                        {users[uid].nickname}
                                    </option>
                                ))
                            }
                        </select>
                        
                        {/* ÏßÄÎ™© Î∂àÍ∞ÄÎä•Ìïú ÏÇ¨ÎûåÎì§ ÌëúÏãú */}
                        {(Object.keys(users).filter(uid => uid !== currentUser.userId && users[uid].isPubliclyRevealed).length > 0 ||
                          alreadyGuessed.length > 0) && (
                            <div style={{
                                marginTop: '10px',
                                padding: '10px',
                                background: '#1a0a00',
                                border: '1px solid #442200',
                                borderRadius: '4px',
                                fontSize: '0.85em',
                                color: '#888'
                            }}>
                                {Object.keys(users).filter(uid => uid !== currentUser.userId && users[uid].isPubliclyRevealed).length > 0 && (
                                    <>
                                        üíÄ Ï†ïÏ≤¥Í∞Ä ÌÉÑÎ°úÎÇòÏÑú ÏßÄÎ™© Î∂àÍ∞Ä:<br/>
                                        {Object.keys(users)
                                            .filter(uid => uid !== currentUser.userId && users[uid].isPubliclyRevealed)
                                            .map(uid => users[uid].nickname)
                                            .join(', ')}
                                        <br/>
                                    </>
                                )}
                                {alreadyGuessed.length > 0 && (
                                    <>
                                        ‚úÖ Ïù¥ÎØ∏ ÎßûÏ∂∞ÏÑú ÏßÄÎ™© Î∂àÍ∞Ä:<br/>
                                        {alreadyGuessed
                                            .filter(uid => users[uid]?.nickname)
                                            .map(uid => users[uid].nickname)
                                            .join(', ')}
                                        <br/>
                                    </>
                                )}
                                <span style={{color: '#aaa', fontSize: '0.9em'}}>
                                    (ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω Ïãú Îã§Ïãú ÏßÄÎ™© Í∞ÄÎä•)
                                </span>
                            </div>
                        )}

                        <label>Ïù¥ ÏÇ¨ÎûåÏùò Ïã§Ï†ú Ï†ïÏ≤¥Îäî?</label>
                        <select id="guessSelect">
                            <option value="">Ï∂îÏ∏°ÌïòÏÑ∏Ïöî</option>
                            {Object.keys(ACCOUNTS).map(uid => (
                                <option key={uid} value={uid}>
                                    {ACCOUNTS[uid].name}
                                </option>
                            ))}
                        </select>

                        <button 
                            className="btn btn-danger" 
                            onClick={() => targetUser && onSubmit(targetUser)}
                            style={{marginTop: '15px'}}
                        >
                            ÏßÄÎ™©ÌïòÍ∏∞ (ÏßÄÎ™©Í∂å ÏÇ¨Ïö©)
                        </button>
                        <button 
                            className="btn btn-secondary" 
                            onClick={onClose}
                        >
                            Ï∑®ÏÜå
                        </button>
                    </div>
                </div>
            );
        }

        function NicknameModal({ currentNickname, canChange, tickets, onClose, onSubmit }) {
            const [nickname, setNickname] = useState(currentNickname || '');

            return (
                <div className="modal" onClick={currentNickname ? onClose : null}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>ÎãâÎÑ§ÏûÑ {currentNickname ? 'Î≥ÄÍ≤Ω' : 'ÏÑ§Ï†ï'}</h2>
                        
                        {tickets > 0 && (
                            <div className="info-box">
                                üé´ Î≥¥Ïú†Ìïú Î≥ÄÍ≤ΩÍ∂å: {tickets}Í∞ú<br/>
                                ÏãúÍ∞Ñ Ï†úÌïú ÏóÜÏù¥ Ï¶âÏãú Î≥ÄÍ≤Ω Í∞ÄÎä•Ìï©ÎãàÎã§!
                            </div>
                        )}
                        
                        {!canChange && currentNickname && tickets === 0 && (
                            <div className="warning-box">
                                ‚ö† ÎãâÎÑ§ÏûÑÏùÄ 2ÏãúÍ∞ÑÎßàÎã§ Ìïú Î≤àÎßå Î≥ÄÍ≤ΩÌï† Ïàò ÏûàÏäµÎãàÎã§!<br/>
                                ÎòêÎäî ÏßÄÎ™©Ïóê ÏÑ±Í≥µÌïòÏó¨ Î≥ÄÍ≤ΩÍ∂åÏùÑ ÌöçÎìùÌïòÏÑ∏Ïöî!
                            </div>
                        )}

                        <label>ÎãâÎÑ§ÏûÑ</label>
                        <input 
                            type="text"
                            value={nickname}
                            onChange={(e) => setNickname(e.target.value)}
                            placeholder="ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                            disabled={!canChange && currentNickname}
                        />

                        <button 
                            className="btn" 
                            onClick={() => onSubmit(nickname)}
                            disabled={!canChange && currentNickname}
                            style={{marginTop: '15px'}}
                        >
                            {currentNickname ? (tickets > 0 ? 'Î≥ÄÍ≤Ω (Î≥ÄÍ≤ΩÍ∂å ÏÇ¨Ïö©)' : 'Î≥ÄÍ≤Ω') : 'ÏÑ§Ï†ï'}
                        </button>
                        {currentNickname && (
                            <button 
                                className="btn btn-secondary" 
                                onClick={onClose}
                            >
                                Ï∑®ÏÜå
                            </button>
                        )}
                    </div>
                </div>
            );
        }

        function PasswordModal({ onClose, onSubmit }) {
            const [currentPassword, setCurrentPassword] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω</h2>
                        
                        <div className="info-box">
                            üí° ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 8Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.
                        </div>

                        <label>ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                        <input 
                            type="password"
                            value={currentPassword}
                            onChange={(e) => setCurrentPassword(e.target.value)}
                            placeholder="ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏"
                        />

                        <label>ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                        <input 
                            type="password"
                            value={newPassword}
                            onChange={(e) => setNewPassword(e.target.value)}
                            placeholder="ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ (8Ïûê Ïù¥ÏÉÅ)"
                        />

                        <label>ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏</label>
                        <input 
                            type="password"
                            value={confirmPassword}
                            onChange={(e) => setConfirmPassword(e.target.value)}
                            placeholder="ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏"
                        />

                        <button 
                            className="btn" 
                            onClick={() => onSubmit(currentPassword, newPassword, confirmPassword)}
                            style={{marginTop: '15px'}}
                        >
                            ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω
                        </button>
                        <button 
                            className="btn btn-secondary" 
                            onClick={onClose}
                        >
                            Ï∑®ÏÜå
                        </button>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
