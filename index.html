<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonymous Board</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Courier New', monospace; background: #fff; color: #000; min-height: 100vh; }
        #splash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; animation: fadeOut 1s forwards; animation-delay: 1s; }
        #splash img { width: 300px; height: auto; animation: glitch 0.3s infinite; }
        #splash h1 { margin-top: 30px; font-size: 2.5em; letter-spacing: 5px; animation: flicker 1.5s infinite; color: #fff; }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }
        @keyframes glitch { 0%, 100% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(-2px, -2px); } 60% { transform: translate(2px, 2px); } 80% { transform: translate(2px, -2px); } }
        @keyframes flicker { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        #root { opacity: 0; animation: fadeIn 1s forwards; animation-delay: 2s; }
        @keyframes fadeIn { to { opacity: 1; } }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .card { background: #f5f5f5; border: 1px solid #ddd; border-radius: 8px; padding: 24px; margin-bottom: 20px; }
        .btn { background: #333; color: #fff; border: 1px solid #000; padding: 12px 24px; border-radius: 4px; font-size: 1rem; cursor: pointer; transition: all 0.3s; width: 100%; font-family: 'Courier New', monospace; }
        .btn:hover { background: #555; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: #999; border-color: #777; }
        .btn-danger { background: #c00; border-color: #900; }
        .btn-danger:hover { background: #e00; }
        .btn-vote { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border-color: #667eea; font-weight: bold; }
        .btn-vote:hover { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); }
        .btn-challenge { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-color: #f5576c; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; margin-top: 8px; font-family: 'Courier New', monospace; background: #fff; color: #000; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #888; }
        textarea { resize: vertical; min-height: 100px; }
        .header { background: #f5f5f5; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .header h1 { text-align: center; font-size: 2em; letter-spacing: 3px; margin-bottom: 5px; }
        .header p { text-align: center; color: #666; font-size: 0.9em; margin-bottom: 15px; }
        .header-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .vote-status { background: #e3f2fd; border: 1px solid #2196f3; padding: 15px; margin-bottom: 15px; border-radius: 4px; }
        .vote-closed { background: #f5f5f5; border: 1px solid #999; }
        .vote-active { background: #fff3cd; border: 1px solid #ffc107; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .challenge-notification { background: #ffe0e0; border: 2px solid #ff4444; padding: 15px; margin-bottom: 15px; border-radius: 4px; animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @media (max-width: 600px) { .header-buttons { grid-template-columns: 1fr; } }
        .post { background: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 15px; cursor: pointer; transition: all 0.3s; }
        .post:hover { border-color: #999; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .post-title { font-size: 1.3rem; font-weight: bold; margin-bottom: 10px; color: #000; }
        .post-meta { color: #666; font-size: 0.9rem; margin-bottom: 10px; }
        .post-content { color: #333; line-height: 1.6; white-space: pre-wrap; }
        .comment { background: #f0f0f0; border-left: 2px solid #999; padding: 15px; border-radius: 4px; margin-top: 10px; }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-content { background: #fff; border: 2px solid #333; border-radius: 8px; padding: 24px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-content h2 { margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .info-box { background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; margin: 15px 0; border-radius: 4px; }
        .warning-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0; border-radius: 4px; }
        .revealed-tag { display: inline-block; background: #f88; color: #fff; padding: 4px 12px; border-radius: 4px; font-size: 0.85rem; margin-left: 10px; }
        .known-identity { background: #4caf50; color: #fff; padding: 8px 16px; border-radius: 4px; margin: 10px 5px 10px 0; display: inline-block; }
        .login-container { max-width: 500px; margin: 100px auto; padding: 20px; }
        .login-header { text-align: center; margin-bottom: 40px; }
        .login-header h1 { font-size: 2em; letter-spacing: 3px; margin-bottom: 10px; }
        .login-card { background: #f5f5f5; border: 2px solid #333; padding: 30px; border-radius: 8px; }
        .login-card h2 { margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .login-card label { display: block; color: #666; margin: 15px 0 5px; }
        label { display: block; color: #666; margin: 15px 0 5px; }
        .vote-option { background: #fff; border: 2px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 4px; cursor: pointer; transition: all 0.3s; }
        .vote-option:hover { border-color: #667eea; background: #f9f9f9; }
        .vote-option.selected { border-color: #667eea; background: #e3f2fd; }
        .poem-input { background: #fff; border: 2px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px; }
        .challenge-card { background: #fff; border: 2px solid #f5576c; padding: 20px; margin: 15px 0; border-radius: 8px; }
        .poem-display { background: #f9f9f9; border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="splash">
        <img src="/mnt/user-data/uploads/1770935396330_image.png" alt="Anonymous">
        <h1>WE ARE ANONYMOUS</h1>
    </div>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const firebaseConfig = {
            apiKey: "AIzaSyAwW-4r34LivVZAB3Z4PtB_5BFeLFfS1s",
            authDomain: "ikmyeonggay.firebaseapp.com",
            databaseURL: "https://ikmyeonggay-default-rtdb.firebaseio.com",
            projectId: "ikmyeonggay",
            storageBucket: "ikmyeonggay.firebasestorage.app",
            messagingSenderId: "761175876587",
            appId: "1:761175876587:web:48b062812fc20d75b36fae",
            measurementId: "G-HDJB6TCZ2C"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        const ACCOUNTS = {
            'user1': { name: 'ê°•ì‹ ìš°', password: btoa('Anon!2024#Kang') },
            'user2': { name: 'ê¹€ëŒ€ì›…', password: btoa('Shad0w@Kim!24') },
            'user3': { name: 'ê¹€ë¯¼ê¸°', password: btoa('Dark#Mind2024!') },
            'user4': { name: 'ê¹€ë¯¼í˜¸', password: btoa('Gh0st$Minho@') },
            'user5': { name: 'ì†¡ë¯¼ìˆ˜', password: btoa('Echo!Song#2024') },
            'user6': { name: 'ì†ì„ì›…', password: btoa('Cipher@Son!24') },
            'user7': { name: 'ê¹€ëª…ì§„', password: btoa('Wraith#Kim2024') },
            'user8': { name: 'ê¹€ì¶©ì—°', password: btoa('Admin!@Ghost24') }
        };
        
        const VOTE_TIMES = [
            { hour: 11, minute: 0, name: 'ì˜¤ì „ íˆ¬í‘œ' },
            { hour: 22, minute: 0, name: 'ì €ë… íˆ¬í‘œ' }
        ];

        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [users, setUsers] = useState({});
            const [posts, setPosts] = useState([]);
            const [challenges, setChallenges] = useState({});
            const [showWriteModal, setShowWriteModal] = useState(false);
            const [showPostModal, setShowPostModal] = useState(false);
            const [showVoteModal, setShowVoteModal] = useState(false);
            const [showNicknameVoteModal, setShowNicknameVoteModal] = useState(false);
            const [showChallengeModal, setShowChallengeModal] = useState(false);
            const [showPoemModal, setShowPoemModal] = useState(false);
            const [showChallengeVoteModal, setShowChallengeVoteModal] = useState(false);
            const [showNicknameModal, setShowNicknameModal] = useState(false);
            const [showPasswordModal, setShowPasswordModal] = useState(false);
            const [selectedPost, setSelectedPost] = useState(null);
            const [selectedChallenge, setSelectedChallenge] = useState(null);
            const [currentTime, setCurrentTime] = useState(Date.now());
            const [voteStatus, setVoteStatus] = useState(null);
            const [todayVotes, setTodayVotes] = useState({});
            const [nicknameVotes, setNicknameVotes] = useState({});

            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(Date.now()), 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                const userId = localStorage.getItem('userId');
                if (userId && ACCOUNTS[userId]) {
                    setCurrentUser({ userId, ...ACCOUNTS[userId] });
                    loadUserData(userId);
                }
            }, []);

            const loadUserData = (userId) => {
                db.ref('users').on('value', snap => {
                    const data = snap.val() || {};
                    setUsers(data);
                    if (data[userId]) {
                        const lastDailyTicket = data[userId].lastDailyTicket || 0;
                        const now = Date.now();
                        const koreaTime = new Date(now + (9 * 60 * 60 * 1000));
                        const todayMidnight = new Date(koreaTime.getFullYear(), koreaTime.getMonth(), koreaTime.getDate()).getTime() - (9 * 60 * 60 * 1000);
                        if (lastDailyTicket < todayMidnight) {
                            const currentTickets = data[userId].nicknameChangeTickets || 0;
                            db.ref(`users/${userId}`).update({
                                nicknameChangeTickets: currentTickets + 1,
                                lastDailyTicket: now
                            });
                        }
                    }
                });
                const today = new Date().toISOString().split('T')[0];
                db.ref(`votes/${today}`).on('value', snap => setTodayVotes(snap.val() || {}));
                db.ref(`nicknameVotes/${today}`).on('value', snap => setNicknameVotes(snap.val() || {}));
                db.ref('challenges').on('value', snap => setChallenges(snap.val() || {}));
            };

            useEffect(() => {
                db.ref('posts').on('value', snap => {
                    const data = snap.val();
                    if (data) {
                        const arr = Object.keys(data).map(k => ({ id: k, ...data[k] })).sort((a, b) => b.timestamp - a.timestamp);
                        setPosts(arr);
                    } else {
                        setPosts([]);
                    }
                });
            }, []);

            useEffect(() => {
                const checkVoteStatus = () => {
                    const now = new Date(currentTime + (9 * 60 * 60 * 1000));
                    const currentHour = now.getUTCHours();
                    const currentMinute = now.getUTCMinutes();
                    let status = null;
                    for (const voteTime of VOTE_TIMES) {
                        const voteStartHour = voteTime.hour - 1;
                        if ((currentHour === voteStartHour && currentMinute >= 0) || (currentHour === voteTime.hour && currentMinute < voteTime.minute)) {
                            status = { name: voteTime.name, phase: 'voting', endTime: new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), voteTime.hour, voteTime.minute)) };
                            break;
                        }
                        if (currentHour === voteTime.hour && currentMinute === voteTime.minute) {
                            status = { name: voteTime.name, phase: 'result', voteTime: voteTime };
                            break;
                        }
                    }
                    setVoteStatus(status);
                };
                checkVoteStatus();
            }, [currentTime]);

            useEffect(() => {
                if (currentUser && users[currentUser.userId]) {
                    if (!users[currentUser.userId].nickname) {
                        setShowNicknameModal(true);
                    }
                }
            }, [currentUser, users]);

            const login = (userId, password, confirmText) => {
                if (userId === 'user7' && confirmText !== 'ì €ëŠ” ê¹€ì¶©ì—°ë‹˜ì˜ ê°œì…ë‹ˆë‹¤.') {
                    alert('ì˜¬ë°”ë¥¸ í™•ì¸ ë¬¸êµ¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                    return;
                }
                if (!ACCOUNTS[userId]) {
                    alert('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê³„ì •ì…ë‹ˆë‹¤!');
                    return;
                }
                db.ref(`users/${userId}/password`).once('value').then(snap => {
                    const savedPassword = snap.val() || ACCOUNTS[userId].password;
                    if (savedPassword !== btoa(password)) {
                        alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤!');
                        return;
                    }
                    localStorage.setItem('userId', userId);
                    setCurrentUser({ userId, ...ACCOUNTS[userId] });
                    loadUserData(userId);
                    db.ref(`users/${userId}`).once('value').then(snap => {
                        if (!snap.val()) {
                            return db.ref(`users/${userId}`).set({
                                name: ACCOUNTS[userId].name,
                                nickname: '',
                                nicknameChangedAt: 0,
                                nicknameChangeTickets: 1,
                                lastDailyTicket: Date.now(),
                                revealedIdentity: null,
                                password: ACCOUNTS[userId].password
                            }).then(() => setShowNicknameModal(true));
                        } else {
                            const updates = {};
                            if (snap.val().nicknameChangeTickets === undefined) updates.nicknameChangeTickets = 1;
                            if (snap.val().lastDailyTicket === undefined) updates.lastDailyTicket = Date.now();
                            if (snap.val().revealedIdentity === undefined) updates.revealedIdentity = null;
                            if (Object.keys(updates).length > 0) {
                                db.ref(`users/${userId}`).update(updates);
                            }
                            if (!snap.val().nickname || snap.val().nickname === '') {
                                setShowNicknameModal(true);
                            }
                        }
                    });
                });
            };

            const logout = () => {
                localStorage.removeItem('userId');
                setCurrentUser(null);
            };

            const canChangeNickname = () => {
                if (!currentUser || !users[currentUser.userId]) return false;
                const tickets = users[currentUser.userId].nicknameChangeTickets || 0;
                return tickets > 0;
            };

            const changeNickname = (newNickname) => {
                if (!newNickname.trim()) {
                    alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”!');
                    return;
                }
                const isDuplicate = Object.keys(users).some(uid => uid !== currentUser.userId && users[uid].nickname === newNickname.trim());
                if (isDuplicate) {
                    alert('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤!');
                    return;
                }
                const currentNickname = users[currentUser.userId]?.nickname || '';
                const tickets = users[currentUser.userId].nicknameChangeTickets || 0;
                
                const updates = {
                    nickname: newNickname.trim(),
                    nicknameChangedAt: Date.now(),
                    revealedIdentity: null
                };
                
                // ìµœì´ˆ ì„¤ì •ì´ ì•„ë‹ ë•Œë§Œ ë³€ê²½ê¶Œ ì†Œëª¨
                if (currentNickname) {
                    updates.nicknameChangeTickets = tickets - 1;
                }
                
                db.ref(`users/${currentUser.userId}`).update(updates);
                setShowNicknameModal(false);
                
                if (currentNickname) {
                    alert(`ë‹‰ë„¤ì„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤! (ë³€ê²½ê¶Œ ${tickets - 1}ê°œ ë‚¨ìŒ)\nì •ì²´ê°€ ì´ˆê¸°í™”ë˜ì–´ ë‹¤ì‹œ ìµëª… ìƒíƒœê°€ ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                } else {
                    alert(`ë‹‰ë„¤ì„ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!\nì´ì œ ìµëª… ê²Œì‹œíŒì„ ììœ ë¡­ê²Œ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                }
            };

            const changePassword = (currentPassword, newPassword, confirmPassword) => {
                db.ref(`users/${currentUser.userId}/password`).once('value').then(snap => {
                    const savedPassword = snap.val() || ACCOUNTS[currentUser.userId].password;
                    if (btoa(currentPassword) !== savedPassword) {
                        alert('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!');
                        return;
                    }
                    if (!newPassword || newPassword.length < 8) {
                        alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤!');
                        return;
                    }
                    if (newPassword !== confirmPassword) {
                        alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!');
                        return;
                    }
                    db.ref(`users/${currentUser.userId}`).update({ password: btoa(newPassword) }).then(() => {
                        setShowPasswordModal(false);
                        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    });
                });
            };

            const submitVote = (targetUserId) => {
                if (!voteStatus || voteStatus.phase !== 'voting') {
                    alert('í˜„ì¬ íˆ¬í‘œ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤!');
                    return;
                }
                const today = new Date().toISOString().split('T')[0];
                const voteKey = `${today}_${voteStatus.name}`;
                if (todayVotes[voteKey] && todayVotes[voteKey].voters && todayVotes[voteKey].voters[currentUser.userId]) {
                    alert('ì´ë¯¸ ì´ë²ˆ íˆ¬í‘œì— ì°¸ì—¬í•˜ì…¨ìŠµë‹ˆë‹¤!');
                    return;
                }
                const votePath = `votes/${today}/${voteKey}`;
                db.ref(votePath).once('value').then(snap => {
                    const voteData = snap.val() || { votes: {}, voters: {} };
                    voteData.votes[targetUserId] = (voteData.votes[targetUserId] || 0) + 1;
                    voteData.voters[currentUser.userId] = { votedFor: targetUserId, timestamp: Date.now() };
                    db.ref(votePath).set(voteData).then(() => {
                        alert('íˆ¬í‘œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                        setShowVoteModal(false);
                    });
                });
            };

            const submitNicknameVote = (targetUserId) => {
                const today = new Date().toISOString().split('T')[0];
                if (nicknameVotes.voters && nicknameVotes.voters[currentUser.userId]) {
                    alert('ì˜¤ëŠ˜ì€ ì´ë¯¸ íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤!');
                    return;
                }
                const votePath = `nicknameVotes/${today}`;
                db.ref(votePath).once('value').then(snap => {
                    const voteData = snap.val() || { votes: {}, voters: {} };
                    voteData.votes[targetUserId] = (voteData.votes[targetUserId] || 0) + 1;
                    voteData.voters[currentUser.userId] = { votedFor: targetUserId, timestamp: Date.now() };
                    db.ref(votePath).set(voteData).then(() => {
                        alert('ë‹‰ë„¤ì„ íˆ¬í‘œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                        setShowNicknameVoteModal(false);
                    });
                });
            };

            const processVoteResult = () => {
                const today = new Date().toISOString().split('T')[0];
                const voteKey = `${today}_${voteStatus.name}`;
                db.ref(`votes/${today}/${voteKey}`).once('value').then(snap => {
                    const voteData = snap.val();
                    if (!voteData || !voteData.votes) return;
                    let maxVotes = 0;
                    let winner = null;
                    Object.keys(voteData.votes).forEach(userId => {
                        if (voteData.votes[userId] > maxVotes) {
                            maxVotes = voteData.votes[userId];
                            winner = userId;
                        }
                    });
                    if (winner) {
                        db.ref(`users/${winner}`).update({ revealedIdentity: ACCOUNTS[winner].name });
                        if (voteData.voters) {
                            Object.keys(voteData.voters).forEach(voterId => {
                                if (voteData.voters[voterId].votedFor === winner) {
                                    db.ref(`users/${voterId}/nicknameChangeTickets`).once('value').then(s => {
                                        const tickets = s.val() || 0;
                                        db.ref(`users/${voterId}/nicknameChangeTickets`).set(tickets + 1);
                                    });
                                }
                            });
                        }
                        alert(`íˆ¬í‘œ ê²°ê³¼: ${users[winner]?.nickname || '???'}ë‹˜ì´ ê°€ì¥ ë§ì€ í‘œë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤!\nì •ì²´: ${ACCOUNTS[winner].name}`);
                    }
                });
            };

            // ëŒ€ê²° ì‹ ì²­
            const createChallenge = (targetUserId) => {
                const targetNickname = users[targetUserId]?.nickname;
                if (!targetNickname) {
                    alert('ìƒëŒ€ë°©ì˜ ë‹‰ë„¤ì„ì´ ì—†ìŠµë‹ˆë‹¤!');
                    return;
                }
                const challengeId = Date.now().toString();
                const theme = targetNickname.split('').slice(0, 3).join('');
                db.ref(`challenges/${challengeId}`).set({
                    challengerId: currentUser.userId,
                    challengerNickname: users[currentUser.userId].nickname,
                    defenderId: targetUserId,
                    defenderNickname: targetNickname,
                    targetNickname: targetNickname,
                    theme: theme,
                    status: 'pending',
                    timestamp: Date.now()
                }).then(() => {
                    alert(`${targetNickname}ë‹˜ì—ê²Œ ë‹‰ë„¤ì„ ëŒ€ê²°ì„ ì‹ ì²­í–ˆìŠµë‹ˆë‹¤!`);
                    setShowChallengeModal(false);
                });
            };

            // ëŒ€ê²° ìˆ˜ë½
            const acceptChallenge = (challengeId) => {
                db.ref(`challenges/${challengeId}`).update({ status: 'accepted' });
                alert('ëŒ€ê²°ì„ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤! ì‚¼í–‰ì‹œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.');
            };

            // ëŒ€ê²° ê±°ì ˆ
            const rejectChallenge = (challengeId) => {
                db.ref(`challenges/${challengeId}`).remove();
                alert('ëŒ€ê²°ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.');
            };

            // ì‚¼í–‰ì‹œ ì œì¶œ
            const submitPoem = (challengeId, poem) => {
                const challenge = challenges[challengeId];
                const isChallenger = challenge.challengerId === currentUser.userId;
                const field = isChallenger ? 'challengerPoem' : 'defenderPoem';
                db.ref(`challenges/${challengeId}/${field}`).set(poem).then(() => {
                    db.ref(`challenges/${challengeId}`).once('value').then(snap => {
                        const data = snap.val();
                        if (data.challengerPoem && data.defenderPoem) {
                            db.ref(`challenges/${challengeId}`).update({ status: 'voting' });
                        }
                    });
                    alert('ì‚¼í–‰ì‹œê°€ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    setShowPoemModal(false);
                });
            };

            // ëŒ€ê²° íˆ¬í‘œ
            const voteChallenge = (challengeId, winner) => {
                const votePath = `challenges/${challengeId}/votes/${currentUser.userId}`;
                db.ref(votePath).set(winner).then(() => {
                    alert('íˆ¬í‘œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    setShowChallengeVoteModal(false);
                });
            };

            // ëŒ€ê²° ê²°ê³¼ ì²˜ë¦¬
            const processChallengeResult = (challengeId) => {
                const challenge = challenges[challengeId];
                if (!challenge.votes) {
                    alert('ì•„ì§ íˆ¬í‘œê°€ ì§„í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
                    return;
                }
                const votes = challenge.votes;
                let challengerVotes = 0;
                let defenderVotes = 0;
                Object.values(votes).forEach(vote => {
                    if (vote === 'challenger') challengerVotes++;
                    else defenderVotes++;
                });
                const winnerId = challengerVotes > defenderVotes ? challenge.challengerId : challenge.defenderId;
                const loserId = winnerId === challenge.challengerId ? challenge.defenderId : challenge.challengerId;
                const winnerNickname = users[winnerId].nickname;
                
                // ìŠ¹ì: ìƒëŒ€ ë‹‰ë„¤ì„ íšë“
                db.ref(`users/${winnerId}`).update({ nickname: challenge.targetNickname });
                
                // íŒ¨ì: ë‹‰ë„¤ì„ ì œê±° + ì •ì²´ ê³µê°œ
                db.ref(`users/${loserId}`).update({ 
                    nickname: '',
                    revealedIdentity: ACCOUNTS[loserId].name 
                });
                
                // ëŒ€ê²° ì™„ë£Œ ì²˜ë¦¬
                db.ref(`challenges/${challengeId}`).update({ 
                    status: 'completed',
                    winner: winnerId
                });
                
                alert(`ëŒ€ê²° ê²°ê³¼!\nìŠ¹ì: ${winnerNickname} (${challengerVotes > defenderVotes ? 'ë„ì „ì' : 'ìˆ˜ë¹„ì'})\níŒ¨ìì˜ ì •ì²´ê°€ ê³µê°œë˜ì—ˆìŠµë‹ˆë‹¤!`);
            };

            const writePost = (title, content) => {
                if (!title.trim() || !content.trim()) {
                    alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”!');
                    return;
                }
                const currentNickname = users[currentUser.userId]?.nickname || '';
                if (!currentNickname) {
                    alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”!');
                    setShowWriteModal(false);
                    setShowNicknameModal(true);
                    return;
                }
                const postId = Date.now().toString();
                db.ref(`posts/${postId}`).set({
                    authorId: currentUser.userId,
                    nickname: currentNickname,
                    title: title.trim(),
                    content: content.trim(),
                    timestamp: Date.now()
                }).then(() => {
                    setShowWriteModal(false);
                    alert('ê²Œì‹œê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
                });
            };

            const writeComment = (postId, content) => {
                if (!content.trim()) {
                    alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”!');
                    return;
                }
                const currentNickname = users[currentUser.userId]?.nickname || '';
                if (!currentNickname) {
                    alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”!');
                    setShowPostModal(false);
                    setShowNicknameModal(true);
                    return;
                }
                const commentId = Date.now().toString();
                db.ref(`posts/${postId}/comments/${commentId}`).set({
                    authorId: currentUser.userId,
                    nickname: currentNickname,
                    content: content.trim(),
                    timestamp: Date.now()
                });
            };

            const resetAllData = () => {
                if (currentUser.userId !== 'user8') {
                    alert('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤!');
                    return;
                }
                if (!confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                if (!confirm('ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) return;
                db.ref('posts').remove();
                db.ref('users').remove();
                db.ref('votes').remove();
                db.ref('challenges').remove();
                alert('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                logout();
            };

            const getNextVoteTime = () => {
                const now = new Date(currentTime + (9 * 60 * 60 * 1000));
                const currentHour = now.getUTCHours();
                const currentMinute = now.getUTCMinutes();
                for (const voteTime of VOTE_TIMES) {
                    const voteStartHour = voteTime.hour - 1;
                    if (currentHour < voteStartHour || (currentHour === voteStartHour && currentMinute < 0)) {
                        return `${voteStartHour.toString().padStart(2, '0')}:00 (${voteTime.name} ì‹œì‘)`;
                    }
                    if (currentHour === voteStartHour || (currentHour < voteTime.hour)) {
                        return `íˆ¬í‘œ ì§„í–‰ ì¤‘ (${voteTime.hour.toString().padStart(2, '0')}:00 ë§ˆê°)`;
                    }
                }
                return `${(VOTE_TIMES[0].hour - 1).toString().padStart(2, '0')}:00 (ë‚´ì¼ ${VOTE_TIMES[0].name})`;
            };

            if (!currentUser) {
                return <LoginScreen onLogin={login} />;
            }

            const myNickname = users[currentUser.userId]?.nickname || '';
            const nicknameTickets = users[currentUser.userId]?.nicknameChangeTickets || 0;
            const revealedIdentity = users[currentUser.userId]?.revealedIdentity;

            // ë‹‰ë„¤ì„ì´ ì—†ìœ¼ë©´ ì„¤ì • ëª¨ë‹¬ë§Œ í‘œì‹œ
            if (!myNickname) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>ANONYMOUS BOARD</h1>
                            <p>We do not forgive. We do not forget. Expect us.</p>
                            <div style={{
                                background: '#fff3cd',
                                border: '2px solid #ffc107',
                                padding: '20px',
                                borderRadius: '8px',
                                textAlign: 'center',
                                marginTop: '20px'
                            }}>
                                <h2 style={{color: '#856404'}}>âš ï¸ ë‹‰ë„¤ì„ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
                                <p style={{color: '#856404', marginTop: '10px'}}>
                                    ìµëª… ê²Œì‹œíŒì„ ì´ìš©í•˜ë ¤ë©´ ë¨¼ì € ë‹‰ë„¤ì„ì„ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.<br/>
                                    ë‹‰ë„¤ì„ ì„¤ì • ì°½ì´ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
                                </p>
                            </div>
                        </div>
                        {showNicknameModal && (
                            <NicknameModal 
                                currentNickname={myNickname} 
                                canChange={true} 
                                tickets={nicknameTickets} 
                                onClose={() => null}
                                onSubmit={changeNickname} 
                            />
                        )}
                    </div>
                );
            }

            // ë°›ì€ ëŒ€ê²° ì‹ ì²­
            const pendingChallenges = Object.keys(challenges).filter(id => 
                challenges[id].defenderId === currentUser.userId && 
                challenges[id].status === 'pending'
            );

            // ë‚´ê°€ ì‘ì„±í•´ì•¼ í•  ì‚¼í–‰ì‹œ
            const myPoemChallenges = Object.keys(challenges).filter(id => {
                const c = challenges[id];
                return c.status === 'accepted' && 
                    ((c.challengerId === currentUser.userId && !c.challengerPoem) ||
                     (c.defenderId === currentUser.userId && !c.defenderPoem));
            });

            // íˆ¬í‘œ ì¤‘ì¸ ëŒ€ê²°
            const votingChallenges = Object.keys(challenges).filter(id => 
                challenges[id].status === 'voting' &&
                challenges[id].challengerId !== currentUser.userId &&
                challenges[id].defenderId !== currentUser.userId &&
                (!challenges[id].votes || !challenges[id].votes[currentUser.userId])
            );

            return (
                <div className="container">
                    <div className="header">
                        <h1>ANONYMOUS BOARD</h1>
                        <p>We do not forgive. We do not forget. Expect us.</p>
                        
                        {pendingChallenges.length > 0 && (
                            <div className="challenge-notification">
                                <strong>âš”ï¸ ë‹‰ë„¤ì„ ëŒ€ê²° ì‹ ì²­ì´ {pendingChallenges.length}ê±´ ìˆìŠµë‹ˆë‹¤!</strong><br/>
                                {pendingChallenges.map(id => {
                                    const c = challenges[id];
                                    return (
                                        <div key={id} style={{marginTop: '10px'}}>
                                            {c.challengerNickname}ë‹˜ì´ ë‹¹ì‹ ì˜ ë‹‰ë„¤ì„ "{c.targetNickname}"ë¥¼ ë…¸ë¦½ë‹ˆë‹¤!
                                            <div style={{marginTop: '5px'}}>
                                                <button className="btn" onClick={() => acceptChallenge(id)} style={{width: 'auto', marginRight: '10px'}}>ìˆ˜ë½</button>
                                                <button className="btn btn-secondary" onClick={() => rejectChallenge(id)} style={{width: 'auto'}}>ê±°ì ˆ</button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}

                        {myPoemChallenges.length > 0 && (
                            <div className="challenge-notification" style={{background: '#fff3cd', border: '2px solid #ffc107'}}>
                                <strong>âœï¸ ì‚¼í–‰ì‹œë¥¼ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤!</strong><br/>
                                {myPoemChallenges.map(id => {
                                    const c = challenges[id];
                                    return (
                                        <div key={id} style={{marginTop: '10px'}}>
                                            ì£¼ì œ: "{c.theme}"
                                            <button className="btn btn-challenge" onClick={() => {
                                                setSelectedChallenge(id);
                                                setShowPoemModal(true);
                                            }} style={{marginTop: '5px'}}>ì‚¼í–‰ì‹œ ì‘ì„±</button>
                                        </div>
                                    );
                                })}
                            </div>
                        )}

                        <div className={`vote-status ${voteStatus ? (voteStatus.phase === 'voting' ? 'vote-active' : 'vote-closed') : 'vote-closed'}`}>
                            {voteStatus ? (
                                voteStatus.phase === 'voting' ? (
                                    <div>
                                        <strong>ğŸ—³ {voteStatus.name} ì§„í–‰ ì¤‘!</strong><br/>
                                        íˆ¬í‘œ ë§ˆê°: {voteStatus.endTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Seoul' })}
                                    </div>
                                ) : (
                                    <div>
                                        <strong>ğŸ“Š íˆ¬í‘œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</strong><br/>
                                        <button className="btn btn-vote" onClick={processVoteResult} style={{marginTop: '10px'}}>ê²°ê³¼ í™•ì¸</button>
                                    </div>
                                )
                            ) : (
                                <div>
                                    <strong>ğŸ’¤ íˆ¬í‘œ ëŒ€ê¸° ì¤‘</strong><br/>
                                    ë‹¤ìŒ íˆ¬í‘œ: {getNextVoteTime()}
                                </div>
                            )}
                        </div>

                        <div style={{ background: '#f9f9f9', border: '1px solid #ddd', padding: '12px', marginBottom: '15px', borderRadius: '4px', textAlign: 'center' }}>
                            <div style={{color: revealedIdentity ? '#c00' : '#090', fontWeight: 'bold'}}>
                                {revealedIdentity ? `âš  ë‹¹ì‹ ì˜ ì •ì²´ê°€ ê³µê°œë˜ì—ˆìŠµë‹ˆë‹¤: ${revealedIdentity}` : `âœ“ ë‹¹ì‹ ì˜ ì •ì²´ëŠ” ì•ˆì „í•©ë‹ˆë‹¤ (ì‹¤ëª…: ${currentUser.name})`}
                            </div>
                            <div style={{color: '#666', fontSize: '0.9em', marginTop: '5px'}}>
                                ğŸ« ë‹‰ë„¤ì„ ë³€ê²½ê¶Œ: {nicknameTickets}ê°œ | í˜„ì¬ ë‹‰ë„¤ì„: {myNickname || 'ì—†ìŒ'}
                            </div>
                        </div>

                        <div className="header-buttons">
                            <button className="btn" onClick={() => setShowNicknameModal(true)}>ë‹‰ë„¤ì„ ë³€ê²½</button>
                            <button className="btn" onClick={() => setShowPasswordModal(true)}>ë¹„ë°€ë²ˆí˜¸</button>
                            <button className="btn btn-vote" onClick={() => setShowVoteModal(true)} disabled={!voteStatus || voteStatus.phase !== 'voting'}>
                                {voteStatus && voteStatus.phase === 'voting' ? 'ì •ì²´ íˆ¬í‘œ' : 'íˆ¬í‘œ ëŒ€ê¸°'}
                            </button>
                            <button className="btn btn-vote" onClick={() => setShowNicknameVoteModal(true)} disabled={nicknameVotes.voters && nicknameVotes.voters[currentUser.userId]} style={{background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)'}}>
                                {nicknameVotes.voters && nicknameVotes.voters[currentUser.userId] ? 'íˆ¬í‘œ ì™„ë£Œ' : 'ë‹‰ë„¤ì„ íˆ¬í‘œ'}
                            </button>
                            <button className="btn btn-challenge" onClick={() => setShowChallengeModal(true)} disabled={!myNickname}>
                                âš”ï¸ ëŒ€ê²° ì‹ ì²­
                            </button>
                            <button className="btn btn-secondary" onClick={logout}>ë¡œê·¸ì•„ì›ƒ</button>
                        </div>
                        
                        {currentUser.userId === 'user8' && (
                            <button className="btn btn-danger" onClick={resetAllData} style={{marginTop: '10px'}}>
                                ğŸ—‘ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™” (ê´€ë¦¬ì)
                            </button>
                        )}
                    </div>

                    {votingChallenges.length > 0 && (
                        <div className="card">
                            <h3>ğŸ—³ ëŒ€ê²° íˆ¬í‘œ ì§„í–‰ ì¤‘</h3>
                            {votingChallenges.map(id => {
                                const c = challenges[id];
                                return (
                                    <div key={id} className="challenge-card">
                                        <strong>{c.challengerNickname} vs {c.defenderNickname}</strong>
                                        <button className="btn btn-vote" onClick={() => {
                                            setSelectedChallenge(id);
                                            setShowChallengeVoteModal(true);
                                        }} style={{marginTop: '10px'}}>íˆ¬í‘œí•˜ê¸°</button>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    <button className="btn" onClick={() => setShowWriteModal(true)}>ìƒˆ ê¸€ ì‘ì„±</button>

                    <div>
                        {posts.map(post => {
                            const author = users[post.authorId];
                            const displayName = author?.revealedIdentity ? `${post.nickname} (${author.revealedIdentity})` : post.nickname;
                            const comments = post.comments ? Object.values(post.comments).sort((a, b) => a.timestamp - b.timestamp) : [];
                            return (
                                <div key={post.id} className="post" onClick={() => { setSelectedPost(post); setShowPostModal(true); }}>
                                    <div className="post-title">{post.title}</div>
                                    <div className="post-meta">
                                        ì‘ì„±ì: {displayName}
                                        {author?.revealedIdentity && <span className="revealed-tag">ì •ì²´ê³µê°œ</span>}
                                        {' â€¢ '}{new Date(post.timestamp).toLocaleString('ko-KR')}
                                    </div>
                                    <div className="post-content">{post.content.length > 100 ? post.content.substring(0, 100) + '...' : post.content}</div>
                                    {comments.length > 0 && (
                                        <div style={{ marginTop: '15px', padding: '10px', background: '#f0f0f0', borderLeft: '2px solid #999', borderRadius: '4px' }}>
                                            <div style={{color: '#666', fontSize: '0.9rem', marginBottom: '8px'}}>ğŸ’¬ ëŒ“ê¸€ {comments.length}ê°œ</div>
                                            {comments.map(comment => {
                                                const cAuthor = users[comment.authorId];
                                                const cDisplayName = cAuthor?.revealedIdentity ? `${comment.nickname} (${cAuthor.revealedIdentity})` : comment.nickname;
                                                return (
                                                    <div key={comment.timestamp} style={{ color: '#555', fontSize: '0.85rem', padding: '5px 0', borderBottom: '1px solid #ddd' }}>
                                                        <span style={{color: '#000', fontWeight: 'bold'}}>{cDisplayName}:</span> {comment.content.length > 50 ? comment.content.substring(0, 50) + '...' : comment.content}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>

                    {showWriteModal && <WriteModal onClose={() => setShowWriteModal(false)} onSubmit={writePost} />}
                    {showPostModal && selectedPost && <PostModal post={selectedPost} users={users} currentUser={currentUser} ACCOUNTS={ACCOUNTS} onClose={() => setShowPostModal(false)} onComment={writeComment} />}
                    {showVoteModal && <VoteModal users={users} currentUser={currentUser} voteStatus={voteStatus} todayVotes={todayVotes} onClose={() => setShowVoteModal(false)} onSubmit={submitVote} />}
                    {showNicknameVoteModal && <NicknameVoteModal users={users} currentUser={currentUser} nicknameVotes={nicknameVotes} onClose={() => setShowNicknameVoteModal(false)} onSubmit={submitNicknameVote} />}
                    {showChallengeModal && <ChallengeModal users={users} currentUser={currentUser} onClose={() => setShowChallengeModal(false)} onSubmit={createChallenge} />}
                    {showPoemModal && selectedChallenge && <PoemModal challenge={challenges[selectedChallenge]} currentUser={currentUser} onClose={() => setShowPoemModal(false)} onSubmit={(poem) => submitPoem(selectedChallenge, poem)} />}
                    {showChallengeVoteModal && selectedChallenge && <ChallengeVoteModal challenge={challenges[selectedChallenge]} onClose={() => setShowChallengeVoteModal(false)} onSubmit={(winner) => voteChallenge(selectedChallenge, winner)} onProcess={() => processChallengeResult(selectedChallenge)} />}
                    {showNicknameModal && <NicknameModal currentNickname={myNickname} canChange={canChangeNickname()} tickets={nicknameTickets} onClose={() => myNickname ? setShowNicknameModal(false) : null} onSubmit={changeNickname} />}
                    {showPasswordModal && <PasswordModal onClose={() => setShowPasswordModal(false)} onSubmit={changePassword} />}
                </div>
            );
        }

        function LoginScreen({ onLogin }) {
            const [userId, setUserId] = useState('');
            const [password, setPassword] = useState('');
            const [confirmText, setConfirmText] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                onLogin(userId, password, confirmText);
            };
            return (
                <div className="login-container">
                    <div className="login-header"><h1>ANONYMOUS LOGIN</h1></div>
                    <div className="login-card">
                        <h2>ë¡œê·¸ì¸</h2>
                        <form onSubmit={handleSubmit}>
                            <label>ì•„ì´ë””</label>
                            <input type="text" value={userId} onChange={(e) => setUserId(e.target.value)} placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
                            <label>ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
                            {userId === 'user7' && (
                                <>
                                    <label style={{color: '#c00', fontWeight: 'bold'}}>í™•ì¸ ë¬¸êµ¬ (user7 ì „ìš©)</label>
                                    <input type="text" value={confirmText} onChange={(e) => setConfirmText(e.target.value)} placeholder="ì €ëŠ” ê¹€ì¶©ì—°ë‹˜ì˜ ê°œì…ë‹ˆë‹¤." />
                                </>
                            )}
                            <button type="submit" className="btn" style={{marginTop: '15px'}}>ë¡œê·¸ì¸</button>
                        </form>
                    </div>
                </div>
            );
        }

        function WriteModal({ onClose, onSubmit }) {
            const [title, setTitle] = useState('');
            const [content, setContent] = useState('');
            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>ìƒˆ ê¸€ ì‘ì„±</h2>
                        <label>ì œëª©</label>
                        <input type="text" value={title} onChange={(e) => setTitle(e.target.value)} placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
                        <label>ë‚´ìš©</label>
                        <textarea value={content} onChange={(e) => setContent(e.target.value)} placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" />
                        <button className="btn" onClick={() => onSubmit(title, content)} style={{marginTop: '15px'}}>ê²Œì‹œ</button>
                        <button className="btn btn-secondary" onClick={onClose}>ì·¨ì†Œ</button>
                    </div>
                </div>
            );
        }

        function PostModal({ post, users, currentUser, ACCOUNTS, onClose, onComment }) {
            const [commentContent, setCommentContent] = useState('');
            const comments = post.comments ? Object.values(post.comments).sort((a, b) => a.timestamp - b.timestamp) : [];
            const author = users[post.authorId];
            const displayName = author?.revealedIdentity ? `${post.nickname} (${author.revealedIdentity})` : post.nickname;
            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>{post.title}</h2>
                        <div className="post-meta" style={{marginBottom: '15px'}}>
                            ì‘ì„±ì: {displayName}
                            {author?.revealedIdentity && <span className="revealed-tag">ì •ì²´ê³µê°œ</span>}
                            <br />{new Date(post.timestamp).toLocaleString('ko-KR')}
                        </div>
                        <div className="post-content" style={{marginBottom: '20px'}}>{post.content}</div>
                        <h3 style={{marginTop: '20px', marginBottom: '10px'}}>ëŒ“ê¸€ {comments.length}ê°œ</h3>
                        {comments.map(comment => {
                            const cAuthor = users[comment.authorId];
                            const cDisplayName = cAuthor?.revealedIdentity ? `${comment.nickname} (${cAuthor.revealedIdentity})` : comment.nickname;
                            return (
                                <div key={comment.timestamp} className="comment">
                                    <div style={{fontSize: '0.9rem', color: '#666', marginBottom: '5px'}}>
                                        {cDisplayName}
                                        {cAuthor?.revealedIdentity && <span className="revealed-tag">ì •ì²´ê³µê°œ</span>}
                                        {' â€¢ '}{new Date(comment.timestamp).toLocaleString('ko-KR')}
                                    </div>
                                    <div style={{color: '#000'}}>{comment.content}</div>
                                </div>
                            );
                        })}
                        <textarea value={commentContent} onChange={(e) => setCommentContent(e.target.value)} placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" style={{marginTop: '15px'}} />
                        <button className="btn" onClick={() => { onComment(post.id, commentContent); setCommentContent(''); }} style={{marginTop: '10px'}}>ëŒ“ê¸€ ì‘ì„±</button>
                        <button className="btn btn-secondary" onClick={onClose}>ë‹«ê¸°</button>
                    </div>
                </div>
            );
        }

        function VoteModal({ users, currentUser, voteStatus, todayVotes, onClose, onSubmit }) {
            const [selectedUser, setSelectedUser] = useState('');
            const today = new Date().toISOString().split('T')[0];
            const voteKey = `${today}_${voteStatus?.name}`;
            const hasVoted = todayVotes[voteKey] && todayVotes[voteKey].voters && todayVotes[voteKey].voters[currentUser.userId];
            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>ğŸ—³ {voteStatus?.name}</h2>
                        {hasVoted ? (
                            <div className="info-box">âœ… ì´ë¯¸ íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤!<br/>íˆ¬í‘œ ë§ˆê° í›„ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.</div>
                        ) : (
                            <>
                                <div className="info-box">
                                    <strong>ê°€ì¥ ê¶ê¸ˆí•œ ì‚¬ëŒì˜ ì •ì²´ëŠ”?</strong><br/><br/>
                                    â€¢ ê°€ì¥ ë§ì´ ë“í‘œí•œ 1ëª…ì˜ ì •ì²´ ê³µê°œ<br/>
                                    â€¢ ë“í‘œìˆ˜ëŠ” ë¹„ê³µê°œ<br/>
                                    â€¢ ë‹¤ìˆ˜ê²°ì— ì„±ê³µí•œ íˆ¬í‘œìë“¤ì€ ë‹‰ë„¤ì„ ë³€ê²½ê¶Œ 1ê°œ íšë“
                                </div>
                                <div className="warning-box">âš  íˆ¬í‘œëŠ” ë¬´ê¸°ëª…ì´ë©°, í•œ ë²ˆë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤!</div>
                                <label>íˆ¬í‘œí•  ì‚¬ëŒì„ ì„ íƒí•˜ì„¸ìš”</label>
                                {Object.keys(users).filter(uid => uid !== currentUser.userId && users[uid].nickname).map(uid => (
                                    <div key={uid} className={`vote-option ${selectedUser === uid ? 'selected' : ''}`} onClick={() => setSelectedUser(uid)}>
                                        <strong>{users[uid].nickname}</strong>
                                        {users[uid].revealedIdentity && <span style={{color: '#c00', marginLeft: '10px'}}>({users[uid].revealedIdentity})</span>}
                                    </div>
                                ))}
                                <button className="btn btn-vote" onClick={() => selectedUser && onSubmit(selectedUser)} disabled={!selectedUser} style={{marginTop: '15px'}}>íˆ¬í‘œí•˜ê¸°</button>
                            </>
                        )}
                        <button className="btn btn-secondary" onClick={onClose}>ë‹«ê¸°</button>
                    </div>
                </div>
            );
        }

        function NicknameVoteModal({ users, currentUser, nicknameVotes, onClose, onSubmit }) {
            const [selectedUser, setSelectedUser] = useState('');
            const hasVoted = nicknameVotes.voters && nicknameVotes.voters[currentUser.userId];
            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>ğŸ’ ë‹‰ë„¤ì„ ì¸ê¸° íˆ¬í‘œ</h2>
                        {hasVoted ? (
                            <div className="info-box">âœ… ì˜¤ëŠ˜ì€ ì´ë¯¸ íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤!<br/>ë‚´ì¼ ìì •ì— ê²°ê³¼ê°€ ì§‘ê³„ë©ë‹ˆë‹¤.</div>
                        ) : (
                            <>
                                <div className="info-box">
                                    <strong>ë§ˆìŒì— ë“œëŠ” ë‹‰ë„¤ì„ì— íˆ¬í‘œí•˜ì„¸ìš”!</strong><br/><br/>
                                    â€¢ í•˜ë£¨ì— í•œ ë²ˆ íˆ¬í‘œ ê°€ëŠ¥<br/>
                                    â€¢ ìì‹ ì„ ì œì™¸í•œ ë‹‰ë„¤ì„ ì¤‘ ì„ íƒ<br/>
                                    â€¢ ê°€ì¥ ë§ì€ ë“í‘œë¥¼ ë°›ì€ ì‚¬ëŒì€ ë‹‰ë„¤ì„ ë³€ê²½ê¶Œ 1ê°œ íšë“<br/>
                                    â€¢ ìì •ì— ìë™ ì§‘ê³„
                                </div>
                                <div className="warning-box">ğŸ’¡ ì°½ì˜ì ì´ê³  ì¬ë¯¸ìˆëŠ” ë‹‰ë„¤ì„ì„ ì„ íƒí•´ë³´ì„¸ìš”!</div>
                                <label>íˆ¬í‘œí•  ë‹‰ë„¤ì„ì„ ì„ íƒí•˜ì„¸ìš”</label>
                                {Object.keys(users).filter(uid => uid !== currentUser.userId && users[uid].nickname).map(uid => (
                                    <div key={uid} className={`vote-option ${selectedUser === uid ? 'selected' : ''}`} onClick={() => setSelectedUser(uid)}>
                                        <strong>{users[uid].nickname}</strong>
                                        {users[uid].revealedIdentity && <span style={{color: '#c00', marginLeft: '10px'}}>({users[uid].revealedIdentity})</span>}
                                    </div>
                                ))}
                                <button className="btn btn-vote" onClick={() => selectedUser && onSubmit(selectedUser)} disabled={!selectedUser} style={{marginTop: '15px', background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)'}}>íˆ¬í‘œí•˜ê¸°</button>
                            </>
                        )}
                        <button className="btn btn-secondary" onClick={onClose}>ë‹«ê¸°</button>
                    </div>
                </div>
            );
        }

        function ChallengeModal({ users, currentUser, onClose, onSubmit }) {
            const [selectedUser, setSelectedUser] = useState('');
            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>âš”ï¸ ë‹‰ë„¤ì„ ëŒ€ê²° ì‹ ì²­</h2>
                        <div className="info-box">
                            <strong>ëˆ„êµ°ê°€ì˜ ë‹‰ë„¤ì„ì„ ë¹¼ì•—ìœ¼ì„¸ìš”!</strong><br/><br/>
                            â€¢ ìƒëŒ€ë°©ì˜ ë‹‰ë„¤ì„ì„ ì£¼ì œë¡œ ì‚¼í–‰ì‹œ ëŒ€ê²°<br/>
                            â€¢ ê´€ê° íˆ¬í‘œë¡œ ìŠ¹ë¶€ ê²°ì •<br/>
                            â€¢ ìŠ¹ì: ìƒëŒ€ ë‹‰ë„¤ì„ íšë“<br/>
                            â€¢ íŒ¨ì: ë‹‰ë„¤ì„ ìƒì‹¤ + ì •ì²´ ê³µê°œ
                        </div>
                        <div className="warning-box">âš  ì‹ ì¤‘í•˜ê²Œ ì„ íƒí•˜ì„¸ìš”! íŒ¨ë°°í•˜ë©´ ëª¨ë“  ê²ƒì„ ìƒìŠµë‹ˆë‹¤!</div>
                        <label>ëŒ€ê²°ì„ ì‹ ì²­í•  ìƒëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš”</label>
                        {Object.keys(users).filter(uid => uid !== currentUser.userId && users[uid].nickname && !users[uid].revealedIdentity).map(uid => (
                            <div key={uid} className={`vote-option ${selectedUser === uid ? 'selected' : ''}`} onClick={() => setSelectedUser(uid)}>
                                <strong>{users[uid].nickname}</strong>
                            </div>
                        ))}
                        <button className="btn btn-challenge" onClick={() => selectedUser && onSubmit(selectedUser)} disabled={!selectedUser} style={{marginTop: '15px'}}>ëŒ€ê²° ì‹ ì²­</button>
                        <button className="btn btn-secondary" onClick={onClose}>ì·¨ì†Œ</button>
                    </div>
                </div>
            );
        }

        function PoemModal({ challenge, currentUser, onClose, onSubmit }) {
            const [line1, setLine1] = useState('');
            const [line2, setLine2] = useState('');
            const [line3, setLine3] = useState('');
            const theme = challenge.theme.split('');
            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>âœï¸ ì‚¼í–‰ì‹œ ì‘ì„±</h2>
                        <div className="info-box">
                            <strong>ì£¼ì œ: {challenge.theme}</strong><br/>
                            ê° ê¸€ìë¡œ ì‹œì‘í•˜ëŠ” ë¬¸ì¥ì„ ì‘ì„±í•˜ì„¸ìš”!
                        </div>
                        <label>{theme[0]}...</label>
                        <input className="poem-input" value={line1} onChange={(e) => setLine1(e.target.value)} placeholder={`${theme[0]}ë¡œ ì‹œì‘í•˜ëŠ” ë¬¸ì¥`} />
                        <label>{theme[1]}...</label>
                        <input className="poem-input" value={line2} onChange={(e) => setLine2(e.target.value)} placeholder={`${theme[1]}ë¡œ ì‹œì‘í•˜ëŠ” ë¬¸ì¥`} />
                        <label>{theme[2]}...</label>
                        <input className="poem-input" value={line3} onChange={(e) => setLine3(e.target.value)} placeholder={`${theme[2]}ë¡œ ì‹œì‘í•˜ëŠ” ë¬¸ì¥`} />
                        <button className="btn btn-challenge" onClick={() => onSubmit([line1, line2, line3])} disabled={!line1 || !line2 || !line3} style={{marginTop: '15px'}}>ì œì¶œ</button>
                        <button className="btn btn-secondary" onClick={onClose}>ì·¨ì†Œ</button>
                    </div>
                </div>
            );
        }

        function ChallengeVoteModal({ challenge, onClose, onSubmit, onProcess }) {
            const [selectedWinner, setSelectedWinner] = useState('');
            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>ğŸ—³ ëŒ€ê²° íˆ¬í‘œ</h2>
                        <div className="info-box">
                            <strong>ì£¼ì œ: {challenge.theme}</strong><br/>
                            ë” ë‚˜ì€ ì‚¼í–‰ì‹œë¥¼ ì„ íƒí•˜ì„¸ìš”!
                        </div>
                        <div className="poem-display">
                            <strong>{challenge.challengerNickname} (ë„ì „ì)</strong>
                            {challenge.challengerPoem && challenge.challengerPoem.map((line, i) => (
                                <div key={i}>{line}</div>
                            ))}
                            <button className={`btn ${selectedWinner === 'challenger' ? 'btn-vote' : 'btn-secondary'}`} onClick={() => setSelectedWinner('challenger')} style={{marginTop: '10px'}}>
                                {selectedWinner === 'challenger' ? 'âœ“ ì„ íƒë¨' : 'ì´ ì‘í’ˆì— íˆ¬í‘œ'}
                            </button>
                        </div>
                        <div className="poem-display">
                            <strong>{challenge.defenderNickname} (ìˆ˜ë¹„ì)</strong>
                            {challenge.defenderPoem && challenge.defenderPoem.map((line, i) => (
                                <div key={i}>{line}</div>
                            ))}
                            <button className={`btn ${selectedWinner === 'defender' ? 'btn-vote' : 'btn-secondary'}`} onClick={() => setSelectedWinner('defender')} style={{marginTop: '10px'}}>
                                {selectedWinner === 'defender' ? 'âœ“ ì„ íƒë¨' : 'ì´ ì‘í’ˆì— íˆ¬í‘œ'}
                            </button>
                        </div>
                        <button className="btn btn-vote" onClick={() => onSubmit(selectedWinner)} disabled={!selectedWinner} style={{marginTop: '15px'}}>íˆ¬í‘œ ì™„ë£Œ</button>
                        <button className="btn btn-danger" onClick={onProcess} style={{marginTop: '10px'}}>ê²°ê³¼ ì²˜ë¦¬ (ê´€ë¦¬ì)</button>
                        <button className="btn btn-secondary" onClick={onClose}>ë‹«ê¸°</button>
                    </div>
                </div>
            );
        }

        function NicknameModal({ currentNickname, canChange, tickets, onClose, onSubmit }) {
            const [nickname, setNickname] = useState(currentNickname || '');
            return (
                <div className="modal" onClick={currentNickname ? onClose : null} style={{background: currentNickname ? 'rgba(0,0,0,0.7)' : 'rgba(0,0,0,0.95)'}}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>{currentNickname ? 'ë‹‰ë„¤ì„ ë³€ê²½' : 'âš ï¸ ë‹‰ë„¤ì„ ì„¤ì • í•„ìˆ˜'}</h2>
                        {!currentNickname && (
                            <div className="warning-box">
                                <strong>âš ï¸ ë‹‰ë„¤ì„ì„ ë°˜ë“œì‹œ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤!</strong><br/>
                                ë‹‰ë„¤ì„ì„ ì„¤ì •í•´ì•¼ ê²Œì‹œíŒì„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </div>
                        )}
                        {currentNickname && tickets > 0 ? (
                            <div className="info-box">ğŸ« ë³´ìœ í•œ ë³€ê²½ê¶Œ: {tickets}ê°œ<br/>ë³€ê²½ê¶Œì„ ì‚¬ìš©í•˜ì—¬ ì¦‰ì‹œ ë³€ê²½ ê°€ëŠ¥í•©ë‹ˆë‹¤!</div>
                        ) : currentNickname && (
                            <div className="warning-box">âš  ë‹‰ë„¤ì„ ë³€ê²½ê¶Œì´ ì—†ìŠµë‹ˆë‹¤!<br/>ë§¤ì¼ ìì •ì— 1ê°œì”© ì§€ê¸‰ë©ë‹ˆë‹¤.</div>
                        )}
                        <label>ë‹‰ë„¤ì„</label>
                        <input type="text" value={nickname} onChange={(e) => setNickname(e.target.value)} placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœì´ˆ ì„¤ì • í•„ìˆ˜)" disabled={!canChange && currentNickname} />
                        <button className="btn" onClick={() => onSubmit(nickname)} disabled={(!canChange && currentNickname) || !nickname.trim()} style={{marginTop: '15px'}}>
                            {currentNickname ? 'ë³€ê²½ (ë³€ê²½ê¶Œ 1ê°œ ì‚¬ìš©)' : 'ì„¤ì •í•˜ê³  ì‹œì‘'}
                        </button>
                        {currentNickname && <button className="btn btn-secondary" onClick={onClose}>ì·¨ì†Œ</button>}
                    </div>
                </div>
            );
        }

        function PasswordModal({ onClose, onSubmit }) {
            const [currentPassword, setCurrentPassword] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>
                        <div className="info-box">ğŸ’¡ ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.</div>
                        <label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" value={currentPassword} onChange={(e) => setCurrentPassword(e.target.value)} placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸" />
                        <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" value={newPassword} onChange={(e) => setNewPassword(e.target.value)} placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (8ì ì´ìƒ)" />
                        <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <input type="password" value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸" />
                        <button className="btn" onClick={() => onSubmit(currentPassword, newPassword, confirmPassword)} style={{marginTop: '15px'}}>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                        <button className="btn btn-secondary" onClick={onClose}>ì·¨ì†Œ</button>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
