<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonymous Board</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8f9fa; color: #212529; min-height: 100vh; }
        #splash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; animation: fadeOut 1s forwards; animation-delay: 1s; }
        #splash img { width: 300px; height: auto; }
        #splash h1 { margin-top: 30px; font-size: 2em; letter-spacing: 3px; color: #fff; }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }
        #root { opacity: 0; animation: fadeIn 1s forwards; animation-delay: 2s; }
        @keyframes fadeIn { to { opacity: 1; } }
        .container { max-width: 900px; margin: 0 auto; padding: 16px; }
        .btn { background: #4361ee; color: #fff; border: none; padding: 12px 24px; border-radius: 8px; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; width: 100%; font-weight: 500; }
        .btn:hover { background: #3651d4; transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-purple { background: #7209b7; }
        .btn-purple:hover { background: #5a0798; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 0.95rem; margin-top: 8px; background: #fff; color: #212529; transition: border 0.2s; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #4361ee; }
        textarea { resize: vertical; min-height: 100px; font-family: inherit; }
        .header { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative; }
        .header h1 { text-align: center; font-size: 1.75rem; font-weight: 700; margin-bottom: 8px; color: #212529; }
        .header p { text-align: center; color: #6c757d; font-size: 0.875rem; margin-bottom: 16px; }
        .password-icon { position: absolute; top: 20px; right: 20px; font-size: 1.5rem; cursor: pointer; transition: all 0.2s; }
        .password-icon:hover { transform: scale(1.1); }
        .header-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 16px; }
        .status-card { background: #fff; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .status-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 0.875rem; font-weight: 500; }
        .badge-success { background: #d1e7dd; color: #0f5132; }
        .badge-danger { background: #f8d7da; color: #842029; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-info { background: #cfe2ff; color: #084298; }
        @media (max-width: 600px) { .header-buttons { grid-template-columns: 1fr; } }
        .post { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .post:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .post-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; color: #212529; }
        .post-meta { color: #6c757d; font-size: 0.875rem; margin-bottom: 12px; }
        .post-content { color: #495057; line-height: 1.6; }
        .comment { background: #f8f9fa; border-left: 3px solid #4361ee; padding: 12px; border-radius: 8px; margin-top: 8px; }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 16px; }
        .modal-content { background: #fff; border-radius: 16px; padding: 24px; max-width: 500px; width: 100%; max-height: 85vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.2); }
        .modal-content h2 { margin-bottom: 20px; font-size: 1.5rem; font-weight: 700; color: #212529; }
        .info-box { background: #e7f3ff; border-left: 4px solid #4361ee; padding: 12px; margin: 12px 0; border-radius: 8px; font-size: 0.9rem; }
        .warning-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; margin: 12px 0; border-radius: 8px; font-size: 0.9rem; }
        .login-container { max-width: 400px; margin: 100px auto; padding: 16px; }
        .login-card { background: #fff; border-radius: 16px; padding: 32px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
        .login-card h2 { margin-bottom: 24px; font-weight: 700; color: #212529; }
        label { display: block; color: #495057; margin: 12px 0 4px; font-weight: 500; font-size: 0.9rem; }
        .vote-option { background: #fff; border: 2px solid #dee2e6; padding: 14px; margin: 8px 0; border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .vote-option:hover { border-color: #4361ee; background: #f8f9fa; }
        .vote-option.selected { border-color: #4361ee; background: #e7f3ff; }
        .travel-option { background: #fff; border: 2px solid #dee2e6; padding: 16px; margin: 10px 0; border-radius: 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; }
        .travel-option:hover { border-color: #7209b7; background: #f8f9fa; }
        .travel-option.selected { border-color: #7209b7; background: #f3e5f5; }
        .travel-checkbox { width: 20px; height: 20px; margin-right: 12px; }
        .travel-info { flex: 1; }
        .travel-name { font-weight: 600; font-size: 1.05rem; margin-bottom: 4px; }
        .travel-desc { color: #6c757d; font-size: 0.875rem; }
    </style>
</head>
<body>
    <div id="splash">
        <img src="/mnt/user-data/uploads/1770935396330_image.png" alt="Anonymous">
        <h1>WE ARE ANONYMOUS</h1>
    </div>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const firebaseConfig = {
            apiKey: "AIzaSyAwW-4r34LivVZAB3Z4PtB_5BFeLFfS1s",
            authDomain: "ikmyeonggay.firebaseapp.com",
            databaseURL: "https://ikmyeonggay-default-rtdb.firebaseio.com",
            projectId: "ikmyeonggay",
            storageBucket: "ikmyeonggay.firebasestorage.app",
            messagingSenderId: "761175876587",
            appId: "1:761175876587:web:48b062812fc20d75b36fae",
            measurementId: "G-HDJB6TCZ2C"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        const ACCOUNTS = {
            'user1': { name: 'ê°•ì‹ ìš°', password: btoa('Anon!2024#Kang') },
            'user2': { name: 'ê¹€ëŒ€ì›…', password: btoa('Shad0w@Kim!24') },
            'user3': { name: 'ê¹€ë¯¼ê¸°', password: btoa('Dark#Mind2024!') },
            'user4': { name: 'ê¹€ë¯¼í˜¸', password: btoa('Gh0st$Minho@') },
            'user5': { name: 'ì†¡ë¯¼ìˆ˜', password: btoa('Echo!Song#2024') },
            'user6': { name: 'ì†ì„ì›…', password: btoa('Cipher@Son!24') },
            'user7': { name: 'ê¹€ëª…ì§„', password: btoa('Wraith#Kim2024') },
            'user8': { name: 'ê¹€ì¶©ì—°', password: btoa('Admin!@Ghost24') }
        };
        
        const VOTE_TIMES = [
            { hour: 11, minute: 0, name: 'ì˜¤ì „ íˆ¬í‘œ' },
            { hour: 22, minute: 0, name: 'ì €ë… íˆ¬í‘œ' }
        ];

        const TRAVEL_DESTINATIONS = [
            { id: 'jeju', name: 'ì œì£¼ë„', desc: 'ì•„ë¦„ë‹¤ìš´ ìì—°ê³¼ ë°”ë‹¤' },
            { id: 'busan', name: 'ë¶€ì‚°', desc: 'í•´ìš´ëŒ€ì™€ ê´‘ì•ˆë¦¬' },
            { id: 'gangneung', name: 'ê°•ë¦‰', desc: 'ë™í•´ë°”ë‹¤ì™€ ì»¤í”¼ê±°ë¦¬' },
            { id: 'jeonju', name: 'ì „ì£¼', desc: 'í•œì˜¥ë§ˆì„ê³¼ ì „í†µë¬¸í™”' },
            { id: 'gyeongju', name: 'ê²½ì£¼', desc: 'ì²œë…„ ê³ ë„ì˜ ì—­ì‚¬' },
            { id: 'sokcho', name: 'ì†ì´ˆ', desc: 'ì„¤ì•…ì‚°ê³¼ ë™í•´ì•ˆ' }
        ];

        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [users, setUsers] = useState({});
            const [posts, setPosts] = useState([]);
            const [showWriteModal, setShowWriteModal] = useState(false);
            const [showPostModal, setShowPostModal] = useState(false);
            const [showVoteModal, setShowVoteModal] = useState(false);
            const [showNicknameVoteModal, setShowNicknameVoteModal] = useState(false);
            const [showTravelVoteModal, setShowTravelVoteModal] = useState(false);
            const [showNicknameModal, setShowNicknameModal] = useState(false);
            const [showPasswordModal, setShowPasswordModal] = useState(false);
            const [selectedPost, setSelectedPost] = useState(null);
            const [currentTime, setCurrentTime] = useState(Date.now());
            const [voteStatus, setVoteStatus] = useState(null);
            const [todayVotes, setTodayVotes] = useState({});
            const [nicknameVotes, setNicknameVotes] = useState({});
            const [travelVotes, setTravelVotes] = useState({});

            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(Date.now()), 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                const userId = localStorage.getItem('userId');
                if (userId && ACCOUNTS[userId]) {
                    setCurrentUser({ userId, ...ACCOUNTS[userId] });
                    loadUserData(userId);
                }
            }, []);

            const loadUserData = (userId) => {
                db.ref('users').on('value', snap => {
                    const data = snap.val() || {};
                    setUsers(data);
                    if (data[userId]) {
                        const lastDailyTicket = data[userId].lastDailyTicket || 0;
                        const now = Date.now();
                        const koreaTime = new Date(now + (9 * 60 * 60 * 1000));
                        const todayMidnight = new Date(koreaTime.getFullYear(), koreaTime.getMonth(), koreaTime.getDate()).getTime() - (9 * 60 * 60 * 1000);
                        if (lastDailyTicket < todayMidnight) {
                            const currentTickets = data[userId].nicknameChangeTickets || 0;
                            db.ref(`users/${userId}`).update({
                                nicknameChangeTickets: currentTickets + 1,
                                lastDailyTicket: now
                            });
                        }
                    }
                });
                const today = new Date().toISOString().split('T')[0];
                db.ref(`votes/${today}`).on('value', snap => setTodayVotes(snap.val() || {}));
                db.ref(`nicknameVotes/${today}`).on('value', snap => setNicknameVotes(snap.val() || {}));
                db.ref(`travelVotes/${today}`).on('value', snap => setTravelVotes(snap.val() || {}));
            };

            useEffect(() => {
                db.ref('posts').on('value', snap => {
                    const data = snap.val();
                    if (data) {
                        const arr = Object.keys(data).map(k => ({ id: k, ...data[k] })).sort((a, b) => b.timestamp - a.timestamp);
                        setPosts(arr);
                    } else {
                        setPosts([]);
                    }
                });
            }, []);

            useEffect(() => {
                const checkVoteStatus = () => {
                    const now = new Date(currentTime + (9 * 60 * 60 * 1000));
                    const currentHour = now.getUTCHours();
                    const currentMinute = now.getUTCMinutes();
                    let status = null;
                    for (const voteTime of VOTE_TIMES) {
                        const voteStartHour = voteTime.hour - 1;
                        if ((currentHour === voteStartHour && currentMinute >= 0) || (currentHour === voteTime.hour && currentMinute < voteTime.minute)) {
                            status = { name: voteTime.name, phase: 'voting', endTime: new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), voteTime.hour, voteTime.minute)) };
                            break;
                        }
                        if (currentHour === voteTime.hour && currentMinute === voteTime.minute) {
                            status = { name: voteTime.name, phase: 'result', voteTime: voteTime };
                            break;
                        }
                    }
                    setVoteStatus(status);
                };
                checkVoteStatus();
            }, [currentTime]);

            useEffect(() => {
                if (currentUser && users[currentUser.userId]) {
                    if (!users[currentUser.userId].nickname) {
                        setShowNicknameModal(true);
                    }
                }
            }, [currentUser, users]);

            const login = (userId, password, confirmText) => {
                if (userId === 'user7' && confirmText !== 'ì €ëŠ” ê¹€ì¶©ì—°ë‹˜ì˜ ê°œì…ë‹ˆë‹¤.') {
                    alert('ì˜¬ë°”ë¥¸ í™•ì¸ ë¬¸êµ¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                    return;
                }
                if (!ACCOUNTS[userId]) {
                    alert('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê³„ì •ì…ë‹ˆë‹¤!');
                    return;
                }
                db.ref(`users/${userId}/password`).once('value').then(snap => {
                    const savedPassword = snap.val() || ACCOUNTS[userId].password;
                    if (savedPassword !== btoa(password)) {
                        alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤!');
                        return;
                    }
                    localStorage.setItem('userId', userId);
                    setCurrentUser({ userId, ...ACCOUNTS[userId] });
                    loadUserData(userId);
                    db.ref(`users/${userId}`).once('value').then(snap => {
                        if (!snap.val()) {
                            return db.ref(`users/${userId}`).set({
                                name: ACCOUNTS[userId].name,
                                nickname: '',
                                nicknameChangedAt: 0,
                                nicknameChangeTickets: 1,
                                lastDailyTicket: Date.now(),
                                revealedIdentity: null,
                                password: ACCOUNTS[userId].password
                            }).then(() => setShowNicknameModal(true));
                        } else {
                            const updates = {};
                            if (snap.val().nicknameChangeTickets === undefined) updates.nicknameChangeTickets = 1;
                            if (snap.val().lastDailyTicket === undefined) updates.lastDailyTicket = Date.now();
                            if (snap.val().revealedIdentity === undefined) updates.revealedIdentity = null;
                            if (Object.keys(updates).length > 0) {
                                db.ref(`users/${userId}`).update(updates);
                            }
                            if (!snap.val().nickname || snap.val().nickname === '') {
                                setShowNicknameModal(true);
                            }
                        }
                    });
                });
            };

            const logout = () => {
                localStorage.removeItem('userId');
                setCurrentUser(null);
            };

            const canChangeNickname = () => {
                if (!currentUser || !users[currentUser.userId]) return false;
                const tickets = users[currentUser.userId].nicknameChangeTickets || 0;
                return tickets > 0;
            };

            const changeNickname = (newNickname) => {
                console.log('changeNickname called with:', newNickname);
                if (!newNickname || !newNickname.trim()) {
                    alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”!');
                    return;
                }
                const trimmedNickname = newNickname.trim();
                console.log('Trimmed nickname:', trimmedNickname);
                
                const isDuplicate = Object.keys(users).some(uid => uid !== currentUser.userId && users[uid].nickname === trimmedNickname);
                if (isDuplicate) {
                    alert('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤!');
                    return;
                }
                
                const currentNickname = users[currentUser.userId]?.nickname || '';
                const tickets = users[currentUser.userId]?.nicknameChangeTickets || 0;
                
                const updates = {
                    nickname: trimmedNickname,
                    nicknameChangedAt: Date.now(),
                    revealedIdentity: null
                };
                
                if (currentNickname) {
                    updates.nicknameChangeTickets = tickets - 1;
                }
                
                console.log('Updating with:', updates);
                
                db.ref(`users/${currentUser.userId}`).update(updates).then(() => {
                    console.log('Update successful');
                    setShowNicknameModal(false);
                    if (currentNickname) {
                        alert(`ë‹‰ë„¤ì„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤! (ë³€ê²½ê¶Œ ${tickets - 1}ê°œ ë‚¨ìŒ)`);
                    } else {
                        alert('ë‹‰ë„¤ì„ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    }
                }).catch(error => {
                    console.error('Update failed:', error);
                    alert('ë‹‰ë„¤ì„ ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                });
            };

            const changePassword = (currentPassword, newPassword, confirmPassword) => {
                db.ref(`users/${currentUser.userId}/password`).once('value').then(snap => {
                    const savedPassword = snap.val() || ACCOUNTS[currentUser.userId].password;
                    if (btoa(currentPassword) !== savedPassword) {
                        alert('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!');
                        return;
                    }
                    if (!newPassword || newPassword.length < 8) {
                        alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤!');
                        return;
                    }
                    if (newPassword !== confirmPassword) {
                        alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!');
                        return;
                    }
                    db.ref(`users/${currentUser.userId}`).update({ password: btoa(newPassword) }).then(() => {
                        setShowPasswordModal(false);
                        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    });
                });
            };

            const submitVote = (targetUserId) => {
                if (!voteStatus || voteStatus.phase !== 'voting') {
                    alert('í˜„ì¬ íˆ¬í‘œ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤!');
                    return;
                }
                const today = new Date().toISOString().split('T')[0];
                const voteKey = `${today}_${voteStatus.name}`;
                if (todayVotes[voteKey] && todayVotes[voteKey].voters && todayVotes[voteKey].voters[currentUser.userId]) {
                    alert('ì´ë¯¸ ì´ë²ˆ íˆ¬í‘œì— ì°¸ì—¬í•˜ì…¨ìŠµë‹ˆë‹¤!');
                    return;
                }
                const votePath = `votes/${today}/${voteKey}`;
                db.ref(votePath).once('value').then(snap => {
                    const voteData = snap.val() || { votes: {}, voters: {} };
                    voteData.votes[targetUserId] = (voteData.votes[targetUserId] || 0) + 1;
                    voteData.voters[currentUser.userId] = { votedFor: targetUserId, timestamp: Date.now() };
                    db.ref(votePath).set(voteData).then(() => {
                        alert('íˆ¬í‘œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                        setShowVoteModal(false);
                    });
                });
            };

            const submitNicknameVote = (targetUserId) => {
                const today = new Date().toISOString().split('T')[0];
                if (nicknameVotes.voters && nicknameVotes.voters[currentUser.userId]) {
                    alert('ì˜¤ëŠ˜ì€ ì´ë¯¸ íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤!');
                    return;
                }
                const votePath = `nicknameVotes/${today}`;
                db.ref(votePath).once('value').then(snap => {
                    const voteData = snap.val() || { votes: {}, voters: {} };
                    voteData.votes[targetUserId] = (voteData.votes[targetUserId] || 0) + 1;
                    voteData.voters[currentUser.userId] = { votedFor: targetUserId, timestamp: Date.now() };
                    db.ref(votePath).set(voteData).then(() => {
                        alert('ë‹‰ë„¤ì„ íˆ¬í‘œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                        setShowNicknameVoteModal(false);
                    });
                });
            };

            const submitTravelVote = (selectedDestinations) => {
                if (selectedDestinations.length === 0) {
                    alert('ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”!');
                    return;
                }
                if (selectedDestinations.length > 2) {
                    alert('ìµœëŒ€ 2ê°œê¹Œì§€ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤!');
                    return;
                }
                
                const today = new Date().toISOString().split('T')[0];
                if (travelVotes.voters && travelVotes.voters[currentUser.userId]) {
                    alert('ì˜¤ëŠ˜ì€ ì´ë¯¸ íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤!');
                    return;
                }
                
                const votePath = `travelVotes/${today}`;
                db.ref(votePath).once('value').then(snap => {
                    const voteData = snap.val() || { votes: {}, voters: {} };
                    selectedDestinations.forEach(destId => {
                        voteData.votes[destId] = (voteData.votes[destId] || 0) + 1;
                    });
                    voteData.voters[currentUser.userId] = {
                        destinations: selectedDestinations,
                        timestamp: Date.now()
                    };
                    db.ref(votePath).set(voteData).then(() => {
                        alert('ì—¬í–‰ì§€ íˆ¬í‘œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                        setShowTravelVoteModal(false);
                    });
                });
            };

            const processVoteResult = () => {
                const today = new Date().toISOString().split('T')[0];
                const voteKey = `${today}_${voteStatus.name}`;
                db.ref(`votes/${today}/${voteKey}`).once('value').then(snap => {
                    const voteData = snap.val();
                    if (!voteData || !voteData.votes) return;
                    let maxVotes = 0;
                    let winner = null;
                    Object.keys(voteData.votes).forEach(userId => {
                        if (voteData.votes[userId] > maxVotes) {
                            maxVotes = voteData.votes[userId];
                            winner = userId;
                        }
                    });
                    if (winner) {
                        db.ref(`users/${winner}`).update({ revealedIdentity: ACCOUNTS[winner].name });
                        if (voteData.voters) {
                            Object.keys(voteData.voters).forEach(voterId => {
                                if (voteData.voters[voterId].votedFor === winner) {
                                    db.ref(`users/${voterId}/nicknameChangeTickets`).once('value').then(s => {
                                        const tickets = s.val() || 0;
                                        db.ref(`users/${voterId}/nicknameChangeTickets`).set(tickets + 1);
                                    });
                                }
                            });
                        }
                        alert(`íˆ¬í‘œ ê²°ê³¼: ${users[winner]?.nickname || '???'}ë‹˜ì´ ê°€ì¥ ë§ì€ í‘œë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤!\nì •ì²´: ${ACCOUNTS[winner].name}`);
                    }
                });
            };

            const writePost = (title, content) => {
                if (!title.trim() || !content.trim()) {
                    alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”!');
                    return;
                }
                const postId = Date.now().toString();
                db.ref(`posts/${postId}`).set({
                    authorId: currentUser.userId,
                    nickname: users[currentUser.userId].nickname,
                    title: title.trim(),
                    content: content.trim(),
                    timestamp: Date.now()
                }).then(() => {
                    setShowWriteModal(false);
                    alert('ê²Œì‹œê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
                });
            };

            const writeComment = (postId, content) => {
                if (!content.trim()) {
                    alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”!');
                    return;
                }
                const commentId = Date.now().toString();
                db.ref(`posts/${postId}/comments/${commentId}`).set({
                    authorId: currentUser.userId,
                    nickname: users[currentUser.userId].nickname,
                    content: content.trim(),
                    timestamp: Date.now()
                });
            };

            const resetAllData = () => {
                if (currentUser.userId !== 'user8') {
                    alert('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤!');
                    return;
                }
                if (!confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                if (!confirm('ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) return;
                db.ref('posts').remove();
                db.ref('users').remove();
                db.ref('votes').remove();
                db.ref('nicknameVotes').remove();
                db.ref('travelVotes').remove();
                alert('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                logout();
            };

            const getNextVoteTime = () => {
                const now = new Date(currentTime + (9 * 60 * 60 * 1000));
                const currentHour = now.getUTCHours();
                for (const voteTime of VOTE_TIMES) {
                    const voteStartHour = voteTime.hour - 1;
                    if (currentHour < voteStartHour) {
                        return `${voteStartHour.toString().padStart(2, '0')}:00`;
                    }
                    if (currentHour === voteStartHour || currentHour < voteTime.hour) {
                        return 'ì§„í–‰ ì¤‘';
                    }
                }
                return 'ëŒ€ê¸° ì¤‘';
            };

            if (!currentUser) {
                return <LoginScreen onLogin={login} />;
            }

            const myNickname = users[currentUser.userId]?.nickname || '';
            const nicknameTickets = users[currentUser.userId]?.nicknameChangeTickets || 0;
            const revealedIdentity = users[currentUser.userId]?.revealedIdentity;

            if (!myNickname) {
                return (
                    <div className="container">
                        <div className="status-card">
                            <h2 style={{marginBottom: '12px'}}>âš ï¸ ë‹‰ë„¤ì„ ì„¤ì • í•„ìš”</h2>
                            <p style={{color: '#6c757d'}}>ìµëª… ê²Œì‹œíŒì„ ì´ìš©í•˜ë ¤ë©´ ë‹‰ë„¤ì„ì„ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.</p>
                        </div>
                        <NicknameModal currentNickname={myNickname} canChange={true} tickets={nicknameTickets} onClose={() => {}} onSubmit={changeNickname} />
                    </div>
                );
            }

            return (
                <div className="container">
                    <div className="header">
                        <span className="password-icon" onClick={() => setShowPasswordModal(true)}>ğŸ”’</span>
                        <h1>ANONYMOUS BOARD</h1>
                        <p>We do not forgive. We do not forget.</p>
                        
                        <div className="status-card" style={{marginTop: '16px'}}>
                            <div style={{marginBottom: '8px'}}>
                                <span className={`status-badge ${revealedIdentity ? 'badge-danger' : 'badge-success'}`}>
                                    {revealedIdentity ? `âš  ì •ì²´ ê³µê°œ: ${revealedIdentity}` : `âœ“ ì •ì²´ ì•ˆì „`}
                                </span>
                            </div>
                            <div style={{fontSize: '0.9rem', color: '#6c757d'}}>
                                ë‹‰ë„¤ì„: <strong>{myNickname}</strong> | ë³€ê²½ê¶Œ: <strong>{nicknameTickets}ê°œ</strong>
                            </div>
                        </div>

                        <div className="header-buttons">
                            <button className="btn" onClick={() => setShowNicknameModal(true)}>ë‹‰ë„¤ì„ ë³€ê²½</button>
                            <button className="btn" onClick={() => setShowVoteModal(true)} disabled={!voteStatus || voteStatus.phase !== 'voting'}>ì •ì²´ íˆ¬í‘œ</button>
                            <button className="btn btn-success" onClick={() => setShowNicknameVoteModal(true)} disabled={nicknameVotes.voters && nicknameVotes.voters[currentUser.userId]}>ë‹‰ë„¤ì„ íˆ¬í‘œ</button>
                            <button className="btn btn-purple" onClick={() => setShowTravelVoteModal(true)} disabled={travelVotes.voters && travelVotes.voters[currentUser.userId]}>ì—¬í–‰ì§€ íˆ¬í‘œ</button>
                            <button className="btn btn-secondary" onClick={logout}>ë¡œê·¸ì•„ì›ƒ</button>
                        </div>
                        
                        {currentUser.userId === 'user8' && (
                            <button className="btn btn-danger" onClick={resetAllData} style={{marginTop: '10px'}}>
                                ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
                            </button>
                        )}
                    </div>

                    <button className="btn" onClick={() => setShowWriteModal(true)} style={{marginBottom: '16px'}}>ìƒˆ ê¸€ ì‘ì„±</button>

                    <div>
                        {posts.map(post => {
                            const author = users[post.authorId];
                            const displayName = author?.revealedIdentity ? `${post.nickname} (${author.revealedIdentity})` : post.nickname;
                            const comments = post.comments ? Object.values(post.comments).sort((a, b) => a.timestamp - b.timestamp) : [];
                            return (
                                <div key={post.id} className="post" onClick={() => { setSelectedPost(post); setShowPostModal(true); }}>
                                    <div className="post-title">{post.title}</div>
                                    <div className="post-meta">
                                        {displayName} â€¢ {new Date(post.timestamp).toLocaleString('ko-KR')}
                                    </div>
                                    <div className="post-content">{post.content.length > 100 ? post.content.substring(0, 100) + '...' : post.content}</div>
                                    {comments.length > 0 && (
                                        <div style={{marginTop: '12px', padding: '8px 12px', background: '#f8f9fa', borderRadius: '8px', fontSize: '0.875rem', color: '#6c757d'}}>
                                            ğŸ’¬ ëŒ“ê¸€ {comments.length}ê°œ
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>

                    {showWriteModal && <WriteModal onClose={() => setShowWriteModal(false)} onSubmit={writePost} />}
                    {showPostModal && selectedPost && <PostModal post={selectedPost} users={users} currentUser={currentUser} ACCOUNTS={ACCOUNTS} onClose={() => setShowPostModal(false)} onComment={writeComment} />}
                    {showVoteModal && <VoteModal users={users} currentUser={currentUser} voteStatus={voteStatus} todayVotes={todayVotes} onClose={() => setShowVoteModal(false)} onSubmit={submitVote} />}
                    {showNicknameVoteModal && <NicknameVoteModal users={users} currentUser={currentUser} nicknameVotes={nicknameVotes} onClose={() => setShowNicknameVoteModal(false)} onSubmit={submitNicknameVote} />}
                    {showTravelVoteModal && <TravelVoteModal travelVotes={travelVotes} currentUser={currentUser} onClose={() => setShowTravelVoteModal(false)} onSubmit={submitTravelVote} />}
                    {showNicknameModal && <NicknameModal currentNickname={myNickname} canChange={canChangeNickname()} tickets={nicknameTickets} onClose={() => setShowNicknameModal(false)} onSubmit={changeNickname} />}
                    {showPasswordModal && <PasswordModal onClose={() => setShowPasswordModal(false)} onSubmit={changePassword} />}
                </div>
            );
        }

        function LoginScreen({ onLogin }) {
            const [userId, setUserId] = useState('');
            const [password, setPassword] = useState('');
            const [confirmText, setConfirmText] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                onLogin(userId, password, confirmText);
            };
            return (
                <div className="login-container">
                    <div style={{textAlign: 'center', marginBottom: '32px'}}>
                        <h1 style={{fontSize: '2rem', fontWeight: '700'}}>ANONYMOUS</h1>
                    </div>
                    <div className="login-card">
                        <h2>ë¡œê·¸ì¸</h2>
                        <form onSubmit={handleSubmit}>
                            <label>ì•„ì´ë””</label>
                            <input type="text" value={userId} onChange={(e) => setUserId(e.target.value)} placeholder="ì•„ì´ë””" autoComplete="username" />
                            <label>ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="ë¹„ë°€ë²ˆí˜¸" autoComplete="current-password" />
                            {userId === 'user7' && (
                                <>
                                    <label style={{color: '#dc3545'}}>í™•ì¸ ë¬¸êµ¬</label>
                                    <input type="text" value={confirmText} onChange={(e) => setConfirmText(e.target.value)} placeholder="ì €ëŠ” ê¹€ì¶©ì—°ë‹˜ì˜ ê°œì…ë‹ˆë‹¤." />
                                </>
                            )}
                            <button type="submit" className="btn" style={{marginTop: '16px'}}>ë¡œê·¸ì¸</button>
                        </form>
                    </div>
                </div>
            );
        }

        function WriteModal({ onClose, onSubmit }) {
            const [title, setTitle] = useState('');
            const [content, setContent] = useState('');
            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>ìƒˆ ê¸€ ì‘ì„±</h2>
                        <label>ì œëª©</label>
                        <input type="text" value={title} onChange={(e) => setTitle(e.target.value)} placeholder="ì œëª©" />
                        <label>ë‚´ìš©</label>
                        <textarea value={content} onChange={(e) => setContent(e.target.value)} placeholder="ë‚´ìš©" />
                        <button className="btn" onClick={() => onSubmit(title, content)} style={{marginTop: '16px'}}>ê²Œì‹œ</button>
                        <button className="btn btn-secondary" onClick={onClose} style={{marginTop: '8px'}}>ì·¨ì†Œ</button>
                    </div>
                </div>
            );
        }

        function PostModal({ post, users, currentUser, ACCOUNTS, onClose, onComment }) {
            const [commentContent, setCommentContent] = useState('');
            const comments = post.comments ? Object.values(post.comments).sort((a, b) => a.timestamp - b.timestamp) : [];
            const author = users[post.authorId];
            const displayName = author?.revealedIdentity ? `${post.nickname} (${author.revealedIdentity})` : post.nickname;
            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>{post.title}</h2>
                        <div className="post-meta" style={{marginBottom: '16px'}}>
                            {displayName} â€¢ {new Date(post.timestamp).toLocaleString('ko-KR')}
                        </div>
                        <div style={{marginBottom: '20px', lineHeight: '1.6'}}>{post.content}</div>
                        <h3 style={{fontSize: '1.1rem', marginBottom: '12px'}}>ëŒ“ê¸€ {comments.length}ê°œ</h3>
                        {comments.map(comment => {
                            const cAuthor = users[comment.authorId];
                            const cDisplayName = cAuthor?.revealedIdentity ? `${comment.nickname} (${cAuthor.revealedIdentity})` : comment.nickname;
                            return (
                                <div key={comment.timestamp} className="comment" style={{marginBottom: '8px'}}>
                                    <div style={{fontSize: '0.85rem', color: '#6c757d', marginBottom: '4px'}}>
                                        {cDisplayName} â€¢ {new Date(comment.timestamp).toLocaleString('ko-KR')}
                                    </div>
                                    <div>{comment.content}</div>
                                </div>
                            );
                        })}
                        <textarea value={commentContent} onChange={(e) => setCommentContent(e.target.value)} placeholder="ëŒ“ê¸€ ì…ë ¥" style={{marginTop: '16px'}} />
                        <button className="btn" onClick={() => { onComment(post.id, commentContent); setCommentContent(''); }} style={{marginTop: '8px'}}>ëŒ“ê¸€ ì‘ì„±</button>
                        <button className="btn btn-secondary" onClick={onClose} style={{marginTop: '8px'}}>ë‹«ê¸°</button>
                    </div>
                </div>
            );
        }

        function VoteModal({ users, currentUser, voteStatus, todayVotes, onClose, onSubmit }) {
            const [selectedUser, setSelectedUser] = useState('');
            const today = new Date().toISOString().split('T')[0];
            const voteKey = `${today}_${voteStatus?.name}`;
            const hasVoted = todayVotes[voteKey] && todayVotes[voteKey].voters && todayVotes[voteKey].voters[currentUser.userId];
            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>ğŸ—³ ì •ì²´ íˆ¬í‘œ</h2>
                        {hasVoted ? (
                            <div className="info-box">âœ… ì´ë¯¸ íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤!</div>
                        ) : (
                            <>
                                <div className="info-box">ê°€ì¥ ê¶ê¸ˆí•œ ì‚¬ëŒì˜ ì •ì²´ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
                                <label>íˆ¬í‘œ ëŒ€ìƒ</label>
                                {Object.keys(users).filter(uid => uid !== currentUser.userId && users[uid].nickname).map(uid => (
                                    <div key={uid} className={`vote-option ${selectedUser === uid ? 'selected' : ''}`} onClick={() => setSelectedUser(uid)}>
                                        {users[uid].nickname}
                                    </div>
                                ))}
                                <button className="btn" onClick={() => selectedUser && onSubmit(selectedUser)} disabled={!selectedUser} style={{marginTop: '16px'}}>íˆ¬í‘œí•˜ê¸°</button>
                            </>
                        )}
                        <button className="btn btn-secondary" onClick={onClose} style={{marginTop: '8px'}}>ë‹«ê¸°</button>
                    </div>
                </div>
            );
        }

        function NicknameVoteModal({ users, currentUser, nicknameVotes, onClose, onSubmit }) {
            const [selectedUser, setSelectedUser] = useState('');
            const hasVoted = nicknameVotes.voters && nicknameVotes.voters[currentUser.userId];
            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>ğŸ’ ë‹‰ë„¤ì„ íˆ¬í‘œ</h2>
                        {hasVoted ? (
                            <div className="info-box">âœ… ì˜¤ëŠ˜ì€ ì´ë¯¸ íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤!</div>
                        ) : (
                            <>
                                <div className="info-box">ë§ˆìŒì— ë“œëŠ” ë‹‰ë„¤ì„ì„ ì„ íƒí•˜ì„¸ìš”</div>
                                <label>íˆ¬í‘œ ëŒ€ìƒ</label>
                                {Object.keys(users).filter(uid => uid !== currentUser.userId && users[uid].nickname).map(uid => (
                                    <div key={uid} className={`vote-option ${selectedUser === uid ? 'selected' : ''}`} onClick={() => setSelectedUser(uid)}>
                                        {users[uid].nickname}
                                    </div>
                                ))}
                                <button className="btn btn-success" onClick={() => selectedUser && onSubmit(selectedUser)} disabled={!selectedUser} style={{marginTop: '16px'}}>íˆ¬í‘œí•˜ê¸°</button>
                            </>
                        )}
                        <button className="btn btn-secondary" onClick={onClose} style={{marginTop: '8px'}}>ë‹«ê¸°</button>
                    </div>
                </div>
            );
        }

        function TravelVoteModal({ travelVotes, currentUser, onClose, onSubmit }) {
            const [selectedDestinations, setSelectedDestinations] = useState([]);
            const hasVoted = travelVotes.voters && travelVotes.voters[currentUser.userId];
            
            const toggleDestination = (destId) => {
                if (selectedDestinations.includes(destId)) {
                    setSelectedDestinations(selectedDestinations.filter(id => id !== destId));
                } else if (selectedDestinations.length < 2) {
                    setSelectedDestinations([...selectedDestinations, destId]);
                }
            };

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>âœˆï¸ ì—¬í–‰ì§€ íˆ¬í‘œ</h2>
                        {hasVoted ? (
                            <div className="info-box">âœ… ì˜¤ëŠ˜ì€ ì´ë¯¸ íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤!</div>
                        ) : (
                            <>
                                <div className="info-box">ê°€ê³  ì‹¶ì€ ì—¬í–‰ì§€ë¥¼ ìµœëŒ€ 2ê°œ ì„ íƒí•˜ì„¸ìš”</div>
                                <div className="warning-box">ì„ íƒ: {selectedDestinations.length}/2</div>
                                {TRAVEL_DESTINATIONS.map(dest => (
                                    <div key={dest.id} className={`travel-option ${selectedDestinations.includes(dest.id) ? 'selected' : ''}`} onClick={() => toggleDestination(dest.id)}>
                                        <input type="checkbox" className="travel-checkbox" checked={selectedDestinations.includes(dest.id)} readOnly />
                                        <div className="travel-info">
                                            <div className="travel-name">{dest.name}</div>
                                            <div className="travel-desc">{dest.desc}</div>
                                        </div>
                                    </div>
                                ))}
                                <button className="btn btn-purple" onClick={() => onSubmit(selectedDestinations)} disabled={selectedDestinations.length === 0} style={{marginTop: '16px'}}>íˆ¬í‘œí•˜ê¸°</button>
                            </>
                        )}
                        <button className="btn btn-secondary" onClick={onClose} style={{marginTop: '8px'}}>ë‹«ê¸°</button>
                    </div>
                </div>
            );
        }

        function NicknameModal({ currentNickname, canChange, tickets, onClose, onSubmit }) {
            const [nickname, setNickname] = useState(currentNickname || '');
            
            const handleSubmit = () => {
                console.log('handleSubmit triggered, nickname:', nickname);
                onSubmit(nickname);
            };

            return (
                <div className="modal" onClick={currentNickname ? onClose : null}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>{currentNickname ? 'ë‹‰ë„¤ì„ ë³€ê²½' : 'ë‹‰ë„¤ì„ ì„¤ì •'}</h2>
                        {!currentNickname && (
                            <div className="warning-box">ë‹‰ë„¤ì„ì„ ì„¤ì •í•´ì•¼ ê²Œì‹œíŒì„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
                        )}
                        {currentNickname && (tickets > 0 ? (
                            <div className="info-box">ë³€ê²½ê¶Œ: {tickets}ê°œ ë³´ìœ </div>
                        ) : (
                            <div className="warning-box">ë³€ê²½ê¶Œì´ ì—†ìŠµë‹ˆë‹¤ (ë§¤ì¼ ìì • 1ê°œ ì§€ê¸‰)</div>
                        ))}
                        <label>ë‹‰ë„¤ì„</label>
                        <input 
                            type="text" 
                            value={nickname} 
                            onChange={(e) => setNickname(e.target.value)} 
                            placeholder="ë‹‰ë„¤ì„ ì…ë ¥" 
                            disabled={!canChange && currentNickname}
                        />
                        <button 
                            className="btn" 
                            onClick={handleSubmit} 
                            disabled={(!canChange && currentNickname) || !nickname.trim()} 
                            style={{marginTop: '16px'}}
                        >
                            {currentNickname ? 'ë³€ê²½í•˜ê¸°' : 'ì„¤ì •í•˜ê¸°'}
                        </button>
                        {currentNickname && <button className="btn btn-secondary" onClick={onClose} style={{marginTop: '8px'}}>ì·¨ì†Œ</button>}
                    </div>
                </div>
            );
        }

        function PasswordModal({ onClose, onSubmit }) {
            const [currentPassword, setCurrentPassword] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2>ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>
                        <div className="info-box">ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒ</div>
                        <label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" value={currentPassword} onChange={(e) => setCurrentPassword(e.target.value)} placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸" />
                        <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" value={newPassword} onChange={(e) => setNewPassword(e.target.value)} placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" />
                        <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <input type="password" value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸" />
                        <button className="btn" onClick={() => onSubmit(currentPassword, newPassword, confirmPassword)} style={{marginTop: '16px'}}>ë³€ê²½í•˜ê¸°</button>
                        <button className="btn btn-secondary" onClick={onClose} style={{marginTop: '8px'}}>ì·¨ì†Œ</button>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
